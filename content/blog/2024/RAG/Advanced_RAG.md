---
title: "Advanced-RAG: RAGè¿›é˜¶ä½¿ç”¨æŠ€å·§"
date: 2024-08-25T18:18:05+08:00
lastmod: 2024-08-27T09:19:06+08:00
draft: false
featured_image: "https://blog-1311257248.cos.ap-nanjing.myqcloud.com/imgs/rag/rag_title.jpg"
description: "RAGåœ¨å·¥ç¨‹ä¸­çš„è¿›é˜¶ä½¿ç”¨æŠ€å·§"
tags:
- RAG
categories:
- NLP
series:
- ã€ŠRAGè¿›é˜¶ã€‹
comment : true
---

# Naive RAG

å‰è¨€ï¼šç›®å‰ä¸‹è¿°çš„ä»£ç éƒ½åŸºäºLangchain 0.1çš„ç‰ˆæœ¬è¿›è¡Œï¼Œç›®å‰Langchainå·²ç»æ›´æ–°åˆ°0.2ï¼Œè¿˜æœ‰åœ¨æ„å»ºRAGåº”ç”¨çš„æ—¶å€™è¿˜æ˜¯ä¸è¦è¿‡åˆ†ä¾èµ–æ¡†æ¶ï¼Œé™ä½çµæ´»æ€§ï¼Œè¿™æœ‰æ—¶å€™ä¼šè®©ä½ çš„å·¥ç¨‹å¼€å‘é™·å…¥è¢«åŠ¨ï¼

é¦–å…ˆå…ˆä»‹ç»ä¸€ä¸‹æœ€ç®€å•çš„RAGçš„æµç¨‹ï¼Œå…¶ä¸»è¦çš„æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![](https://blog-1311257248.cos.ap-nanjing.myqcloud.com/imgs/rag/img7.jpg)

å°†çŸ¥è¯†åº“æ–‡æœ¬æ‹†åˆ†ä¸ºå—ï¼Œç„¶åä½¿ç”¨ä¸€äº›Transformer Encoderæ¨¡å‹å°†è¿™äº›å—åµŒå…¥å‘é‡ä¸­ï¼Œå°†æ‰€æœ‰è¿™äº›å‘é‡æ”¾å…¥ç´¢å¼•ä¸­ï¼Œæœ€åä¸ºLLMåˆ›å»ºä¸€ä¸ªæç¤ºï¼Œå‘Šè¯‰æ¨¡å‹æ ¹æ®æˆ‘ä»¬åœ¨æœç´¢æ­¥éª¤ä¸­å‘ç°çš„ä¸Šä¸‹æ–‡ï¼Œå›ç­”ç”¨æˆ·çš„æŸ¥è¯¢ã€‚

åœ¨è¿è¡Œæ—¶ï¼Œæˆ‘ä»¬ä½¿ç”¨ç›¸åŒçš„ç¼–ç å™¨æ¨¡å‹çŸ¢é‡åŒ–ç”¨æˆ·çš„æŸ¥è¯¢ï¼Œç„¶åé’ˆå¯¹ç´¢å¼•æ‰§è¡Œæ­¤æŸ¥è¯¢çŸ¢é‡çš„æœç´¢ï¼Œæ‰¾åˆ°top-kç»“æœï¼Œä»æˆ‘ä»¬çš„æ•°æ®åº“ä¸­æ£€ç´¢ç›¸åº”çš„æ–‡æœ¬å—ï¼Œå¹¶å°†å…¶ä½œä¸ºä¸Šä¸‹æ–‡è¾“å…¥LLMæç¤ºç¬¦ã€‚

ç¤ºä¾‹çš„RAGæç¤ºè¯æ¨¡ç‰ˆå¦‚ä¸‹ï¼š
```python
# è‹±æ–‡æç¤ºè¯
prompt_template = """Give the answer to the user query delimited by triple backticks ```{query}```\
                using the information given in context delimited by triple backticks ```{context}```.\
                If there is no relevant information in the provided context, try to answer yourself, 
                but tell user that you did not have any relevant context to base your answer on.
                Be concise and output the answer of size less than 80 tokens.
"""

# ä¸­æ–‡ç‰ˆæœ¬
prompt_template_zh = """ç»™å‡ºç”±ä¸‰é‡åå¼•å·åˆ†éš”çš„ç”¨æˆ·æŸ¥è¯¢çš„ç­”æ¡ˆ````{query}```\

ä½¿ç”¨ç”±ä¸‰é‡åå¼•å·```{context}```åˆ†éš”çš„ä¸Šä¸‹æ–‡ä¸­ç»™å‡ºçš„ä¿¡æ¯ã€‚\

å¦‚æœæä¾›çš„ä¸Šä¸‹æ–‡ä¸­æ²¡æœ‰ç›¸å…³ä¿¡æ¯ï¼Œè¯·å°è¯•å›ç­”è‡ªå·±ï¼Œ

ä½†å‘Šè¯‰ç”¨æˆ·ï¼Œæ‚¨æ²¡æœ‰ä»»ä½•ç›¸å…³ä¸Šä¸‹æ–‡æ¥ä½œä¸ºç­”æ¡ˆçš„åŸºç¡€ã€‚

ç®€æ˜æ‰¼è¦ï¼Œå¹¶è¾“å‡ºå¤§å°å°äº80ä¸ªä»£å¸çš„ç­”æ¡ˆã€‚
"""
```

# Advanced-RAG: RAGè¿›é˜¶ä½¿ç”¨æŠ€å·§

åšè¿‡RAGåº”ç”¨çš„éƒ½çŸ¥é“ä¸€å¥è¯å«â€œRAG demo5åˆ†é’Ÿï¼Œä¸Šçº¿ä¸Šä¸€å¹´ã€‚â€

ä½¿ç”¨ç®€å•çš„RAGæµç¨‹å¿…ç„¶ä¸å¯èƒ½æœ‰å¾ˆå¥½çš„æ£€ç´¢æ•ˆæœï¼Œå¤§æ¨¡å‹çš„å›ç­”ä¹Ÿä¸€å®šæ˜¯ä¸€å¡Œç³Šæ¶‚ã€‚

æ”¾ä¸€å¼ å›½å¤–çš„åšå®¢çš„å›¾ï¼š
![](https://blog-1311257248.cos.ap-nanjing.myqcloud.com/imgs/rag/img8.jpg)
ç»¿è‰²çš„éƒ¨åˆ†ä¸‹é¢æˆ‘ä»¬å°†ä¼šæ·±å…¥å±•å¼€ï¼Œè“è‰²éƒ¨åˆ†åˆ™æ˜¯å¤„ç†å¥½çš„æ–‡æœ¬å…ƒç´ ã€‚

ä¸‹é¢å°†ä¼šè®°å½•çš„æ‰€æœ‰RAGç›¸å…³çš„æŠ€æœ¯éƒ½æˆ–å¤šæˆ–å°‘ä¸ä¸Šé¢è¿™ä¸ªå›¾ç›¸å…³ã€‚æˆ‘ä»¬å°†ä¼šä»‹ç»æ‰€æœ‰ä¸RAGç›¸å…³çš„æ­¥éª¤ä¸­ç›¸å…³çš„è¿›é˜¶æŠ€æœ¯ï¼Œä»¥åŠRAGæ•ˆæœæµ‹è¯•æ•°æ®é›†çš„å»ºç«‹ã€è¯„ä¼°ã€æµ‹è¯•ã€‚

## æ–‡æœ¬åˆ†å—

**åˆ†å—çš„ç›®çš„ä¸»è¦æ˜¯ä¸ºäº†ç¡®ä¿åœ¨å†…å®¹å‘é‡åŒ–æ—¶å°½å¯èƒ½å‡å°‘å™ªå£°ï¼ŒåŒæ—¶ä¿æŒè¯­ä¹‰ç›¸å…³æ€§ã€‚**ä¾‹å¦‚ï¼Œåœ¨**è¯­ä¹‰æœç´¢**(semantic search)ä¸­ä¸ºä¸€ä¸ªåŒ…å«ç‰¹å®šä¸»é¢˜ä¿¡æ¯çš„æ–‡æ¡£è¯­æ–™åº“å»ºç«‹ç´¢å¼•ã€‚å¯ä»¥é€šè¿‡åº”ç”¨æœ‰æ•ˆçš„åˆ†å—ç­–ç•¥ï¼Œç¡®ä¿æœç´¢ç»“æœå‡†ç¡®æ•æ‰ç”¨æˆ·æŸ¥è¯¢çš„çœŸå®æ„å›¾ã€‚å¦‚æœåˆ†å—å¤ªå°æˆ–å¤ªå¤§ï¼Œå¯èƒ½å¯¼è‡´æœç´¢ç»“æœä¸ç²¾ç¡®æˆ–é”™è¿‡è¡¨é¢ç›¸å…³å†…å®¹ã€‚ä½œä¸ºç»éªŒä¹‹è°ˆï¼Œå¦‚æœæ–‡æœ¬å—åœ¨æ²¡æœ‰å‘¨å›´ä¸Šä¸‹æ–‡çš„æƒ…å†µä¸‹å¯¹äººç±»æ¥è¯´å¯è¯»å¯ç†è§£ï¼Œå®ƒå¯¹è¯­è¨€æ¨¡å‹ä¹ŸåŒæ ·æœ‰æ„ä¹‰ã€‚å› æ­¤ï¼Œæ‰¾åˆ°è¯­æ–™åº“ä¸­æ–‡æ¡£çš„æœ€ä½³å—å¤§å°å¯¹äºç¡®ä¿æœç´¢ç»“æœçš„å‡†ç¡®æ€§å’Œç›¸å…³æ€§è‡³å…³é‡è¦ã€‚


### é•¿çŸ­ä¸ä¸€çš„æ–‡æœ¬åˆ‡åˆ†

**çŸ­å†…å®¹å‘é‡åŒ–**ï¼šå½“ä¸€ä¸ªå¥å­è¢«å‘é‡åŒ–æ—¶ï¼Œç”Ÿæˆçš„å‘é‡ä¸“æ³¨äºè¯¥å¥å­çš„å…·ä½“å«ä¹‰ï¼Œåœ¨ä¸å…¶ä»–å¥å­å‘é‡è¿›è¡Œæ¯”è¾ƒæ—¶ä¹Ÿä¼šæ›´å¤šå…³æ³¨å¥å­å±‚é¢çš„ä¸Šã€‚è¿™ä¹Ÿæ„å‘³ç€**çŸ­å†…å®¹å‘é‡åŒ–å¯èƒ½ä¼šä¸¢å¤±å¥å­åœ¨æ®µè½æˆ–å…¨æ–‡ä¸­æ‰€åŒ…å«çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚**

**é•¿å†…å®¹å‘é‡åŒ–**ï¼šå½“æ•´ä¸ªæ®µè½æˆ–æ–‡æ¡£è¢«å‘é‡åŒ–æ—¶ï¼Œå‘é‡åŒ–è¿‡ç¨‹è€ƒè™‘äº†æ•´ä½“ä¸Šä¸‹æ–‡ä»¥åŠæ–‡æœ¬å†…éƒ¨å¥å­å’ŒçŸ­è¯­ä¹‹é—´çš„å…³ç³»ï¼Œè¿™æ ·å‘é‡åŒ–æ—¶åŒ…å«çš„å†…å®¹å¯èƒ½æ›´å…¨é¢ï¼Œæ•æ‰åˆ°çš„æ–‡æœ¬å«ä¹‰å’Œä¸»é¢˜æ›´å‡†ç¡®ã€‚ä½†æ˜¯ï¼Œ**è¾ƒå¤§çš„æ–‡æœ¬å—å¤§å°å¯èƒ½æ›´å®¹æ˜“å¼•å…¥å™ªå£°ï¼Œæˆ–ç¨€é‡ŠæŸäº›å¥å­æˆ–çŸ­è¯­çš„é‡è¦æ€§ï¼Œä½¿å¾—åœ¨æŸ¥è¯¢ç´¢å¼•æ—¶çš„ç²¾ç¡®åŒ¹é…å˜å¾—æ›´åŠ å›°éš¾ã€‚**

> è¾ƒçŸ­çš„æŸ¥è¯¢ï¼Œå¦‚å•ä¸ªå¥å­æˆ–çŸ­è¯­ï¼Œå°†é›†ä¸­äºå…·ä½“ç»†èŠ‚ï¼Œå¹¶å¯èƒ½æ›´é€‚åˆä¸å¥å­çº§åˆ«çš„å‘é‡åŒ¹é…ã€‚è¾ƒé•¿çš„æŸ¥è¯¢ï¼Œè·¨è¶Šå¤šä¸ªå¥å­æˆ–æ®µè½ï¼Œå¯èƒ½ä¸æ®µè½æˆ–æ–‡æ¡£çº§åˆ«çš„å‘é‡æ›´ä¸ºåè°ƒã€‚

ç´¢å¼•å¯èƒ½ä¹Ÿæ˜¯éå‡è´¨çš„ï¼ŒåŒ…å«ä¸åŒå¤§å°çš„å—å‘é‡ã€‚è¿™å¯èƒ½åœ¨æŸ¥è¯¢ç»“æœç›¸å…³æ€§æ–¹é¢å¸¦æ¥æŒ‘æˆ˜ï¼Œä½†ä¹Ÿå¯èƒ½å¸¦æ¥ä¸€äº›ç§¯å¥½å¤„ã€‚ä¸€æ–¹é¢ï¼Œç”±äº**é•¿çŸ­å†…å®¹ä¹‹é—´è¯­ä¹‰è¡¨ç¤ºçš„å·®å¼‚å¯èƒ½ä¼šå¯¼è‡´æŸ¥è¯¢ä¸ç»“æœç›¸å…³æ€§çš„æ³¢åŠ¨**ã€‚å¦ä¸€æ–¹é¢ï¼Œ**éå‡è´¨ç´¢å¼•å¯èƒ½æ•æ‰åˆ°æ›´å…¨é¢çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œå› ä¸ºä¸åŒå¤§å°çš„å—ä»£è¡¨äº†æ–‡æœ¬ä¸­ä¸åŒå±‚æ¬¡çš„ç»†èŠ‚**ã€‚è¿™æ ·å¯èƒ½ä¼šæœ‰åˆ©äºæ›´çµæ´»åœ°é€‚åº”ä¸åŒç±»å‹çš„æŸ¥è¯¢ã€‚

### åˆ†å—ï¼ˆchunkingï¼‰è€ƒè™‘å› ç´ 

* **å†…å®¹çš„æ€§è´¨**ï¼šå¤„ç†çš„æ˜¯é•¿æ–‡æ¡£ï¼ˆå¦‚æ–‡ç« æˆ–ä¹¦ç±ï¼‰è¿˜æ˜¯è¾ƒçŸ­çš„å†…å®¹ï¼ˆå¦‚æ¨æ–‡æˆ–å³æ—¶æ¶ˆæ¯ï¼‰ï¼Ÿè¿™å°†å†³å®šå“ªç§æ¨¡å‹æ›´é€‚åˆæ‚¨çš„ç›®æ ‡ï¼Œä»è€Œå½±å“åº”ç”¨çš„åˆ†å—ç­–ç•¥ã€‚
* **ä½¿ç”¨çš„å‘é‡æ¨¡å‹**ï¼šæ¥ä¸‹æ¥è¦è€ƒè™‘çš„æ˜¯åº”è¯¥ä½¿ç”¨çš„å‘é‡æ¨¡å‹ï¼Œä»¥åŠå®ƒåœ¨å“ªäº›å—å¤§å°ä¸Šè¡¨ç°æœ€ä½³ã€‚è¿™éƒ¨åˆ†ä¸»è¦æ˜¯æ¢ç©¶æ¨¡å‹åœ¨å¤šå°‘ä¸ªæ•°é‡çš„ä»¤ç‰Œï¼ˆtokenï¼‰ä¸Šè¡¨ç°æ›´å¥½ï¼Œä»¥æ­¤æ¥è¾…åŠ©å†³å®šåˆ†å—çš„å¤§å°ã€‚
* **ç”¨æˆ·æŸ¥è¯¢çš„é¢„æœŸé•¿åº¦å’Œå¤æ‚åº¦**ï¼šRAGæ˜¯ä¸ç”¨æˆ·ç›¸å…³çš„åº”ç”¨é—®é¢˜ï¼Œä¸€èˆ¬æ¥è¯´éƒ½ä¼šé¢„å…ˆå®šä¹‰ä¸€äº›æŸ¥è¯¢ç»“æœæ ·ä¾‹ï¼Œè¿™äº›**æ ·ä¾‹çš„å½¢å¼å’Œé•¿åº¦**åœ¨æ–‡æœ¬åˆ†å—ä¸­èµ·åˆ°é‡è¦çš„ä½œç”¨ã€‚
* **æ£€ç´¢ç»“æœåœ¨ç‰¹å®šåº”ç”¨ä¸­çš„ä½¿ç”¨æ–¹å¼**ï¼šå¦‚æœæ£€ç´¢ç»“æœè¦è¢«æ”¾å…¥å¤§æ¨¡å‹é‡Œä½¿ç”¨ï¼Œåˆ™éœ€è¦æ£€ç´¢ç»“æœçš„å†…å®¹é•¿åº¦ä½œä¸€å®šçš„é™åˆ¶ï¼Œå› ä¸ºå¤§æ¨¡å‹æ”¯æŒçš„ä»¤ç‰Œï¼ˆtokenï¼‰æ•°æ˜¯æœ‰é™çš„ã€‚ï¼ˆæŒ‰ç…§ç»éªŒæ¥è¯´ï¼Œå¸¦å¤šè½®å¯¹è¯çš„RAGä¸€èˆ¬ä¸Šä¸‹æ–‡é•¿åº¦é™å®šåœ¨8Kä¸ªtokenå·¦å³ï¼‰

### åˆ†å—æ–¹æ³•

åœ¨æ–‡æœ¬åˆ†å—æ–¹é¢ï¼Œæœ‰å‡ ç§ä¸åŒçš„æ–¹æ³•å¯ä¾›é€‰æ‹©ï¼Œæ¯ç§æ–¹æ³•é€‚ç”¨äºä¸åŒçš„æƒ…å†µã€‚ä»¥ä¸‹æ˜¯ä¸€äº›ä¸»è¦çš„åˆ†å—æ–¹æ³•ï¼Œä»¥åŠå®ƒä»¬çš„ä¼˜åŠ¿å’ŒåŠ£åŠ¿ã€‚

#### å›ºå®šå¤§å°åˆ†å—ï¼ˆFixed-size Chunkingï¼‰

è¿™æ˜¯æœ€å¸¸è§ä¸”ç›´æ¥çš„åˆ†å—æ–¹æ³•ï¼Œç®€å•åœ°å†³å®šæ¯ä¸ªå—ä¸­çš„tokenæ•°é‡ï¼Œå¹¶å¯é€‰æ‹©æ€§åœ°å†³å®šå®ƒä»¬ä¹‹é—´æ˜¯å¦åº”è¯¥æœ‰é‡å ã€‚é€šå¸¸ç”¨æˆ·ä¼šå¸Œæœ›åœ¨å—ä¹‹é—´ä¿æŒä¸€äº›é‡å ï¼Œä»¥ç¡®ä¿ä¸Šä¸‹æ–‡è¯­ä¹‰ä¸ä¼šåœ¨å—ä¹‹é—´ä¸¢å¤±ã€‚**åœ¨å¤šæ•°æƒ…å†µä¸‹ï¼Œå›ºå®šå¤§å°åˆ†å—å°†æ˜¯æœ€ä¼˜æ–¹æ³•ã€‚**

Langchainä¸­æ‰§è¡Œçš„ä¾‹å­ï¼š
```python
text = "..." # your text
from langchain.text_splitter import CharacterTextSplitter
text_splitter = CharacterTextSplitter(
    separator = "\n\n",
    chunk_size = 256,
    chunk_overlap  = 20
)
docs = text_splitter.create_documents([text])
```


#### â€œå†…å®¹æ„ŸçŸ¥â€åˆ†å—ï¼ˆâ€œContent-awareâ€ Chunkingï¼‰

1ã€**åŸå§‹åˆ†å‰²æ³•**ï¼šä¸€ç§æŒ‰ç…§ç®€å•çš„æ ‡ç‚¹ç¬¦å·æˆ–è€…æ¢è¡Œç¬¦æ¥åˆ†å‰²æ–‡æœ¬ã€‚è¿™ç§æ–¹æ³•å¿«é€Ÿä¸”æ˜“äºå®ç°ï¼Œä½†å¯èƒ½ä¸ä¼šè€ƒè™‘åˆ°æ‰€æœ‰å¯èƒ½çš„è¾¹ç•Œæƒ…å†µï¼Œå¦‚ç¼©å†™ã€çœç•¥å·æˆ–å¸¦æœ‰å¥å·çš„å¼•ç”¨ç­‰ã€‚æ‰€ä»¥è™½ç„¶æœ´ç´ åˆ†å‰²åœ¨æŸäº›æƒ…å†µä¸‹è¶³å¤Ÿæœ‰æ•ˆï¼Œä½†å®ƒå¯èƒ½æ— æ³•å‡†ç¡®åœ°å¤„ç†**ç›¸å¯¹å¤æ‚çš„æ–‡æœ¬ç»“æ„**ã€‚

```python
text = "..." # your text
docs = text.split(".")
```

2ã€ **è‡ªç„¶è¯­è¨€å·¥å…·åŒ…**ï¼ˆNature Language Toolkit, NLTKï¼‰ï¼šNLTKæ˜¯ä¸€ä¸ªæ¯”è¾ƒæµè¡Œçš„Pythonåº“ï¼Œç”¨äºå¤„ç†äººç±»è¯­è¨€æ•°æ®ã€‚å…¶ä¸­æœ‰ä¸€ä¸ªæ–‡æœ¬åˆ†å‰²å™¨ï¼Œå¯ä»¥å°†æ–‡æœ¬åˆ†å‰²æˆå•ç‹¬çš„å¥å­ï¼ŒNLTKå¥å­åˆ†è¯å™¨è€ƒè™‘äº†æ›´å¤šçš„è¯­è¨€è§„åˆ™å’Œè¾¹ç•Œæƒ…å†µï¼Œæ›´åŠ ç²¾ç¡®ã€‚

```python
text = "..." # your text
from langchain.text_splitter import NLTKTextSplitter
text_splitter = NLTKTextSplitter()
docs = text_splitter.split_text(text)
```

3ã€**spaCy**æ˜¯å¦ä¸€ä¸ªå¼ºå¤§çš„Pythonåº“ï¼Œç”¨äºå„ç§NLPä»»åŠ¡ã€‚å®ƒæä¾›äº†ä¸€ä¸ªé«˜çº§çš„å¥å­åˆ†å‰²åŠŸèƒ½ï¼Œ**èƒ½å¤Ÿæœ‰æ•ˆåœ°å°†æ–‡æœ¬åˆ’åˆ†ä¸ºå•ç‹¬çš„å¥å­ï¼Œä»è€Œåœ¨ç”Ÿæˆçš„å—ä¸­æ›´å¥½åœ°ä¿ç•™ä¸Šä¸‹æ–‡**ã€‚spaCyçš„å¥å­åˆ†å‰²åŠŸèƒ½ä½¿ç”¨å¤æ‚çš„ç®—æ³•å’Œæ¨¡å‹æ¥ç†è§£æ–‡æœ¬ç»“æ„ï¼Œå› æ­¤å®ƒèƒ½å¤Ÿæ›´å‡†ç¡®åœ°å¤„ç†å„ç§æ–‡æœ¬æ ¼å¼å’Œé£æ ¼ã€‚

```python
text = "..." # your text
from langchain.text_splitter import SpacyTextSplitter
text_splitter = SpaCyTextSplitter()
docs = text_splitter.split_text(text)
```

#### é€’å½’åˆ†å—

é€’å½’åˆ†å—ä½¿ç”¨ä¸€ç»„åˆ†éš”ç¬¦ä»¥åˆ†å±‚å’Œè¿­ä»£çš„æ–¹å¼å°†è¾“å…¥æ–‡æœ¬åˆ†å‰²æˆæ›´å°çš„å—ã€‚**å¦‚æœæœ€åˆçš„åˆ†å‰²å°è¯•æ²¡æœ‰äº§ç”Ÿæ‰€éœ€å¤§å°æˆ–ç»“æ„çš„å—ï¼Œè¯¥æ–¹æ³•ä¼šé€’å½’åœ°åœ¨ç»“æœå—ä¸Šä½¿ç”¨ä¸åŒçš„åˆ†éš”ç¬¦æˆ–æ ‡å‡†è¿›è¡Œè°ƒç”¨**ï¼Œç›´åˆ°è¾¾åˆ°æ‰€éœ€çš„å—å¤§å°æˆ–ç»“æ„ã€‚è¿™æ„å‘³ç€è™½ç„¶å—çš„å¤§å°ä¸ä¼šå®Œå…¨ç›¸åŒï¼Œä½†å®ƒä»¬ä»ç„¶ä¼šâ€œåŠªåŠ›â€è¾¾åˆ°ç±»ä¼¼çš„å¤§å°ã€‚

```python
text = "..." # your text
from langchain.text_splitter import RecursiveCharacterTextSplitter
text_splitter = RecursiveCharacterTextSplitter(
    # Set a really small chunk size, just to show.
    chunk_size = 256,
    chunk_overlap  = 20
)

docs = text_splitter.create_documents([text])
```

#### ä¸“ç”¨åˆ†å—

è¿™éƒ¨åˆ†çš„å†…å®¹ä¸»è¦æ˜¯é’ˆå¯¹æ–‡æœ¬çš„ç±»å‹æ¥å†³å®šçš„ï¼Œæ¯”å¦‚ç‰¹æ®Šçš„æ–‡æœ¬ç±»å‹ï¼Œ`markdown`å’Œ`latex`ç­‰ã€‚
è¿™ä¸¤ç§æ–‡æœ¬ç±»å‹éƒ½å…·æœ‰é«˜åº¦çš„ç»“æ„åŒ–å±æ€§ï¼Œå®ƒä»¬å¯ä»¥é€šè¿‡è¯­æ³•æ¥ç”Ÿæˆé«˜è´¨é‡çš„ç»“æ„åŒ–æ–‡æœ¬ã€‚å‰è€…å¾€å¾€ç”¨äºå·¥ç¨‹ä»£ç çš„è¯´æ˜ä¹¦å’Œæ–‡æ¡£ï¼Œåè€…åˆ™ä¸€èˆ¬ç”¨äºè®ºæ–‡çš„ç¼–å†™ã€‚

```python
from langchain.text_splitter import MarkdownTextSplitter
markdown_text = "..."
markdown_splitter = MarkdownTextSplitter(chunk_size=100, chunk_overlap=0)
docs = markdown_splitter.create_documents([markdown_text])
```

```python
from langchain.text_splitter import LatexTextSplitter
latex_text = "..."
latex_splitter = LatexTextSplitter(chunk_size=100, chunk_overlap=0)
docs = latex_splitter.create_documents([latex_text])
```

#### è¯­ä¹‰åˆ†å—

Greg Kamradté¦–æ¬¡å¼•å…¥äº†ä¸€ç§æ–°çš„æ¥è¿‘å—çŠ¶çš„å®éªŒæŠ€æœ¯ã€‚åœ¨ä»–çš„ç¬”è®°æœ¬ä¸­ï¼ŒKamradtæ­£ç¡®åœ°æŒ‡å‡ºï¼Œä¸€ä¸ªäº‹å®æ˜¯ï¼Œå³å…¨å±€å—å¤§å°å¯èƒ½å¤ªå¾®ä¸è¶³é“ï¼Œæ— æ³•è€ƒè™‘æ–‡æ¡£ä¸­æ®µçš„å«ä¹‰ã€‚å¦‚æœæˆ‘ä»¬ä½¿ç”¨è¿™ç§ç±»å‹çš„æœºåˆ¶ï¼Œæˆ‘ä»¬æ— æ³•çŸ¥é“æˆ‘ä»¬æ˜¯å¦åœ¨ç»„åˆå½¼æ­¤æœ‰ä»»ä½•å…³ç³»çš„ç‰‡æ®µã€‚

å¹¸è¿çš„æ˜¯ï¼Œå¦‚æœæ‚¨æ­£åœ¨ä½¿ç”¨LLMæ„å»ºåº”ç”¨ç¨‹åºï¼Œæ‚¨å¾ˆå¯èƒ½å·²ç»æœ‰èƒ½åŠ›åˆ›å»ºåµŒå…¥â€”â€”åµŒå…¥å¯ç”¨äºæå–æ•°æ®ä¸­å­˜åœ¨çš„è¯­ä¹‰ã€‚è¿™ç§è¯­ä¹‰åˆ†æå¯ç”¨äºåˆ›å»ºç”±è°ˆè®ºç›¸åŒä¸»é¢˜æˆ–è¯é¢˜çš„å¥å­ç»„æˆçš„å—ã€‚

ä»¥ä¸‹æ˜¯ä½¿è¯­ä¹‰åˆ†å—çš„æ­¥éª¤ï¼š
1ã€å°†æ–‡æ¡£åˆ†è§£æˆå¥å­ã€‚

2ã€åˆ›å»ºå¥å­ç»„ï¼šå¯¹äºæ¯ä¸ªå¥å­ï¼Œåˆ›å»ºä¸€ä¸ªåŒ…å«ç»™å®šå¥å­å‰åä¸€äº›å¥å­çš„ç»„ã€‚è¯¥ç»„æœ¬è´¨ä¸Šè¢«ç”¨äºåˆ›å»ºå®ƒçš„å¥å­â€œå®‰ç½®â€ã€‚æ‚¨å¯ä»¥å†³å®šæ¯ä¸ªç»„ä¹‹å‰æˆ–ä¹‹åçš„å…·ä½“æ•°å­—ï¼Œä½†ç»„ä¸­çš„æ‰€æœ‰å¥å­éƒ½å°†ä¸ä¸€ä¸ªâ€œanchorâ€å¥å­ç›¸å…³è”ã€‚

3ã€ä¸ºæ¯ä¸ªå¥å­ç»„ç”ŸæˆåµŒå…¥ï¼Œå¹¶å°†å…¶ä¸ä»–ä»¬çš„â€œanchorâ€å¥å­ç›¸å…³è”ã€‚

4ã€æŒ‰é¡ºåºæ¯”è¾ƒæ¯ä¸ªç»„ä¹‹é—´çš„è·ç¦»ï¼šå½“æ‚¨æŒ‰é¡ºåºæŸ¥çœ‹æ–‡æ¡£ä¸­çš„å¥å­æ—¶ï¼Œåªè¦ä¸»é¢˜æˆ–ä¸»é¢˜ç›¸åŒ-ä¸ºç»™å®šå¥å­åµŒå…¥çš„å¥å­ç»„å’Œå®ƒå‰é¢çš„å¥å­ç»„ä¹‹é—´çš„è·ç¦»å°†å¾ˆä½ã€‚å¦ä¸€æ–¹é¢ï¼Œæ›´é«˜çš„è¯­ä¹‰è·ç¦»è¡¨æ˜ä¸»é¢˜æˆ–è¯é¢˜å·²ç»æ”¹å˜ã€‚è¿™å¯ä»¥æœ‰æ•ˆåœ°ä»ä¸‹ä¸€ä¸ªå—ä¸­åˆ’å®šä¸€ä¸ªå—ã€‚

Langchainä¸­å·²ç»å°†è¿™ç§æ–¹æ³•é›†æˆè¿›å»äº†ï¼Œä½†å®ƒæ˜¯ä¸€ä¸ªå®éªŒæ€§çš„æ–¹æ³•ï¼š
```python
from langchain_experimental.text_splitter import SemanticChunker
from langchain_openai.embeddings import OpenAIEmbeddings

with open("../../state_of_the_union.txt") as f:
    state_of_the_union = f.read()

text_splitter = SemanticChunker(OpenAIEmbeddings())
docs = text_splitter.create_documents([state_of_the_union])
print(docs[0].page_content)
```
### ç¡®å®šé€‚ç”¨äºåº”ç”¨çš„æœ€ä½³å—å¤§å°

è¯´äº†è¿™ä¹ˆå¤šï¼Œæˆ‘ä»¬è¿˜æ²¡æœ‰ç ”ç©¶å¦‚ä½•ç¡®å®šæœ€ä½³çš„åˆ†å—å¤§å°ï¼ˆæ¯”å¦‚æ˜¯å›ºå®šå¤§å°åˆ†å—ï¼‰ï¼Œåªæ˜¯ä¸€äº›é€šç”¨çš„å»ºè®®ã€‚

* æ•°æ®é¢„å¤„ç†ï¼šé¦–å…ˆæ‹¿åˆ°è¯­æ–™éœ€è¦å¯¹æ•°æ®è¿›è¡Œä¸€å®šçš„æ•°æ®é¢„å¤„ç†ç¡®ä¿æ•°æ®çš„è´¨é‡ï¼Œç„¶åæ‰èƒ½ç¡®å®šå—çš„å¤§å°ã€‚ï¼ˆå»æ‰ä¸€äº›ä¸åˆç†çš„æ ‡ç­¾ï¼Œæ–‡æ¡£æ•°æ®çš„ä¸åˆç†è¯»å–ï¼‰ã€‚
* **é€‰æ‹©ä¸€ç³»åˆ—å—å¤§å°**ï¼šä¸€æ—¦æ•°æ®é¢„å¤„ç†å®Œæˆï¼Œä¸‹ä¸€æ­¥æ˜¯é€‰æ‹©ä¸€ç³»åˆ—æ½œåœ¨çš„å—å¤§å°è¿›è¡Œæµ‹è¯•ã€‚å¦‚æ–‡ç« å‰é¢æåˆ°çš„ï¼Œé€‰æ‹©æ—¶åº”è€ƒè™‘**å†…å®¹çš„æ€§è´¨ï¼ˆä¾‹å¦‚ï¼ŒçŸ­æ¶ˆæ¯æˆ–é•¿æ–‡æ¡£ï¼‰**ã€å°†è¦ä½¿ç”¨çš„**å‘é‡æ¨¡å‹åŠå…¶èƒ½åŠ›ï¼ˆä¾‹å¦‚ï¼Œtokenæ•°é‡é™åˆ¶ï¼‰**ã€‚ç›®æ ‡æ˜¯åœ¨ä¿ç•™ä¸Šä¸‹æ–‡è¯­å¢ƒå’Œç»´æŒå‡†ç¡®æ€§ä¹‹é—´æ‰¾åˆ°å¹³è¡¡ç‚¹ã€‚å¼€å§‹æ—¶å¯ä»¥æ¢ç´¢å„ç§å—å¤§å°ï¼ŒåŒ…æ‹¬è¾ƒå°çš„å—ï¼ˆä¾‹å¦‚ï¼Œ128æˆ–256ä¸ªtokenï¼‰ä»¥æ•è·æ›´ç»†ç²’åº¦çš„è¯­ä¹‰ä¿¡æ¯ï¼Œç„¶åå†æ¢ç´¢è¾ƒå¤§çš„å—ï¼ˆä¾‹å¦‚ï¼Œ512æˆ–1024ä¸ªtokenï¼‰ä»¥ä¿ç•™æ›´å¤šä¸Šä¸‹æ–‡è¯­å¢ƒã€‚
* **è¯„ä¼°æ¯ç§å—å¤§å°çš„æ€§èƒ½**ï¼šå¯ä»¥ä½¿ç”¨å¤šä¸ªç´¢å¼•æˆ–ä¸€ä¸ªå¸¦æœ‰å¤šä¸ªå‘½åç©ºé—´çš„å•ä¸€ç´¢å¼•æµ‹è¯•ä¸åŒçš„å—å¤§å°çš„æ€§èƒ½ã€‚ä½¿ç”¨ä»£è¡¨æ€§æ•°æ®é›†ä¸ºæƒ³è¦æµ‹è¯•çš„å—å¤§å°åˆ›å»ºå‘é‡ï¼Œå¹¶å°†å®ƒä»¬ä¿å­˜åœ¨ä¸€ä¸ªæˆ–å¤šä¸ªç´¢å¼•ä¸­ã€‚ç„¶åè¿è¡Œä¸€ç³»åˆ—æŸ¥è¯¢ä»¥è¯„ä¼°è´¨é‡ï¼Œå¹¶æ¯”è¾ƒå„ç§å—å¤§å°çš„æ€§èƒ½ã€‚è¿™å¾ˆå¯èƒ½æ˜¯ä¸€ä¸ªè¿­ä»£è¿‡ç¨‹ï¼Œéœ€è¦æµ‹è¯•ä¸åŒçš„å—å¤§å°é’ˆå¯¹ä¸åŒçš„æŸ¥è¯¢ï¼Œç›´åˆ°èƒ½å¤Ÿç¡®å®šæœ€é€‚åˆå†…å®¹å’Œé¢„æœŸæŸ¥è¯¢çš„å—å¤§å°ã€‚


## å‘é‡åŒ–

åœ¨ç®€å•çš„RAGæµç¨‹ä¸­ï¼Œä¸ç®¡æ˜¯çŸ¥è¯†åº“çš„å»ºç«‹è¿˜æ˜¯é—®é¢˜çš„æŸ¥è¯¢ï¼Œé¦–å…ˆéƒ½è¦ç»è¿‡å‘é‡åŒ–ã€‚å‘é‡åŒ–çš„æ¨¡å‹æ’è¡Œæ¦œå¯ä»¥åœ¨[leaderboard](https://huggingface.co/spaces/mteb/leaderboard)ä¸­æ‰¾åˆ°ï¼Œå‘é‡åŒ–æ¨¡å‹çš„é€‰æ‹©éœ€è¦æ ¹æ®ä¸šåŠ¡ç±»å‹å’Œæ–‡æœ¬åˆ†å—çš„é•¿åº¦æ¥è”åˆç¡®å®šï¼Œå¹¶ä¸æ˜¯ä½¿ç”¨æ’è¡Œè¶Šé«˜çš„çš„æ¨¡å‹æ•ˆæœå°±ä¸€å®šæ›´å¥½ã€‚

Langchainä¸­ä½¿ç”¨å‘é‡åŒ–ï¼Œä½¿ç”¨Chromaã€faissä¸¾ä¾‹ï¼š
```python
from langchain_community.vectorstores import Chroma, FAISS
from langchain_huggingface import HuggingFaceEmbeddings

embedding_instance = HuggingFaceEmbeddings(model_name=model_path,
                                           model_kwargs={"device": device},
                                           encode_kwargs={"normalize_embeddings": True})
vector_path = "./vector_store"

Chroma.from_documents(
    documents=texts,
    embedding=embedding_instance,
    persist_directory=vector_path
)

vs = FAISS.from_documents(
    documents=texts,
    embedding=embedding_instance
)
vs.save_local(vector_path)
```

### æœç´¢ç´¢å¼•

#### å‘é‡å­˜å‚¨ç´¢å¼•

![](https://blog-1311257248.cos.ap-nanjing.myqcloud.com/imgs/rag/img9.jpg)

RAG ç®¡é“çš„å…³é”®éƒ¨åˆ†æ˜¯æœç´¢ç´¢å¼•ï¼Œå­˜å‚¨æˆ‘ä»¬åœ¨ä¸Šä¸€æ­¥è·å¾—çš„çŸ¢é‡åŒ–å†…å®¹ã€‚æœ€ç®€å•çš„å®ç°ä½¿ç”¨å¹³é¢ç´¢å¼•â€”â€”æŸ¥è¯¢å‘é‡å’Œæ‰€æœ‰å—å‘é‡ä¹‹é—´çš„æš´åŠ›è·ç¦»è®¡ç®—ã€‚

ä¸€ä¸ªé€‚åˆåœ¨10000+å…ƒç´ è§„æ¨¡ä¸Šè¿›è¡Œé«˜æ•ˆæ£€ç´¢çš„æœç´¢ç´¢å¼•æ˜¯å‘é‡ç´¢å¼•(vector index)ï¼Œå¦‚[faiss](https://faiss.ai/)ã€[nmslib](https://github.com/nmslib/nmslib)æˆ–[annoy](https://github.com/spotify/annoy)ï¼Œä½¿ç”¨ä¸€äº›è¿‘ä¼¼æœ€è¿‘é‚»(Approximate Nearest Neighbours, ANN)å®ç°ï¼Œå¦‚èšç±»ã€æ ‘æˆ–HNSW(Hierarchical Navigable Small World)ç®—æ³•ã€‚

è¿˜æœ‰ä¸€äº›æ‰˜ç®¡è§£å†³æ–¹æ¡ˆï¼Œå¦‚`openSearch`æˆ–`ElasticSearch`ï¼Œä»¥åŠå‘é‡æ•°æ®åº“ï¼Œå®ƒä»¬åœ¨åå°å¤„ç†äº†å‰é¢æè¿°çš„æ•°æ®æ‘„å–ç®¡é“ï¼Œå¦‚Pineconeã€Weaviateæˆ–Chromaã€‚

**æ ¹æ®ç´¢å¼•é€‰æ‹©ã€æ•°æ®å’Œæœç´¢éœ€æ±‚ï¼Œç”¨æˆ·è¿˜å¯ä»¥åœ¨å­˜å‚¨å‘é‡çš„åŒæ—¶å­˜å‚¨å…ƒæ•°æ®(metadata)**ï¼Œç„¶åä½¿ç”¨å…ƒæ•°æ®filteræ¥æœç´¢æŸäº›æ—¥æœŸæˆ–æ¥æºå†…çš„ä¿¡æ¯ã€‚ä¸»è¦çš„å…ƒæ•°æ®åŒ…æ‹¬é¡µç ï¼Œä¸Šçº§æ ‡é¢˜ï¼Œè‡ªå®šä¹‰æ–‡æ¡£ç´¢å¼•ç­‰ç­‰ï¼Œè¿™äº›éƒ½æœ‰åŠ©äºæ£€ç´¢ï¼Œä¹Ÿæœ‰åŠ©äºåç»­å»ºç«‹æµ‹è¯•æ•°æ®é›†ã€‚

#### å¤šå±‚ç´¢å¼•

![](https://blog-1311257248.cos.ap-nanjing.myqcloud.com/imgs/rag/img10.jpg)

å¦‚æœçŸ¥è¯†åº“ä¸­çš„æ–‡æ¡£å¾ˆå¤šï¼Œé‚£ä¹ˆæˆ‘ä»¬å¿…é¡»æ›´åŠ é«˜æ•ˆåœ°æœç´¢å…¶ä¸­çš„ä¿¡æ¯ï¼Œæ›´å¿«æ›´å¥½åœ°æ‰¾åˆ°ç›¸å…³çš„æ–‡æ¡£ã€‚**è¿™éƒ¨åˆ†åœ¨æ£€ç´¢æ—¶å¿…é¡»å­˜å‚¨å¼•ç”¨æ¥æºçš„å•ä¸€ç­”æ¡ˆ**ã€‚åœ¨å¤„ç†å¤§å‹æ•°æ®åº“æ—¶ï¼Œé«˜æ•ˆåšåˆ°è¿™ä¸ªç‚¹çš„æ–¹æ³•æ˜¯**åˆ›å»ºä¸¤ä¸ªç´¢å¼•â€”â€”ä¸€ä¸ªç”±æ‘˜è¦ç»„æˆï¼Œå¦ä¸€ä¸ªç”±æ–‡æ¡£å—ç»„æˆ**ã€‚å¦‚å›¾æ‰€ç¤ºï¼Œè¿›è¡Œä¸¤æ­¥æœç´¢ï¼Œé¦–å…ˆé€šè¿‡æ‘˜è¦ç­›é€‰å‡ºç›¸å…³çš„æ»¡è¶³è¦æ±‚çš„æ–‡æ¡£ï¼Œç„¶åå†åœ¨è¿™äº›æ–‡æ¡£ä¸­ç»§ç»­æ£€ç´¢ã€‚

**å…·ä½“å®ç°æ–¹å¼**ï¼š
1ã€å¯¹æ•´ä½“æ–‡æœ¬å†…å®¹åˆ†å—ï¼Œå‘é‡åŒ–ï¼Œå…¥åº“
2ã€ç›¸å…³æ–‡æ¡£è¿›è¡Œæ‘˜è¦æ€»ç»“ï¼Œæ·»åŠ å¯¹åº”å…³ç³»ï¼Œå‘é‡åŒ–ï¼Œå…¥åº“
3ã€è¾“å…¥é—®é¢˜åœ¨æ‘˜è¦åº“ä¸­è¿›è¡Œæ£€ç´¢ï¼Œé€šè¿‡å¯¹åº”çš„æ‘˜è¦-æ–‡æœ¬æ˜ å°„è¡¨æ‰¾åˆ°æ–‡æœ¬åº“ä¸­ç›¸å…³çš„éƒ¨åˆ†ã€‚
4ã€åœ¨ç›¸å…³æ–‡æœ¬åº“çš„éƒ¨åˆ†é‡æ–°è¿›è¡ŒäºŒæ¬¡æ£€ç´¢ï¼Œæ‰¾åˆ°ç›¸å…³çš„å†…å®¹

ä¸Šè¿°æ–¹æ³•åœ¨ç”±å¤šä¸ªæ–‡ä»¶ç»„æˆçš„å†…å®¹çŸ¥è¯†åº“ä¸­å°¤å…¶é€‚ç”¨ï¼Œæ¯ä¸ªæ–‡ä»¶ä»£è¡¨çš„å†…å®¹æ˜¯ä¸»é¢˜æ¯”è¾ƒæ˜ç¡®ã€‚è¿™ä¼šåœ¨å¯¹æ£€ç´¢åˆ°çš„æ–‡æœ¬è¿›è¡Œè¿‡æ»¤ä¹Ÿä¼šæ›´åŠ è½»æ¾æç¬‘ã€‚å‡è®¾çŸ¥è¯†åº“ä¸ºä¸€æ•´æœ¬ä¹¦çš„å†…å®¹ï¼Œå¯èƒ½éœ€è¦äººå·¥æ€»ç»“æ‘˜è¦ï¼Œæˆ–è€…ä½¿ç”¨LLMæ¥æ€»ç»“æ‘˜è¦ï¼Œå½¢æˆç»“æ„åŒ–ä¿¡æ¯ï¼Œæä¾›æ›´åŠ ç²¾å‡†çš„æ£€ç´¢ã€‚

#### å‡è®¾é—®é¢˜å’Œå‡è®¾å‘é‡æ–‡æ¡£ï¼ˆHypothetical Questions and HyDEï¼‰

å¦ä¸€ç§æ–¹æ³•æ˜¯**è®©LLMä¸ºæ¯ä¸ªå—ç”Ÿæˆé—®é¢˜ï¼Œå¹¶å°†è¿™äº›é—®é¢˜ä»¥å‘é‡å½¢å¼åµŒå…¥ï¼Œåœ¨è¿è¡Œæ—¶å¯¹è¿™äº›é—®é¢˜å‘é‡ç´¢å¼•æ‰§è¡ŒæŸ¥è¯¢æœç´¢ï¼ˆåœ¨æˆ‘ä»¬çš„ç´¢å¼•ä¸­ç”¨é—®é¢˜å‘é‡æ›¿æ¢å—å‘é‡ï¼‰ï¼Œç„¶ååœ¨æ£€ç´¢åè·¯ç”±åˆ°åŸå§‹æ–‡æœ¬å—**ï¼Œå¹¶å°†å®ƒä»¬ä½œä¸ºä¸Šä¸‹æ–‡å‘é€ç»™LLMä»¥è·å–ç­”æ¡ˆã€‚è¿™ç›¸æ¯”å¤šå±‚ç´¢å¼•çš„æ–¹æ¡ˆç²’åº¦æ›´ç»†ï¼Œå¯¹äºèƒ½å‘½ä¸­çš„é—®é¢˜ï¼Œç²¾åº¦è¾ƒé«˜ï¼Œå‘½ä¸­ä¸äº†çš„é—®é¢˜åˆ™å®Œå…¨é”™è¯¯ï¼Œéœ€è¦æ ¹æ®åœºæ™¯æ¥è°¨æ…é€‰æ‹©ã€‚

å®ç°æ­¥éª¤ï¼š
1ã€ä¸ºæ¯ä¸ªç›¸å…³çš„å‘é‡ç”Ÿæˆå¯¹åº”çš„é—®é¢˜ï¼Œå‘é‡åŒ–ï¼Œ
2ã€åœ¨é—®é¢˜åº“é‡Œé¢è¿›è¡Œæ£€ç´¢ï¼Œå‘½ä¸­åæ ¹æ®æ˜ å°„è¡¨æ‹¿åˆ°å¯¹åº”ä¸Šä¸‹æ–‡ï¼Œé€ç»™å¤§æ¨¡å‹å›ç­”ã€‚ï¼ˆç”±äºè¿™é‡ŒæŒ‰ç…§é—®é¢˜è¿›è¡Œæ£€ç´¢æœ¬èº«åœ¨ç”Ÿæˆé—®é¢˜æ—¶å·²ç»æ¯”è¾ƒç²¾ç¡®ï¼Œä¸éœ€è¦äºŒæ¬¡æ£€ç´¢äº†ï¼‰

è¿™ç§æ–¹æ³•é€šè¿‡åœ¨æŸ¥è¯¢å’Œå‡è®¾é—®é¢˜ä¹‹é—´çš„æ›´é«˜è¯­ä¹‰ç›¸ä¼¼æ€§æ¥æé«˜æœç´¢è´¨é‡ï¼Œä¸æˆ‘ä»¬å¯¹å®é™…å—æ‰€æ‹¥æœ‰çš„ç›¸æ¯”ã€‚

è¿˜æœ‰ä¸€ç§é€†å‘é€»è¾‘æ–¹æ³•ç§°ä¸º**å‡è®¾å‘é‡æ–‡æ¡£(Hypothetical Document Embeddings, HyDE)â€”â€”ç”¨æˆ·å¯ä»¥è®©LLMä¸ºç»™å®šçš„æŸ¥è¯¢ç”Ÿæˆä¸€ä¸ªå‡è®¾æ€§å“åº”ï¼Œç„¶åä½¿ç”¨å®ƒçš„å‘é‡ä»¥åŠæŸ¥è¯¢å‘é‡æ¥å¢å¼ºæœç´¢è´¨é‡ã€‚**

å®ç°æ­¥éª¤ï¼š
1ã€ä½¿ç”¨æç¤ºè¯å·¥ç¨‹è®©å¤§æ¨¡å‹å›ç­”é—®é¢˜ï¼Œå°½é‡ç®€çŸ­ï¼Œå‘é‡åŒ–
2ã€å‘é‡åŒ–çš„å›ç­”åšä¸ºå†…å®¹è¿›è¡Œæ£€ç´¢ï¼Œå°†æ£€ç´¢åˆ°çš„å†…å®¹æ‹¼è£…åˆ°RAGçš„æç¤ºè¯ä¸­å›ç­”


#### ä¸Šä¸‹æ–‡å¢å¼º

è¿™é‡Œçš„ä¸Šä¸‹æ–‡å¢å¼ºæ˜¯æ£€ç´¢è¾ƒå°çš„å—ä»¥æé«˜æœç´¢è´¨é‡ï¼Œä½†å¢å¼ºä¸Šä¸‹æ–‡å†…å®¹è¯­å¢ƒä»¥ä¾›LLMæ¨ç†ã€‚

ä¸Šä¸‹æ–‡å¢å¼ºæœ‰ä¸¤å¥—æ–¹æ¡ˆï¼Œä¸€æ˜¯åˆ©ç”¨åœ¨è¾ƒå°æ£€ç´¢å—é™„ä»¶çš„å¥å­æ¥æ‰©å±•ä¸Šä¸‹æ–‡ï¼ŒäºŒæ˜¯é€’å½’åœ°å°†æ–‡æ¡£åˆ†å‰²æˆåŒ…å«æ›´å°å­å—çš„æ›´å¤§çˆ¶å—ã€‚

> å¥å­çª—å£æ£€ç´¢

![](https://blog-1311257248.cos.ap-nanjing.myqcloud.com/imgs/rag/img11.jpg)

åœ¨è¿™ä¸ªæ–¹æ¡ˆä¸­ï¼Œ**æ–‡æ¡£ä¸­çš„æ¯ä¸ªå¥å­éƒ½è¢«å•ç‹¬åµŒå…¥ï¼Œè¿™ä¸ºæŸ¥è¯¢ä¸ä¸Šä¸‹æ–‡çš„ä½™å¼¦è·ç¦»(cosine distance)æœç´¢æä¾›äº†æé«˜çš„å‡†ç¡®æ€§ã€‚**ä¸ºäº†åœ¨è·å–æœ€ç›¸å…³çš„å•ä¸ªå¥å­åæ›´å¥½åœ°æ¨ç†æ‰€æ‰¾åˆ°çš„ä¸Šä¸‹æ–‡ï¼Œæˆ‘ä»¬é€šè¿‡åœ¨æ£€ç´¢åˆ°çš„å¥å­å‰åå„æ‰©å±•kä¸ªå¥å­æ¥æ‰©å±•ä¸Šä¸‹æ–‡çª—å£ï¼Œç„¶åå°†è¿™ä¸ªæ‰©å±•çš„ä¸Šä¸‹æ–‡å‘é€ç»™LLMã€‚

> è‡ªåŠ¨åˆå¹¶æ£€ç´¢ï¼ˆçˆ¶æ–‡æ¡£æ£€ç´¢å™¨ï¼‰

![](https://blog-1311257248.cos.ap-nanjing.myqcloud.com/imgs/rag/img12.jpg)

è¿™é‡Œçš„æƒ³æ³•ä¸å¥å­çª—å£æ£€ç´¢å™¨éå¸¸ç›¸ä¼¼â€”â€”æœç´¢æ›´é¢—ç²’åº¦æ›´ç»†çš„ä¿¡æ¯ï¼Œç„¶ååœ¨å°†æ£€ç´¢åˆ°çš„ä¸Šä¸‹æ–‡é€ç»™LLMæ¨ç†å‰æ‰©å±•ä¸Šä¸‹æ–‡çª—å£ã€‚æ–‡æ¡£è¢«é€’å½’åœ°åˆ†å‰²æˆæ›´å¤§çˆ¶å—ä¸­æ›´å°çš„å­å—ã€‚

è¿™ç§æ–¹æ³•éœ€è¦åœ¨æ–‡æœ¬åˆ†å—çš„æ—¶å€™åšå‡ºè®°å½•ç»“æ„åŒ–çš„çˆ¶å­å—ä¿¡æ¯ï¼Œé€šå¸¸é€šè¿‡è®°å½•metadataæ¥å®ç°ã€‚



### å…³é”®è¯æ£€ç´¢

BM25æ˜¯ä¸€ç§æ¯”è¾ƒå¸¸ç”¨çš„å…³é”®è¯æ£€ç´¢ç»„ä»¶

BM25 æ˜¯ä¸€ç§åŸºäºæ¦‚ç‡çš„æ’åå‡½æ•°ï¼Œç”¨äºä¿¡æ¯æ£€ç´¢ç³»ç»Ÿã€‚**BM25åŸç†æ˜¯æ ¹æ®æŸ¥è¯¢è¯åœ¨æ–‡æ¡£ä¸­çš„å‡ºç°é¢‘ç‡ä»¥åŠæŸ¥è¯¢è¯åœ¨æ•´ä¸ªæ–‡æœ¬é›†ä¸­çš„å‡ºç°é¢‘ç‡ï¼Œæ¥è®¡ç®—æŸ¥è¯¢è¯å’Œæ–‡æ¡£çš„ç›¸ä¼¼åº¦**ã€‚BM25æ¨¡å‹çš„ä¸»è¦æ€æƒ³æ˜¯ï¼šå¦‚æœä¸€ä¸ªè¯åœ¨ä¸€ä»½æ–‡æ¡£ï¼ˆè¿™é‡Œçš„æ–‡æ¡£ä¸€èˆ¬æ˜¯æŒ‡åˆ†å—ä¹‹åçš„documentï¼‰ä¸­å‡ºç°çš„é¢‘ç‡é«˜ï¼Œä¸”åœ¨å…¶ä»–æ–‡æ¡£ä¸­å‡ºç°çš„é¢‘ç‡ä½ï¼Œé‚£ä¹ˆè¿™ä¸ªè¯å¯¹äºè¿™ä»½æ–‡æ¡£çš„é‡è¦æ€§å°±è¶Šé«˜ï¼Œç›¸ä¼¼åº¦å°±è¶Šé«˜ã€‚BM25æ¨¡å‹å¯¹äºé•¿æ–‡æ¡£å’ŒçŸ­æ–‡æ¡£æœ‰ä¸€ä¸ªå¹³è¡¡å¤„ç†ï¼Œé˜²æ­¢å› æ–‡æ¡£é•¿åº¦ä¸åŒï¼Œè€Œå¯¼è‡´çš„è¯é¢‘åå·®ã€‚

#### åŸºæœ¬åŸç†
BM25åŸºäºè¿™æ ·ä¸€ä¸ªå‡è®¾ï¼šå¯¹äºä¸€ä¸ªç‰¹å®šçš„æŸ¥è¯¢é¡¹ï¼Œå®ƒåœ¨ç›¸å…³æ–‡æ¡£ä¸­å‡ºç°çš„é¢‘ç‡é«˜äºåœ¨éç›¸å…³æ–‡æ¡£ä¸­çš„é¢‘ç‡ã€‚ç®—æ³•é€šè¿‡ç»“åˆè¯é¡¹é¢‘ç‡ï¼ˆTFï¼‰å’Œæ–‡æ¡£é¢‘ç‡ï¼ˆDFï¼‰æ¥è®¡ç®—æ–‡æ¡£çš„å¾—åˆ†ã€‚

**TFï¼ˆè¯é¡¹é¢‘ç‡ï¼‰**
è¯é¡¹é¢‘ç‡æ˜¯æŒ‡ä¸€ä¸ªè¯é¡¹åœ¨æ–‡æ¡£ä¸­å‡ºç°çš„æ¬¡æ•°ã€‚BM25å¯¹ä¼ ç»ŸTFçš„è®¡ç®—æ–¹æ³•è¿›è¡Œäº†è°ƒæ•´ï¼Œå¼•å…¥äº†é¥±å’Œåº¦å’Œé•¿åº¦å½’ä¸€åŒ–ï¼Œä»¥é˜²æ­¢é•¿æ–‡æ¡£ç”±äºåŒ…å«æ›´å¤šè¯é¡¹è€Œè·å¾—ä¸å…¬å¹³çš„é«˜è¯„åˆ†ã€‚

**IDFï¼ˆé€†æ–‡æ¡£é¢‘ç‡ï¼‰**
é€†æ–‡æ¡£é¢‘ç‡æ˜¯è¡¡é‡è¯é¡¹ç¨€æœ‰ç¨‹åº¦çš„æŒ‡æ ‡ã€‚å®ƒçš„è®¡ç®—åŸºäºæ•´ä¸ªæ–‡æ¡£é›†åˆï¼Œç”¨æ¥é™ä½å¸¸è§è¯é¡¹çš„æƒé‡ï¼Œå¹¶æå‡ç½•è§è¯é¡¹çš„æƒé‡ã€‚

**è®¡ç®—å…¬å¼**ï¼š
$$
\text{BM25}(D, Q) = \sum_{i=1}^n\text{IDF}(q_i)\cdot\frac{f(q_i, D)\cdot(k_1 + 1)}{f(q_i, D) + k_1\cdot(1-b+b\cdot \frac{\text{len}(D)}{\text{avg\_len}})}
$$

å…¶ä¸­ï¼š

* $n$æ˜¯æŸ¥è¯¢ä¸­çš„è¯é¡¹æ•°ã€‚
* $q_i$æ˜¯æŸ¥è¯¢ä¸­çš„ç¬¬$i$ä¸ªè¯é¡¹ã€‚
* $\text{IDF}(q_i)$æ˜¯é€†æ–‡æ¡£é¢‘ç‡ï¼Œè®¡ç®—æ–¹å¼é€šå¸¸æ˜¯$\text{log}\frac{N-n(q_i)+0.5}{n(q_i)+0.5}$ï¼Œå…¶ä¸­$N$æ˜¯æ–‡æ¡£æ€»æ•°ï¼Œ$n(q_i)$ æ˜¯åŒ…å«è¯é¡¹$q_i$çš„æ–‡æ¡£æ•°ã€‚
* $\text{len}(D)$æ˜¯æ–‡æ¡£$D$çš„é•¿åº¦ã€‚
* $\text{avg\_len}$æ˜¯æ‰€æœ‰æ–‡æ¡£çš„å¹³å‡é•¿åº¦ã€‚
* $k_1$å’Œ$b$æ˜¯è°ƒæ•´å‚æ•°ï¼Œé€šå¸¸è®¾ç½®ä¸º$k_1=1.5$å’Œ$b=0.75$

#### ä»£ç ä½¿ç”¨

åœ¨LangChainä¸­å·²ç»é›†æˆäº†è¯¥æ–¹æ³•ï¼Œæ¨¡å—åå«`BM25Retriever`ã€‚

ç¤ºä¾‹ä½¿ç”¨ä»£ç ï¼š
```python
from typing import (
    List
)
from langchain.schema import Document
import jieba
import jieba.posseg as pseg

# jieba_dictionnaryä¸ºåˆ†è¯å†…éƒ¨è‡ªå¸¦çš„åˆ†è¯æ–‡ä»¶åœ°å€
# jieba_user_dictä¸ºè‡ªå·±å®šä¹‰çš„ç‰¹æ®Šåˆ†è¯è¡¨
def func(text: str) -> List[str]:
    jieba.set_dictionary(jieba_dictionary)
    jieba.load_userdict(jieba_user_dict)

    jieba_list = jieba.lcut(text, cut_all=True)
    words = pseg.cut(text)
    for word, flag in words:
        if flag == "nr":
            jieba_list.append(word)

    return jieba_list

# è¯¥éƒ¨åˆ†ä¸ºé€šè¿‡æ–‡æœ¬åˆ‡åˆ†ä¹‹åçš„chunkå—
texts: List[Document] = [...]
# BM25æ£€ç´¢å™¨ï¼Œè·å–å‰5ä¸ªæœ€ç›¸å…³çš„ç»“æœ
bm25_retriever = BM25Retriever(docs=texts, k=5) 
# BM25æ£€ç´¢å™¨æœ‰é»˜è®¤çš„å‰å¤„ç†åˆ†è¯ç­–ç•¥ï¼Œä½ ä¹Ÿå¯ä»¥å®ç°è‡ªå·±çš„åˆ†è¯ç­–ç•¥ï¼Œè¿™é‡Œæˆ‘ä½¿ç”¨jiebaåˆ†è¯
my_bm25_retriever = BM25Retriever(docs=texts, k=5, preprocess_func=func)
```

å…¶ä¸­è¯æ±‡çš„å†…å®¹é€šå¸¸ç”¨ä»¥ä¸‹æ ¼å¼ï¼š
```txt
# åç§° è¯é¢‘ è¯æ€§ï¼ˆè¯é¢‘è¶Šé«˜ï¼Œä¼˜å…ˆçº§è¶Šé«˜ï¼‰
è‹¹æœ 3 n
iPhone 5 nz
Python 10 n
æ·±åº¦å­¦ä¹  8 n
jieba 5 nr
```
é™¤äº†ä¸Šè¿°çš„æ ¼å¼ï¼Œè¯é¢‘å’Œè¯æ€§éƒ½æ˜¯å¯ä»¥çœç•¥çš„ï¼Œå½“ç„¶ï¼Œæ ‡æ³¨å®Œæ•´æ•ˆæœä¼šæ›´ä½³ã€‚

#### ElasticSearchæ£€ç´¢å™¨

Elasticsearch æ˜¯ä½äº Elastic Stack ä¸­å¿ƒçš„åˆ†å¸ƒå¼æœç´¢å’Œåˆ†æå¼•æ“ã€‚Logstach å’Œ Beats ä¿ƒè¿›é‡‡é›†ã€åˆè®¡ä»¥åŠå……å®ä½ çš„æ•°æ®å¹¶åœ¨ Elasticsearch ä¸­å­˜å‚¨å®ƒä»¬ã€‚Kibana å…è®¸ä½ å»äº¤äº’å¼çš„æ¢ç´¢ã€å¯è§†åŒ–å’Œå…±äº«å¯¹æ•°æ®çš„è§è§£ï¼Œä»¥åŠç›‘è§†è¿™ä¸ªæ ˆï¼ˆElastic Stackï¼‰ã€‚Elasticsearch ä¸ºå„ç§æ•°æ®ç±»å‹æä¾›æ¥è¿‘å®æ—¶çš„æœç´¢å’Œåˆ†æã€‚ä¸è®ºä½ æœ‰ç»“æ„åŒ–æˆ–éç»“æ„åŒ–çš„æ–‡æœ¬ã€æ•°å­—æ•°æ®ï¼Œè¿˜æ˜¯åœ°ç†ç©ºé—´æ•°æ®ï¼ŒElasticsearch èƒ½ä»¥æ”¯æŒå¿«é€Ÿæœç´¢çš„æ–¹å¼é«˜æ•ˆåœ°å­˜å‚¨å’Œç´¢å¼•å®ƒã€‚

Elasticsearché»˜è®¤ä½¿ç”¨BM25ç®—æ³•ä½œä¸ºé»˜è®¤æ£€ç´¢ç®—æ³•ï¼ŒElasticsearchå…è®¸åˆ†å¸ƒå¼éƒ¨ç½²ï¼Œå¯ä»¥éšç€æ•°æ®è§„æ¨¡çš„å¢é•¿è€Œæ— ç¼å¢é•¿ï¼Œæä¾›äº†çµæ´»æ€§ã€‚

* Elasticsearchéƒ¨ç½²ï¼ˆä»¥Linuxç³»ç»Ÿä¸ºä¾‹ï¼‰ï¼š

```bash
curl -L -O https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-7.11.1-linux-x86_64.tar.gz
tar -xvf elasticsearch-7.11.1-linux-x86_64.tar.gz
cd elasticsearch-7.11.1/bin
./elasticsearch
```
*å…¶ä½™ç³»ç»Ÿçš„éƒ¨ç½²æ•™ç¨‹è¯¦ç»†è§[é“¾æ¥ğŸ”—](https://elasticsearch.bookhub.tech/getting_started/install)*

è¿™æ ·å•ä¸ªèŠ‚ç‚¹çš„Elasticsearch é›†ç¾¤å°±å¯åŠ¨å¥½äº†ï¼

* Langchainé›†æˆElasticSearchæ£€ç´¢å™¨ï¼š

```python
import ssl
import openai
from elasticsearch import Elasticsearch
from langchain_community.vectorstores import ElasticsearchStore
from langchain_openai import OpenAIEmbeddings
 
from langchain.text_splitter import CharacterTextSplitter
from langchain_community.document_loaders import TextLoader
 
# è®¾ç½®ä»£ç†è®¿é—® API
os.environ["HTTP_PROXY"] = "http://127.0.0.1:33210"
os.environ["HTTPS_PROXY"] = "http://127.0.0.1:33210"
os.environ["ALL_PROXY"] = "socks5://127.0.0.1:33211"
 
# åŠ è½½æ–‡æ¡£
file_path = 'conf/state_of_the_union.txt'
encoding = 'utf-8'
loader = TextLoader(file_path, encoding=encoding)
documents = loader.load()
 
# æ–‡æ¡£åˆ†å‰²
text_splitter = CharacterTextSplitter(chunk_size=1000, chunk_overlap=0)
docs = text_splitter.split_documents(documents)
 
# è¿æ¥ Elasticsearch
conn = Elasticsearch(
    "https://127.0.0.1:9200",
    ca_certs = "certs/http_ca.crt",
    basic_auth = ("elastic", "changeme"),
    verify_certs=False
)
 
# åˆ›å»ºç´¢å¼•å¹¶è¿›è¡Œæ£€ç´¢
embeddings = OpenAIEmbeddings()
db = ElasticsearchStore.from_documents(docs, embeddings, index_name="test_index", es_connection=conn)
db.client.indices.refresh(index="test_index")
query = "What did the president say about Ketanji Brown Jackson"
results = db.similarity_search(query)
print(results)
```

### æ··åˆæ£€ç´¢

ä¸€ä¸ªç®€å•çš„æƒ³æ³•ï¼Œå°±æ˜¯å°†ä¼ ç»Ÿæœç´¢è¡Œä¸šçš„`å…³é”®è¯æ£€ç´¢`ï¼ˆç¨€ç–æ£€ç´¢ç®—æ³•ï¼‰å’Œæœ€æ–°çš„`è¯­ä¹‰æœç´¢`ï¼Œ`å‘é‡æ£€ç´¢`ç»“åˆèµ·æ¥ï¼Œç”Ÿæˆä¸€ä¸ªæœ€ä¼˜çš„æ£€ç´¢ç»“æœã€‚ä½†æ˜¯ä¸€èˆ¬ä¸é€šè¿‡ç®€å•çš„èåˆæ¥å®ç°ï¼Œè¿™é‡Œå…³é”®çš„æŠ€å·§æ˜¯æ­£ç¡®åœ°ç»“åˆå…·æœ‰ä¸åŒç›¸ä¼¼åº¦å¾—åˆ†çš„æ£€ç´¢ç»“æœâ€”â€”è¿™ä¸ªé—®é¢˜é€šå¸¸é€šè¿‡äº’æƒ æ’åèåˆ(Reciprocal Rank Fusion, RRF)ç®—æ³•è§£å†³ã€‚æœ€ç»ˆçš„å®ç°æ–¹å¼å¦‚å›¾æ‰€ç¤ºï¼š

![](https://blog-1311257248.cos.ap-nanjing.myqcloud.com/imgs/rag/img13.jpg)

åœ¨Langchainä¸­ï¼Œè¿™æ˜¯åœ¨`Ensemble Retriever`ç±»ä¸­å®ç°çš„ï¼Œå®ƒç»“åˆäº†ç”¨æˆ·å®šä¹‰çš„ä¸€ç³»åˆ—æ£€ç´¢å™¨ï¼Œä¾‹å¦‚åŸºäºfaissçš„å‘é‡ç´¢å¼•å’ŒåŸºäºBM25çš„æ£€ç´¢å™¨ï¼Œå¹¶ä½¿ç”¨RRFè¿›è¡Œé‡æ–°æ’åºã€‚

ç¤ºä¾‹demo:
```python
from langchain.retrievers import EnsembleRetriever
from langchain_community.retrievers import BM25Retriever
from langchain_community.vectorstores import FAISS
from langchain_openai import OpenAIEmbeddings

doc_list_1 = [
    "I like apples",
    "I like oranges",
    "Apples and oranges are fruits",
]

# initialize the bm25 retriever and faiss retriever
bm25_retriever = BM25Retriever.from_texts(
    doc_list_1, metadatas=[{"source": 1}] * len(doc_list_1)
)
bm25_retriever.k = 2

doc_list_2 = [
    "You like apples",
    "You like oranges",
]

embedding = OpenAIEmbeddings()
faiss_vectorstore = FAISS.from_texts(
    doc_list_2, embedding, metadatas=[{"source": 2}] * len(doc_list_2)
)
faiss_retriever = faiss_vectorstore.as_retriever(search_kwargs={"k": 2})

# initialize the ensemble retriever
ensemble_retriever = EnsembleRetriever(
    retrievers=[bm25_retriever, faiss_retriever], weights=[0.5, 0.5]
)
```

ä½†åœ¨å®é™…çš„æ£€ç´¢è¿‡ç¨‹ä¸­ï¼Œè¿™ç§åˆå¹¶çš„è¿‡ç¨‹å¹¶ä¸æ€»æ˜¯ç†æƒ³ã€‚ä¸¾ä¸€ä¸ªè‡ªå·±åœ¨åšRAGçš„ä¸€ä¸ªä¾‹å­ï¼Œä¸‹å›¾æ˜¯è‡ªå·±åšçš„äº§å“åº“çš„ä¿¡æ¯æ£€ç´¢æ–¹æ¡ˆï¼š

![](https://blog-1311257248.cos.ap-nanjing.myqcloud.com/imgs/rag/img14.jpg)

å› ä¸ºå¹¶ä¸èƒ½ç®€å•é€šè¿‡æƒé‡æ¥è¯„åˆ¤ä¸åŒçš„æ£€ç´¢å™¨çš„å¥½åã€‚æˆ‘ä¸ªäººçš„åšæ³•æ˜¯é€šè¿‡reranker Modelï¼ˆä¸‹é¢ä¼šè®²åˆ°ï¼‰å…ˆå¯¹ä¸åŒçš„æ£€ç´¢ç»“æœè¿›è¡Œæ’åºï¼Œç„¶åè¿›è¡Œåˆå¹¶å»é‡ï¼Œæœ€åå–`top_n`çš„æ£€ç´¢ç»“æœã€‚**å°†rerankeræ¨¡å‹å‰ç½®çš„å¥½å¤„æ˜¯ï¼Œåœ¨å„è‡ªçš„æ£€ç´¢å™¨æ£€ç´¢åˆ°çš„å†…å®¹ï¼Œå…¶ç›¸ä¼¼åº¦å¾—åˆ†å¹¶ä¸ä¸€å®šå‡†ç¡®ï¼Œå¯ä»¥å‡å°‘å¤šæ£€ç´¢å™¨åœ¨RRFæ’åºè¿‡ç¨‹çš„å…³é”®æ£€ç´¢ä¿¡æ¯æŸå¤±ã€‚**

åˆå¹¶å’Œå»é‡æ£€ç´¢ç»“æœçš„ä½ç½®æ’å¸ƒå˜å¾—å¾ˆé‡è¦ï¼Œä¸€èˆ¬ä¼šæœ‰ä¸¤ç§æ’å¸ƒæ–¹å¼ï¼š

* æŒ‰ç…§å„è‡ªçš„æ’åºç»“æœäº¤æ›¿æ’åºå¹¶è¿›è¡Œå»é‡ï¼š

![](https://blog-1311257248.cos.ap-nanjing.myqcloud.com/imgs/rag/img15.jpg)

è¿™ç§æ–¹å¼å°†ä¸åŒæ£€ç´¢å™¨å¾—åˆ°çš„ç»“æœäº¤æ›¿è¿›è¡Œæ’åºï¼Œæ¯æ¬¡å°†ç»“æœå‹å…¥æ˜¯éœ€è¦å…ˆåˆ¤æ–­æ˜¯å¦å­˜åœ¨ã€‚

* æŒ‰ç…§å„è‡ªçš„æ’åºç»“æœå¤´å°¾æ’åºå¹¶è¿›è¡Œå»é‡ï¼š

![](https://blog-1311257248.cos.ap-nanjing.myqcloud.com/imgs/rag/img16.jpg)

è¿™ç§æ–¹å¼æ˜¯å°†ä¸åŒçš„ç»“æœåˆ†åˆ«æ”¾åœ¨å¤´å’Œå°¾ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯å°¾éƒ¨çš„é¡ºåºéœ€è¦å€’è¿‡æ¥ã€‚è¿™ç§åšæ³•æ˜¯æ ¹æ®å¤§æ¨¡å‹å¯¹è¾ƒé•¿çš„æ–‡æœ¬ä¸­å¤´å’Œå°¾çš„ä¿¡æ¯æ›´åŠ æ•æ„Ÿçš„ç‰¹ç‚¹ï¼Œæ‰€ä»¥è¿™ç§æ–¹æ³•ä¸€èˆ¬é’ˆå¯¹æ£€ç´¢ç»“æœè¾ƒå¤šä»¥åŠæœ€ç»ˆçš„æ–‡æœ¬è¾ƒé•¿çš„æƒ…å†µã€‚

## é‡æ’åºå’Œè¿‡æ»¤

é‡æ’åºæ˜¯æŒ‡é€šè¿‡ä¸€ä¸ª`reranker`æ¨¡å‹å¯¹æœ€ç»ˆæ£€ç´¢åˆ°çš„ç»“æœé‡æ–°è¿›è¡Œæ’åºï¼Œè¿‡æ»¤åˆ™æ˜¯é€šè¿‡ä¸€äº›æ˜æ˜¾çš„ä¸šåŠ¡å±æ€§æ¥è¿‡æ»¤æ˜æ˜¾é”™è¯¯çš„ç»“æœï¼Œæˆ–è€…é€šè¿‡`metadata`ä¸­çš„ä¸€äº›ä¿¡æ¯è¿›è¡Œæ’åºï¼Œè¿‡æ»¤ï¼Œå¢åŠ ï¼Œåˆ å‡ç­‰ä¸€ç³»åˆ—æ“ä½œï¼Œè¿™ä¸ªä¸»è¦çœ‹ä¸šåŠ¡çš„å±æ€§æ¥å†³å®šã€‚

## æŸ¥è¯¢è½¬æ¢

æŸ¥è¯¢è½¬æ¢æ˜¯ä¸€ç³»åˆ—æŠ€æœ¯çš„æ€»ç§°ï¼Œä½¿ç”¨**LLMä½œä¸ºæ¨ç†å¼•æ“**æ¥ä¿®æ”¹ç”¨æˆ·è¾“å…¥ï¼Œä»¥æé«˜æ£€ç´¢è´¨é‡ã€‚æœ‰å‡ ç§ä¸åŒçš„æ–¹æ³•å¯ä»¥åšåˆ°è¿™ä¸€ç‚¹ã€‚

![](https://blog-1311257248.cos.ap-nanjing.myqcloud.com/imgs/rag/img17.jpg)

æŸ¥è¯¢è½¬æ¢æœ‰å‡ ç§æ–¹å¼ï¼š

* ä¸€ç§æ˜¯é€šè¿‡æ ¹æ®æé—®çš„é—®é¢˜è½¬åŒ–ä¸ºæ›´åŠ é€šç”¨çš„ä¸»é¢˜çš„æ–¹å¼æ¥é™ä½æ£€ç´¢çš„éš¾åº¦ã€‚ä¾‹å¦‚ï¼Œæˆ‘åœ¨é—®åŠç†æŸä¸ªäº§å“çš„éœ€è¦å¤šå°‘é’±ï¼Ÿé€šå¸¸çš„åšæ³•æ˜¯è®©LLMå°†å…¶è½¬åŒ–ä¸ºå¸¦å…³é”®è¯çš„æ›´åŠ é«˜æ•ˆçš„æ£€ç´¢ã€‚

```python
# è¿™é‡Œçš„èµ„è´¹é€šå¸¸çŸ¥è¯†åº“å¸¸ç”¨çš„å…³é”®è¯
åŠç†<æŸäº§å“>çš„éœ€è¦å¤šå°‘é’±ï¼Ÿ --> <æŸäº§å“>çš„èµ„è´¹
```

* å¦ä¸€ç§æŸ¥è¯¢è½¬æ¢åˆ™æ˜¯å°†å¤æ‚çš„æŸ¥è¯¢åˆ†è§£ä¸ºå­æŸ¥è¯¢ã€‚ä¾‹å¦‚ï¼Œå¦‚æœç”¨æˆ·é—®ï¼šâ€œåœ¨Githubä¸Šï¼ŒLangchainå’ŒLlamaIndexå“ªä¸ªæ›´ä¼˜ç§€ï¼Ÿâ€ï¼Œè€Œæˆ‘ä»¬ä¸å¤ªå¯èƒ½åœ¨è¯­æ–™åº“ä¸­çš„æŸäº›æ–‡æœ¬ä¸­æ‰¾åˆ°ç›´æ¥çš„æ¯”è¾ƒï¼Œæ‰€ä»¥å°†è¿™ä¸ªé—®é¢˜åˆ†è§£ä¸ºä¸¤ä¸ªå­æŸ¥è¯¢æ˜¯æœ‰æ„ä¹‰çš„ï¼Œå‡è®¾æ›´ç®€å•ã€æ›´å…·ä½“çš„ä¿¡æ¯æ£€ç´¢ï¼šâ€œLangchainåœ¨Githubä¸Šæœ‰å¤šå°‘æ˜Ÿæ˜Ÿï¼Ÿâ€â€œLlamaindexåœ¨Githubä¸Šæœ‰å¤šå°‘æ˜Ÿæ˜Ÿï¼Ÿâ€å®ƒä»¬å°†å¹¶è¡Œæ‰§è¡Œï¼Œç„¶åå°†æ£€ç´¢åˆ°çš„ä¸Šä¸‹æ–‡åˆå¹¶åˆ°ä¸€ä¸ªæç¤ºä¸­ï¼Œä¾›LLMåˆæˆå¯¹åˆå§‹æŸ¥è¯¢çš„æœ€ç»ˆç­”æ¡ˆã€‚è¿™ä¸¤ä¸ªåº“éƒ½å®ç°äº†è¿™ä¸ªåŠŸèƒ½â€”â€”åœ¨Langchainä¸­ä½œä¸ºå¤šæŸ¥è¯¢æ£€ç´¢å™¨(Multi Query Retriever)ï¼Œåœ¨Llamaindexä¸­ä½œä¸ºå­é—®é¢˜æŸ¥è¯¢å¼•æ“(Sub Question Query Engine)ã€‚

Langchain demo:
```python
from langchain.retrievers.multi_query import MultiQueryRetriever
from langchain_openai import ChatOpenAI

question = "What are the approaches to Task Decomposition?"
llm = ChatOpenAI(temperature=0)
retriever_from_llm = MultiQueryRetriever.from_llm(
    retriever=vectordb.as_retriever(), llm=llm
)
```

* å›é€€æç¤º(Step-back prompting)ä½¿ç”¨LLMç”Ÿæˆä¸€ä¸ªæ›´æ™®é€‚çš„æŸ¥è¯¢ï¼Œæ£€ç´¢å®ƒæˆ‘ä»¬è·å¾—ä¸€ä¸ªæ›´æ™®é€‚æˆ–æ›´é«˜å±‚æ¬¡çš„ä¸Šä¸‹æ–‡è¯­å¢ƒï¼Œæœ‰åŠ©äºæ”¯æ’‘åˆå§‹æŸ¥è¯¢çš„ç­”æ¡ˆã€‚åˆå§‹æŸ¥è¯¢çš„æ£€ç´¢åŒæ—¶è¢«æ‰§è¡Œï¼Œä¸¤ä¸ªä¸Šä¸‹æ–‡éƒ½è¢«æäº¤åˆ°LLMä»¥ä¾¿åœ¨æœ€åä¸€æ­¥ç”Ÿæˆç­”æ¡ˆã€‚

## ç”Ÿæˆåé¦ˆå¾ªç¯ï¼ˆGenerative Feedback Loop in RAGï¼‰

RAGä¸­çš„ç”Ÿæˆåé¦ˆå¾ªç¯æ˜¯åŸºäºRAGç³»ç»Ÿçš„å¤§æ¨¡å‹å›ç­”**ç”Ÿæˆä¸€ç³»åˆ—çš„è®°å¿†ä»¥åŠä¸€äº›QAå›ç­”ä¿¡æ¯**ï¼Œå°†è¿™äº›ä¿¡æ¯ä¸æ–­åœ°å­˜å‚¨è¿›å‘é‡æ•°æ®åº“ä¸­ï¼Œæ¥å¢å¼ºRAGç³»ç»Ÿå›ç­”çš„è´¨é‡ã€‚

å¸¸è§„çš„RAGé“¾è·¯å¦‚ä¸‹ï¼š
![](https://blog-1311257248.cos.ap-nanjing.myqcloud.com/imgs/rag/img27.jpg)

å¸¸è§„çš„RAGåœ¨LLMå’Œå‘é‡æ•°æ®åº“ä¹‹é—´å¹¶æ²¡æœ‰äº¤äº’ï¼Œè€Œç”Ÿæˆåé¦ˆå¾ªç¯å®é™…ä¸Šæ˜¯å¢å¼ºäº†ä¸¤è€…çš„è”ç³»ã€‚åŸºæœ¬çš„æµç¨‹æ˜¯LLMäº§ç”Ÿçš„è¾“å‡ºï¼Œä¼šè¢«åé¦ˆåˆ°RAGç³»ç»Ÿä¸­ï¼Œä¹Ÿå°±æ˜¯å°†é—®é¢˜å’Œç”Ÿæˆçš„ç­”æ¡ˆçš„å†…å®¹åŠ å…¥åˆ°æ–°çš„å‘é‡æ•°æ®åº“ä¸­ï¼Œç¨å€™è¿›è¡Œä½¿ç”¨ã€‚

å¢åŠ äº†ç”Ÿæˆåé¦ˆå¾ªç¯çš„RAGé“¾è·¯å¦‚ä¸‹ï¼š
![](https://blog-1311257248.cos.ap-nanjing.myqcloud.com/imgs/rag/img28.jpg)

* ç”Ÿæˆåé¦ˆå¾ªç¯çš„ä¼˜åŠ¿ï¼š

1ã€è¯¥å¾ªç¯å°†æ–°çš„æ•°æ®è¾“å…¥å’Œäº¤äº’çº³å…¥è®­ç»ƒæ•°æ®ä¸­ã€‚

2ã€è¿™å…è®¸æ¨¡å‹é€‚åº”ä¸æ–­å˜åŒ–çš„æ¨¡å¼å’Œè¶‹åŠ¿ï¼Œæé«˜æœªæ¥äº§å‡ºçš„ç›¸å…³æ€§å’Œå‡†ç¡®æ€§ã€‚

3ã€ä¼šäº§ç”Ÿéƒ¨åˆ†çš„ç”¨æˆ·ä¸ªæ€§åŒ–å®šåˆ¶å›ç­”ã€‚

è¿™éƒ¨åˆ†æ–°äº§ç”Ÿçš„QAæ•°æ®å¯ä»¥ä¸å¸¸è§„çŸ¥è¯†åº“åˆ†å¼€ä¿å­˜ï¼Œå®ƒç±»ä¼¼äºä¸€ä¸ªcacheï¼Œç”¨æˆ·åœ¨è¾“å…¥é—®é¢˜åï¼Œå¯ä»¥åœ¨è¿™éƒ¨åˆ†é¢å¤–QAåº“å…ˆè¿›è¡Œæœç´¢ã€‚è¿™å°†ä¼šé™ä½ä¸€éƒ¨åˆ†å¼€é”€ï¼Œå› ä¸ºé¢å¤–çš„QAåº“è§„æ¨¡è¿œå°äºå¸¸è§„çš„çŸ¥è¯†åº“ã€‚

4ã€å¦‚æœåœ¨è¿”å›çš„æ¨¡å—ä¸­ï¼ŒåŠ å…¥äººç±»çš„åé¦ˆï¼Œæˆ–è€…LLMçš„è¯„ä¼°åé¦ˆï¼ŒåŸºäºè¯„ä¼°ï¼Œæœ‰é€‰æ‹©æ€§åœ°å¢åŠ é¢å¤–QAåº“ï¼Œè¿™æ ·å¯ä»¥**å‡å°‘åˆå§‹æ•°æ®çš„åè§å’Œé”™è¯¯**ã€‚

* ç”Ÿæˆåé¦ˆå¾ªç¯çš„ä¾‹å­ï¼š

**æ­¥éª¤ä¸€**ï¼šç”¨æˆ·æé—®ï¼Œæœç´¢å…ˆå‰ç”Ÿæˆçš„é¢å¤–çš„QAé—®ç­”åº“ï¼Œç„¶ååŒæ­¥æœç´¢çŸ¥è¯†åº“ï¼Œå¦‚æœæ²¡æœ‰æœç´¢åˆ°ç›¸å…³å†…å®¹ï¼Œåˆ™å»çŸ¥è¯†åº“å»æœç´¢å¾—åˆ°ç»“æœã€‚

**æ­¥éª¤äºŒ**ï¼šè¾ƒä¸ºå¼ºå¤§çš„LLMä¼šç”Ÿæˆç›¸åº”çš„QAå›ç­”å†…å®¹ï¼ŒRAGç³»ç»Ÿä¼šå°†å®ƒå­˜å‚¨ä¸‹æ¥ï¼Œå¹¶è¿›å…¥å‘é‡æ•°æ®åº“ã€‚

![](https://blog-1311257248.cos.ap-nanjing.myqcloud.com/imgs/rag/img29.jpg)

**æ­¥éª¤ä¸‰**ï¼šå¦‚æœå½“å‰æé—®çš„é—®é¢˜å’Œä¹‹å‰çš„QAåº“ä¸­é—®é¢˜ç›¸åŒæˆ–è€…ç›¸ä¼¼ï¼Œè¿™æ—¶å€™å¯ä»¥ä½¿ç”¨ä¸€ä¸ªå°çš„LLMæ ¹æ®ç»™å®šçš„å†å²QAå›ç­”è¿›è¡Œè°ƒæ•´åšå‡ºå“åº”ã€‚å¯¹åº”çš„ç›¸åº”æ—¶é—´ä¼šå‡å°‘ï¼Œç›¸åº”çš„å†…å®¹è´¨é‡ä¹Ÿä¸å¼ºå¤§çš„LLMç›¸å½“ï¼Œå› ä¸ºå®ƒä½¿ç”¨äº†å¼ºå¤§çš„LLMé—ç•™ä¸‹çš„çŸ¥è¯†ã€‚ï¼ˆè¿™ä¸ç¼“å­˜éå¸¸ç›¸ä¼¼ï¼Œç”šè‡³å¦‚æœé—®é¢˜å®Œå…¨ç›¸åŒï¼Œå¯ä»¥å¿½ç•¥æœç´¢è¿™ä¸ªæ­¥éª¤ï¼Œç›´æ¥å–å›ç­”æ¡ˆã€‚ï¼‰

![](https://blog-1311257248.cos.ap-nanjing.myqcloud.com/imgs/rag/img30.jpg)


## å‚è€ƒå¼•ç”¨

å¦‚æœç”¨æˆ·ä½¿ç”¨å¤šä¸ªæ£€ç´¢æ¥æºç”Ÿæˆç­”æ¡ˆï¼Œæ— è®ºæ˜¯å› ä¸ºåˆå§‹æŸ¥è¯¢çš„å¤æ‚æ€§ï¼ˆç”¨æˆ·ä¸å¾—ä¸æ‰§è¡Œå¤šä¸ªå­æŸ¥è¯¢ï¼Œç„¶åå°†æ£€ç´¢åˆ°çš„ä¸Šä¸‹æ–‡åˆå¹¶ä¸ºä¸€ä¸ªç­”æ¡ˆï¼‰ï¼Œè¿˜æ˜¯å› ä¸ºåœ¨ä¸åŒæ–‡æ¡£ä¸­æ‰¾åˆ°äº†æŸä¸ªæŸ¥è¯¢çš„ç›¸å…³ä¸Šä¸‹æ–‡ï¼Œé‚£ä¹ˆå°±ä¼šå‡ºç°ä¸€ä¸ªé—®é¢˜ï¼Œå³Generatoræ˜¯å¦èƒ½å‡†ç¡®åœ°æ˜¾ç¤ºæ‰€ä½¿ç”¨çš„å¼•ç”¨æ¥æºã€‚

æœ‰å‡ ç§æ–¹æ³•å¯ä»¥åšåˆ°è¿™ä¸€ç‚¹ï¼š

1ã€å°†è¿™ä¸ª**æ˜¾ç¤ºå¼•ç”¨æºçš„ä»»åŠ¡æ’å…¥åˆ°promptä¸­**ï¼Œè¦æ±‚LLMè¯´æ˜æ‰€ä½¿ç”¨çš„å¼•ç”¨æºç¼–å·ã€‚

ä¾‹å­ï¼š 
```python
prompt = """
...
[
    retrieve_results_1, source: A
    retrieve_results_2, source: B
]
...
è¯·ä½ è¯´æ˜ä½ çš„å›ç­”ä½¿ç”¨äº†å“ªäº›æ£€ç´¢ç»“æœï¼Œæ ‡æ³¨å‡ºç›¸åº”çš„å¼•ç”¨æºã€‚
"""
```

2ã€å°†ç”Ÿæˆçš„ç­”æ¡ˆéƒ¨åˆ†ä¸ç´¢å¼•ä¸­çš„åŸå§‹æ–‡æœ¬å—åŒ¹é…â€”â€”LlamaIndexä¸ºè¿™ç§æƒ…å†µæä¾›äº†ä¸€ç§é«˜æ•ˆçš„æ¨¡ç³ŠåŒ¹é…è§£å†³æ–¹æ¡ˆ(fuzzy matching based solution)(æ¨¡ç³ŠåŒ¹é…(fuzzy matching)æ˜¯ä¸€ç§éå¸¸å¼ºå¤§çš„å­—ç¬¦ä¸²åŒ¹é…æŠ€æœ¯)ã€‚

**è¿™ç§æ–¹æ³•æ˜¯é€šè¿‡ç®—æ³•æ¥è§£å†³æ–‡æœ¬å—ä½¿ç”¨çš„é—®é¢˜ã€‚**

ä¸Šè¿°ä¸¤ç§æ–¹æ³•å„æœ‰ä¼˜åŠ£ï¼Œéœ€è¦æ ¹æ®å®é™…æƒ…å†µè¿›è¡Œçµæ´»é€‰æ‹©ã€‚


## èŠå¤©å¼•æ“ï¼ˆå¤šè½®å¯¹è¯ï¼‰

å•ä½“çš„RAGæµç¨‹ä»…ä»…æ˜¯é’ˆå¯¹å•æ¬¡é—®ç­”çš„æƒ…å†µï¼Œå¹¶ä¸ä¼šè€ƒè™‘ä¸Šä¸‹æ–‡ã€‚å¦‚æœè¦æ„å»ºå¤šæ¬¡é—®ç­”çš„RAGç³»ç»Ÿï¼Œåˆ™éœ€è¦æ”¯æŒå†å²å¯¹è¯ï¼Œä½†æ˜¯å¤šè½®å†å²å¯¹è¯å¾€å¾€ä¼šå¾ˆé•¿ï¼Œè€Œå¤§æ¨¡å‹æ”¯æŒçš„tokenæ•°æ¯”è¾ƒæœ‰é™ã€‚

è¦æ„å»ºä¸€ä¸ªèƒ½å¤Ÿå¯¹å•ä¸ªæŸ¥è¯¢å¤šæ¬¡æ‰§è¡Œæ“ä½œçš„é«˜æ•ˆRAGç³»ç»Ÿï¼Œä¸‹ä¸€ä¸ªé‡è¦æ­¥éª¤æ˜¯å®ç°èŠå¤©é€»è¾‘ï¼Œè¿™ä¸ç»å…¸èŠå¤©æœºå™¨äººåœ¨LLMæ—¶ä»£ä¹‹å‰å¤„ç†å¯¹è¯ä¸Šä¸‹æ–‡çš„æ–¹å¼ç±»ä¼¼ã€‚é‡‡ç”¨è¿™ç§æ–¹å¼æ˜¯ä¸ºäº†**æ”¯æŒåç»­é—®é¢˜ã€æŒ‡ä»£è§£ææˆ–ä¸ä¹‹å‰å¯¹è¯ä¸Šä¸‹æ–‡ç›¸å…³çš„ä»»ä½•ç”¨æˆ·æŒ‡ä»¤**ã€‚è§£å†³è¿™ä¸€é—®é¢˜çš„æ–¹æ³•æ˜¯é€šè¿‡**æŸ¥è¯¢å‹ç¼©(query compression)æŠ€æœ¯**ï¼ŒåŒæ—¶è€ƒè™‘èŠå¤©ä¸Šä¸‹æ–‡å’Œç”¨æˆ·æŸ¥è¯¢ã€‚

åœ¨ä¸Šä¸‹æ–‡å‹ç¼©æ–¹é¢ï¼Œæœ‰å‡ ç§æ–¹æ³•å¯ä¾›é€‰æ‹©ï¼š

* ä¸€ç§æ¯”è¾ƒæµè¡Œä¸”ç›¸å¯¹ç®€å•çš„æ–¹æ³•æ˜¯ä½¿ç”¨`ContextChatEngine`ï¼Œå®ƒ**é¦–å…ˆæ£€ç´¢ä¸ç”¨æˆ·æŸ¥è¯¢ç›¸å…³çš„ä¸Šä¸‹æ–‡ï¼Œç„¶åå°†å…¶è¿åŒèŠå¤©å†å²è®°å½•ä»å†…å­˜ç¼“å†²åŒºå–å‡ºå‘é€ç»™LLM**ï¼Œä»¥ä¾¿LLMåœ¨ç”Ÿæˆä¸‹ä¸€ä¸ªç­”æ¡ˆæ—¶èƒ½å¤Ÿäº†è§£ä¹‹å‰çš„ä¸Šä¸‹æ–‡ã€‚
* å¦ä¸€ç§ç›¸å¯¹å¤æ‚çš„æƒ…å†µæ˜¯`CondensePlusContextMode`ï¼Œåœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼Œ**æ¯æ¬¡äº¤äº’ä¸­çš„èŠå¤©è®°å½•å’Œæœ€åä¸€æ¡æ¶ˆæ¯è¢«å‹ç¼©æˆä¸€ä¸ªæ–°çš„æŸ¥è¯¢ï¼Œç„¶åè¿™ä¸ªæŸ¥è¯¢è¢«å‘é€åˆ°ç´¢å¼•é‡Œ**ï¼Œå¹¶æŠŠæ£€ç´¢åˆ°çš„ä¸Šä¸‹æ–‡è¿åŒåŸå§‹ç”¨æˆ·æ¶ˆæ¯ä¸€èµ·ä¼ é€’ç»™LLMä»¥ç”Ÿæˆç­”æ¡ˆã€‚è¿™ç§æŠ€æœ¯éœ€è¦LLMå°†æœ€è¿‘å‡ æ¡çš„èŠå¤©è®°å½•å’Œæœ€æ–°çš„ä¸€æ¡æ¶ˆæ¯è¿›è¡Œå‹ç¼©ï¼Œä¿è¯æ•´ä½“çš„è¯­ä¹‰ä¸ç”¨æˆ·çš„çœŸå®æ„å›¾ç›¸åŒã€‚

åœ¨å®é™…çš„ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œ`ContextChatEngine`å¾€å¾€æ˜¯ä¸workçš„ï¼Œå› ä¸ºä½ æ— æ³•ä¿è¯ç”¨æˆ·åœ¨è¾“å…¥é—®é¢˜æ—¶ä½¿ç”¨ä¹¦é¢åŒ–çš„é—®æ³•ï¼Œ**å¤§éƒ¨åˆ†å£è¯­åŒ–çš„é—®ç­”æ–¹å¼ï¼Œå…³é”®ä¿¡æ¯ä¼šä¿ç•™åœ¨ä¸Šä¸€æ¬¡é—®é¢˜ä¸­ï¼Œè€Œåœ¨æœ¬æ¬¡æé—®ä¸­ä»…ä»…è¿›è¡Œè¿½é—®ã€‚åœ¨æœ¬æ¬¡çš„æŸ¥è¯¢ä¸­ç¼ºå°‘å…³é”®ä¿¡æ¯ï¼Œæ£€ç´¢æ•ˆæœå¾€å¾€ä¸ä½³ã€‚**

![](https://blog-1311257248.cos.ap-nanjing.myqcloud.com/imgs/rag/img18.jpg)

èŠå¤©å¼•æ“æ˜¯RAGç³»ç»Ÿä¸­çš„ä¸€ä¸ªå…³é”®ç»„ä»¶ï¼Œå®ƒä¸ä»…å¤„ç†ç”¨æˆ·çš„ç›´æ¥æŸ¥è¯¢ï¼Œè¿˜èƒ½å¤Ÿç†è§£å’Œå“åº”ä¸ä¹‹å‰å¯¹è¯ä¸Šä¸‹æ–‡ç›¸å…³çš„å†…å®¹ã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼ŒRAGç³»ç»Ÿèƒ½å¤Ÿæä¾›æ›´è¿è´¯ã€æ›´è‡ªç„¶çš„å¯¹è¯ä½“éªŒã€‚

## æŸ¥è¯¢è·¯ç”±

æŸ¥è¯¢è·¯ç”±æ˜¯æŒ‡é’ˆå¯¹ç”¨æˆ·çš„æŸ¥è¯¢ï¼Œç”±LLMæ¥å†³å®šä¸‹ä¸€æ­¥æ“ä½œçš„å†³ç­–æ­¥éª¤ã€‚é€šå¸¸çš„é€‰æ‹©åŒ…æ‹¬æ€»ç»“ä¿¡æ¯ã€å¯¹æŸäº›æ•°æ®ç´¢å¼•è¿›è¡Œæœç´¢ï¼Œæˆ–å°è¯•å¤šç§ä¸åŒçš„è·¯å¾„å¹¶å°†å®ƒä»¬çš„è¾“å‡ºåˆæˆä¸ºå”¯ä¸€çš„ç­”æ¡ˆã€‚å®ç°æ–¹å¼ä¾¿æ˜¯`Agentæ™ºèƒ½ä½“`ã€‚

**æŸ¥è¯¢è·¯ç”±å™¨**(Query Routers)è¿˜ç”¨äºé€‰æ‹©ç´¢å¼•ï¼Œæˆ–è€…æ›´é€šä¿—åœ°è¯´æ˜¯é€‰æ‹©æ‰§è¡Œç”¨æˆ·æŸ¥è¯¢å‘½ä»¤çš„æ•°æ®æºã€‚æ— è®ºæ˜¯æ‹¥æœ‰å¤šä¸ªæ•°æ®æºï¼ˆæ¯”å¦‚ç»å…¸çš„å‘é‡å­˜å‚¨ã€å›¾å½¢æ•°æ®åº“æˆ–å…³ç³»æ•°æ®åº“ï¼‰ï¼Œè¿˜æ˜¯æ‹¥æœ‰å¤šå±‚ç´¢å¼•ç»“æ„ï¼ˆæ¯”å¦‚å¤„ç†åœ¨å¤šæ–‡æ¡£å­˜å‚¨çš„æ—¶å€™ï¼Œä¸€ä¸ªå…¸å‹çš„ç´¢å¼•åˆ›å»ºæ–¹æ¡ˆå¾ˆå¯èƒ½æ˜¯ä¸€ä¸ªç”±æ‘˜è¦ç»„æˆçš„ç´¢å¼•å’Œå¦ä¸€ä¸ªç”±æ–‡æ¡£å—å‘é‡ç»„æˆçš„ç´¢å¼•ï¼‰ï¼Œéƒ½éœ€è¦è¿›è¡ŒæŸ¥è¯¢è·¯å¾„é€‰æ‹©ã€‚

å…¶ä¸­æ‰€æœ‰çš„æŸ¥è¯¢é€‰æ‹©ï¼Œç»“æœåˆ¤æ–­ï¼Œéƒ½éœ€è¦å¤§æ¨¡å‹è‡ªå·±åˆ¤æ–­ï¼Œè€Œä¸æ˜¯äººå·¥å®šåˆ¶å¥½ä¸€ä¸ªè·¯å¾„ã€‚

### å¤šæ–‡æ¡£æ™ºèƒ½ä½“æ–¹æ¡ˆ


> Agentsçš„æ¦‚å¿µï¼šä¸€ä¸ªèƒ½å¤Ÿè¿›è¡Œæ¨ç†ã€æä¾›ä¸€ç³»åˆ—å·¥å…·å’Œä¸€ä¸ªå®Œæˆç‰¹å®šä»»åŠ¡çš„LLM

æ™ºèƒ½ä½“æä¾›çš„å·¥å…·å¯èƒ½åŒ…æ‹¬å¦‚å„ç§è¯­è¨€ä»£ç åŠŸèƒ½ï¼Œå„ç§å¤–éƒ¨APIï¼Œç”šè‡³å„ç§å…¶ä»–æ™ºèƒ½ä½“â€”â€”è¿™ç§LLMé“¾å¼çš„æƒ³æ³•æ˜¯LangChainåå­—çš„ç”±æ¥ã€‚ç›®å‰å¸‚é¢ä¸Šçš„å¤§æ¨¡å‹éƒ½é€‚é…äº†å·¥å…·è°ƒç”¨èƒ½åŠ›ï¼Œä¹Ÿå°±æ˜¯å°†è¯­è¨€æ–‡æœ¬è½¬åŒ–ä¸ºä½¿ç”¨APIè°ƒç”¨å¤–éƒ¨å·¥å…·æˆ–æ•°æ®åº“æŸ¥è¯¢çš„èƒ½åŠ›ã€‚

![](https://blog-1311257248.cos.ap-nanjing.myqcloud.com/imgs/rag/img19.jpg)

ä¸Šè¿°å›¾ç‰‡ä¸­çš„`å¤šæ–‡æ¡£æ™ºèƒ½ä½“`çš„æ–¹æ¡ˆï¼Œå°†å¤šä¸ªæ–‡æ¡£æ£€ç´¢çš„æ–¹å¼éƒ½åˆ¶ä½œä¸ºæ™ºèƒ½ä½“ï¼Œæ¯ä¸ªæ™ºèƒ½ä½“éƒ½èƒ½è‡ªè¡Œåˆ¤æ–­éœ€è¦è¿›è¡Œå“ªäº›å­æŸ¥è¯¢ï¼Œè‡ªè¡Œå†³å®šæŸ¥è¯¢å®Œäº†ä¹‹åéœ€è¦ä½¿ç”¨å“ªä¸ªæŸ¥è¯¢å‡ºæ¥çš„ç»“æœã€‚é¡¶å±‚çš„æ™ºèƒ½ä½“åˆ™å•çº¯ä½¿ç”¨è·¯ç”±çš„èƒ½åŠ›ï¼Œæ¥é€‰æ‹©ä½¿ç”¨å“ªäº›æŸ¥è¯¢æ™ºèƒ½ä½“ã€‚

è¿™ç§å¤æ‚æ–¹æ¡ˆçš„ç¼ºç‚¹åŸºæœ¬å¯ä»¥ä»ä¸Šå›¾ä¸­æ¨æµ‹å‡ºæ¥â€”â€”ç”±äºæ¶‰åŠæ™ºèƒ½ä½“å†…éƒ¨çš„å¤šæ¬¡LLMè¿­ä»£ï¼Œæ‰€ä»¥æ‰§è¡Œæ•ˆç‡æ¯”è¾ƒä½ä¸‹ã€‚**éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒLLMè°ƒç”¨æ€»æ˜¯RAGç®¡é“ä¸­æœ€è´¹æ—¶çš„æ“ä½œ**ã€‚å› æ­¤ï¼Œå¯¹äºå¤§å‹å¤šæ–‡æ¡£å­˜å‚¨ï¼Œå»ºè®®è€ƒè™‘å¯¹è¿™ä¸ªæ–¹æ¡ˆè¿›è¡Œä¸€äº›ç®€åŒ–ï¼Œä»¥ä¾¿æé«˜å…¶å¯æ‰©å±•æ€§ã€‚æœ€ç®€å•çš„æ–¹æ³•å°±æ˜¯å°†æ‰€æœ‰çš„æ–‡æ¡£æ™ºèƒ½ä½“ä½¿ç”¨ä¸€å¥—é€šç”¨çš„å›ºå®šæŸ¥è¯¢è·¯å¾„ã€‚

## å“åº”åˆæˆå™¨

è¿™æ˜¯æ¯ä¸ªRAGç®¡é“çš„æœ€åä¸€æ­¥â€”â€”åŸºäºç”¨æˆ·ç²¾å¿ƒæ£€ç´¢åˆ°çš„æ‰€æœ‰ä¸Šä¸‹æ–‡å’Œåˆå§‹ç”¨æˆ·æŸ¥è¯¢ç”Ÿæˆç­”æ¡ˆã€‚æœ€ç®€å•çš„æ–¹æ³•æ˜¯å°†æ‰€æœ‰æ£€ç´¢åˆ°çš„ä¸Šä¸‹æ–‡ï¼ˆé«˜äºæŸä¸ªç›¸å…³æ€§é˜ˆå€¼ï¼‰ä¸æŸ¥è¯¢ä¸€èµ·è¿ç»­åœ°æäº¤ç»™LLMã€‚ä½†æ€»æœ‰å…¶ä»–æ›´å¤æ‚çš„æ–¹æ¡ˆï¼Œæ¯”å¦‚å¤šæ¬¡æ‰§è¡ŒLLMè°ƒç”¨æ¥ç»†åŒ–æ£€ç´¢åˆ°çš„ä¸Šä¸‹æ–‡ï¼Œä»¥ç”Ÿæˆæ›´å®Œç¾çš„ç­”æ¡ˆã€‚

å“åº”åˆæˆçš„ä¸»è¦æ–¹æ³•åŒ…æ‹¬ï¼š

1ã€é€šè¿‡å°†æ£€ç´¢åˆ°çš„ä¸Šä¸‹æ–‡é€å—æäº¤ç»™LLMæ¥è¿­ä»£ä¼˜åŒ–ç­”æ¡ˆã€‚
2ã€æ‘˜è¦æ£€ç´¢åˆ°çš„ä¸Šä¸‹æ–‡ä»¥åŒ¹é…promptã€‚
3ã€åŸºäºä¸åŒä¸Šä¸‹æ–‡å—ç”Ÿæˆå¤šä¸ªç­”æ¡ˆï¼Œç„¶åå°†å®ƒä»¬èåˆæˆ–æ‘˜è¦ã€‚

## RAGç›¸å…³çš„å¾®è°ƒ

* embeddingæ¨¡å‹å¾®è°ƒï¼š[LLamaIndex](https://docs.llamaindex.ai/en/stable/examples/finetuning/embeddings/finetune_embedding/)æä¾›äº†embeddingæ¨¡å‹å¾®è°ƒçš„æ–¹å¼ï¼Œæ ¹æ®å›½å¤–åšä¸»çš„å®æµ‹ï¼Œbge-large-en-v1.5çš„embeddingæ¨¡å‹å¾®è°ƒèƒ½å¤Ÿå¯¹RAGç³»ç»Ÿå¸¦æ¥2%çš„æ€§èƒ½æå‡ã€‚
* rerankeræ¨¡å‹å¾®è°ƒï¼šå¦ä¸€ä¸ªå¥½çš„æ—§é€‰æ‹©æ˜¯ï¼Œå¦‚æœæ‚¨ä¸å®Œå…¨ä¿¡ä»»åŸºç¡€ç¼–ç å™¨ï¼Œåˆ™æœ‰ä¸€ä¸ªäº¤å‰ç¼–ç å™¨æ¥é‡æ–°æ’åæ£€ç´¢åˆ°çš„ç»“æœã€‚å®ƒçš„å·¥ä½œæ–¹å¼å¦‚ä¸‹â€”â€”æ‚¨å°†æŸ¥è¯¢å’Œæ¯ä¸ªæ£€ç´¢åˆ°çš„å‰kä¸ªæ–‡æœ¬å—ä¼ é€’ç»™äº¤å‰ç¼–ç å™¨ï¼Œç”±SEPä»¤ç‰Œéš”å¼€ï¼Œå¹¶å¾®è°ƒä¸ºç›¸å…³å—è¾“å‡º1ï¼Œä¸ç›¸å…³å—è¾“å‡º0ã€‚è¿™ç§è°ƒæ•´è¿‡ç¨‹çš„ä¸€ä¸ªå¾ˆå¥½çš„ä¾‹å­å¯ä»¥åœ¨[è¿™é‡Œ](https://docs.llamaindex.ai/en/latest/examples/finetuning/cross_encoder_finetuning/cross_encoder_finetuning.html#)æ‰¾åˆ°ï¼Œç»“æœæ˜¾ç¤ºï¼Œé€šè¿‡äº¤å‰ç¼–ç å™¨å¾®è°ƒï¼Œé…å¯¹å¾—åˆ†æé«˜äº†4%ã€‚

## æŒ‡æ ‡è¯„ä¼°

### åŸºäºäººå·¥çš„æ•°æ®é›†è¯„æµ‹

åŸºäºäººå·¥çš„RAGè¯„æµ‹éœ€è¦äººå·¥æ„å»ºé—®é¢˜å’Œå¯¹åº”ç›®æ ‡æ–‡æœ¬çš„æ•°æ®é›†ã€‚è¿™æ˜¯ä¸€ä¸ªç¤ºä¾‹çš„æ•°æ®é›†æ ¼å¼ï¼š
```json
{
    # relevant_docs_sourceæ˜¯åœ¨æ•´ä¸ªçŸ¥è¯†åº“ä¸­çš„document-IDï¼ˆå­˜å‚¨åœ¨metadataä¿¡æ¯ä¸­ï¼‰
    "query_id": 1,
    "query_text": "<æŸäº§å“>çš„ä¼˜åŠ¿æ˜¯ä»€ä¹ˆï¼Ÿ",
    "relevant_docs_source": [40]
}
```
å…³äºä¸åŒçš„ç±»åˆ«ï¼Œå¯ä»¥åœ¨å…¶ä¸Šå±‚ç»§ç»­æ„å»ºåˆ†ç±»ï¼Œç”¨äºä¸åŒçš„ç±»åˆ«ã€‚
å…³äºå®šé‡æŒ‡æ ‡ï¼Œé€šå¸¸é€‰æ‹©ä¸€äº›å¸¸ç”¨çš„ï¼š`recall`, `precison`, `f1_score`, `hit_rate`ã€‚

* å¬å›ç‡ï¼ˆRecallï¼‰ï¼šå¬å›ç‡æ˜¯æŒ‡ç³»ç»Ÿæ­£ç¡®æ£€ç´¢åˆ°çš„ç›¸å…³æ–‡æ¡£æ•°ä¸æ‰€æœ‰ç›¸å…³æ–‡æ¡£æ•°çš„æ¯”ä¾‹ã€‚


$$Recall = \frac{æ£€ç´¢åˆ°çš„ç›¸å…³æ–‡æ¡£æ•°}{æ‰€æœ‰ç›¸å…³æ–‡æ¡£æ•°}$$


* ç²¾ç¡®ç‡ï¼ˆPrecisionï¼‰ï¼šç²¾ç¡®ç‡æ˜¯æŒ‡ç³»ç»Ÿæ£€ç´¢åˆ°çš„ç›¸å…³æ–‡æ¡£æ•°ä¸æ£€ç´¢åˆ°çš„æ‰€æœ‰æ–‡æ¡£æ•°çš„æ¯”ä¾‹ã€‚

$$Precision = \frac{æ£€ç´¢åˆ°çš„ç›¸å…³æ–‡æ¡£æ•°}{æ£€ç´¢åˆ°çš„æ‰€æœ‰æ–‡æ¡£æ•°}$$

* F1åˆ†æ•°ï¼ˆF1 Scoreï¼‰ï¼šF1åˆ†æ•°æ˜¯ç²¾ç¡®ç‡å’Œå¬å›ç‡çš„è°ƒå’Œå¹³å‡å€¼ï¼Œç”¨äºç»¼åˆè¡¡é‡ç³»ç»Ÿçš„æ€§èƒ½ã€‚

$$ F1\-Score = 2 \times \frac{Precision * Recall}{Precision + Recall}$$

* å‘½ä¸­ç‡ï¼ˆHit Rateï¼‰ï¼šå‘½ä¸­ç‡æ˜¯æŒ‡ç³»ç»Ÿåœ¨æ£€ç´¢åˆ°çš„æ–‡æ¡£ä¸­è‡³å°‘æœ‰ä¸€ä¸ªç›¸å…³æ–‡æ¡£çš„æ¯”ä¾‹ã€‚

$$Hit Rate = \frac{è‡³å°‘æœ‰ä¸€ä¸ªç›¸å…³æ–‡æ¡£çš„æŸ¥è¯¢æ•°}{æ€»æŸ¥è¯¢æ•°}$$


**ä¸Šè¿°æ‰€æœ‰æŒ‡æ ‡éƒ½éœ€è¦ç»“åˆæœ€ç»ˆæ£€ç´¢çš„æ ¼å¼`top_n`ç»“åˆèµ·æ¥çœ‹ï¼Œåœ¨ä¸Šé¢å‡ ä¸ªæŒ‡æ ‡ä¸­ï¼Œæœ€é‡è¦çš„æ˜¯`å¬å›ç‡`å’Œ`å‘½ä¸­ç‡`ã€‚è¿™æ˜¯å› ä¸ºä½ å³ä¾¿å¬å›äº†éƒ¨åˆ†å™ªå£°ï¼Œå¤§æ¨¡å‹æœ¬èº«å…·æœ‰åˆ¤æ–­çš„èƒ½åŠ›ï¼Œä½†å¦‚æœæ²¡æœ‰æ­£ç¡®çš„æ²¡æœ‰å¬å›ï¼Œå¤§æ¨¡å‹åˆ™æ²¡æœ‰ä¿¡æ¯æ¥æºï¼Œæ˜¯ä¸å¯èƒ½å›ç­”æ­£ç¡®çš„ã€‚**

### åŸºäºå¤§æ¨¡å‹çš„æ•°æ®é›†è¯„æµ‹

ã€ŠEvaluating RAG Applications with RAGAsã€‹æ–‡ç« ä»‹ç»äº†ä¸€ä¸ªç”¨äºè¯„ä¼°RAGåº”ç”¨çš„æ¡†æ¶ï¼Œç§°ä¸ºRAGAsï¼Œè¿™ç¯‡æ–‡ç« è¯¦ç»†ä»‹ç»äº†RAGASæ¡†æ¶ï¼Œå®ƒçš„æ ¸å¿ƒç›®æ ‡æ˜¯æä¾›ä¸€å¥—ç»¼åˆæ€§çš„è¯„ä¼°æŒ‡æ ‡å’Œæ–¹æ³•ï¼Œä»¥é‡åŒ–åœ°è¯„ä¼°**RAGç®¡é“(RAG Pipeline)**åœ¨ä¸åŒç»„ä»¶å±‚é¢ä¸Šçš„æ€§èƒ½ã€‚RAGAsç‰¹åˆ«é€‚ç”¨äºé‚£äº›ç»“åˆäº†**æ£€ç´¢ï¼ˆRetrievalï¼‰å’Œç”Ÿæˆï¼ˆGenerationï¼‰**ä¸¤ä¸ªä¸»è¦ç»„ä»¶çš„RAGç³»ç»Ÿã€‚

**æ— å‚è€ƒè¯„ä¼°**ï¼šRAGAsæœ€åˆè®¾è®¡ä¸ºä¸€ç§â€œæ— å‚è€ƒâ€è¯„ä¼°æ¡†æ¶ï¼Œæ„å‘³ç€å®ƒä¸ä¾èµ–äºäººå·¥æ³¨é‡Šçš„çœŸå®æ ‡ç­¾ï¼Œè€Œæ˜¯åˆ©ç”¨å¤§å‹è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰è¿›è¡Œè¯„ä¼°ã€‚

**ç»„ä»¶çº§è¯„ä¼°**ï¼šRAGAså…è®¸å¯¹RAGç®¡é“çš„ä¸¤ä¸ªä¸»è¦ç»„ä»¶â€”â€”æ£€ç´¢å™¨å’Œç”Ÿæˆå™¨â€”â€”åˆ†åˆ«è¿›è¡Œè¯„ä¼°ã€‚è¿™ç§åˆ†ç¦»è¯„ä¼°æ–¹æ³•æœ‰åŠ©äºç²¾ç¡®åœ°è¯†åˆ«ç®¡é“ä¸­çš„æ€§èƒ½ç“¶é¢ˆã€‚

**ç»¼åˆæ€§è¯„ä¼°æŒ‡æ ‡**ï¼šRAGAsæä¾›äº†ä¸€ç³»åˆ—è¯„ä¼°æŒ‡æ ‡ï¼ŒåŒ…æ‹¬**ä¸Šä¸‹æ–‡ç²¾åº¦(Context Precision)ã€ä¸Šä¸‹æ–‡å¬å›(Context Recall)ã€å¿ å®åº¦(Faithfulness)å’Œç­”æ¡ˆç›¸å…³æ€§(Answer Relevancy)**ã€‚è¿™äº›æŒ‡æ ‡å…±åŒæ„æˆäº†RAGAsè¯„åˆ†ï¼Œç”¨äºå…¨é¢è¯„ä¼°RAGç®¡é“çš„æ€§èƒ½ã€‚

å…·ä½“çš„è¯„ä¼°æµç¨‹å’Œä»£ç ç¤ºä¾‹ï¼š[https://towardsdatascience.com/evaluating-rag-applications-with-ragas-81d67b0ee31a](https://towardsdatascience.com/evaluating-rag-applications-with-ragas-81d67b0ee31a)

**Reference**:[https://pub.towardsai.net/advanced-rag-techniques-an-illustrated-overview-04d193d8fec6](https://pub.towardsai.net/advanced-rag-techniques-an-illustrated-overview-04d193d8fec6)
