---
title: "äºšä¿¡ç®—æ³•å®ä¹ ç¬”è®°"
date: 2023-07-21T18:18:05+08:00
lastmod: 2023-09-04T09:19:06+08:00
draft: false
featured_image: "https://blog-1311257248.cos.ap-nanjing.myqcloud.com/imgs/%E5%AE%9E%E4%B9%A0/shixi_tiltle.jpg"
description: "åœ¨å®ä¹ æœŸé—´é‡åˆ°çš„ä¸€äº›é—®é¢˜ï¼Œä»¥åŠè§£å†³æ€è·¯å’Œæ–¹æ¡ˆ"
tags:
- å®ä¹ ç¬”è®°
categories:
- å®ä¹ 
series:
- å®ä¹ ç¬”è®°
comment : true
---


## äºšä¿¡å›¾åƒç®—æ³•å®ä¹ ç¬”è®°

### æˆæƒä¹¦åŒºåŸŸè¯†åˆ«é¡¹ç›®ï¼š2023.7.24ï½2023.8.20

#### ä¿®æ”¹LinuxæœåŠ¡å™¨æ–‡ä»¶æƒé™é—®é¢˜

* å°†æ–‡ä»¶è®¾ç½®ä¸ºå¯è¯»å†™æ‰§è¡Œæƒé™ï¼š

```shell
$ chmod 777 file
```

* ç»™æ–‡ä»¶æ‰€æœ‰è€…å¢åŠ å†™æƒé™ï¼š

```shell
$ chmod u+w file
```

* ç»™æ–‡ä»¶æ‰€æœ‰è€…å’ŒåŒç»„ç”¨æˆ·èµ‹äºˆè¯»å†™æƒé™ï¼Œå…¶ä»–ç”¨æˆ·åªæœ‰è¯»æƒé™ï¼š

```shell
$ chmod 664 file
```

* é€’å½’ä¿®æ”¹ç›®å½•åŠå…¶å­ç›®å½•ä¸­çš„æ–‡ä»¶æƒé™ï¼š

```shell
$ chmod -R 755 directory
```

* æ˜¾ç¤ºä¿®æ”¹åçš„æƒé™ä¿¡æ¯ï¼š

```shell
$ chmod -v 755 file
```

è¯·æ³¨æ„ï¼Œä¿®æ”¹æ–‡ä»¶æˆ–ç›®å½•çš„æƒé™éœ€è¦æœ‰è¶³å¤Ÿçš„æƒé™è¿›è¡Œæ“ä½œã€‚åªæœ‰æ–‡ä»¶æˆ–ç›®å½•çš„æ‰€æœ‰è€…æˆ–è¶…çº§ç”¨æˆ·(root)æ‰èƒ½æ›´æ”¹æƒé™ã€‚



#### Dockeré…ç½®æ·±åº¦å­¦ä¹ ç¯å¢ƒ

> ç¬¬ä¸€æ­¥ï¼Œå®‰è£…Docker

* æ£€æŸ¥dockeræ˜¯å¦å®‰è£…ï¼š

```shell
$ docker help
```

* å¦‚æœæ²¡æœ‰å®‰è£…dockerï¼Œåˆ™ä½¿ç”¨å®˜æ–¹æä¾›çš„è„šæœ¬è¿›è¡Œå®‰è£…ï¼š

```shell
$ curl -fsSL https://get.docker.com | bash -s docker --mirror Aliyun
```

> Dockeré•œåƒåŠ é€Ÿ

* åœ¨`/etc/docker/daemon.json`ä¸­å†™å…¥å¦‚ä¸‹å†…å®¹ï¼Œå¦‚æœæ²¡æœ‰è¯¥æ–‡ä»¶åˆ™æ–°å»ºï¼š

```scss
{"registry-mirrors":["https://XXX.mirror.aliyuncs.com/"]}
```

* é‡å¯DockeræœåŠ¡ï¼š

```shell
$ sudo systemctl daemon-reload
$ sudo systemctl restart docker
```

> ä»Docker Hubä¸‹è½½é•œåƒ

* è¿›å…¥[Docker Hub](https://hub.docker.com/)ï¼Œå› ä¸ºæˆ‘ä½¿ç”¨çš„æ˜¯pytorchçš„è®­ç»ƒæ¡†æ¶ï¼Œæœç´¢`torch1.9.0-cuda11.1-cudnn8`
* ç‚¹å‡»å·¦è¾¹çš„`tags`ï¼Œå¤åˆ¶æ‹‰å–é•œåƒçš„è„šæœ¬ï¼Œåœ¨æœåŠ¡å™¨çš„å‘½ä»¤è¡Œä¸Šè¿è¡Œ

> è¿è¡ŒDockerå®¹å™¨

* ä¸‹è½½å®Œå®¹å™¨é•œåƒä¹‹åï¼ŒæŸ¥çœ‹æ‰€æœ‰imagesï¼š

```shell
$ docker images
```

* æ‰¾åˆ°è‡ªå·±çš„å®¹å™¨ï¼Œå¯åŠ¨è¯¥å®¹å™¨ï¼š

```shell
$ docker run -it mindest/torch1.9.0-cuda11.1-cudnn8:bevt /bin/bash 
```

å‚æ•°è¯´æ˜ï¼š

`-i`ï¼šäº¤äº’å¼æ“ä½œ

`-t`ï¼šç»ˆç«¯

`mindest/torch1.9.0-cuda11.1-cudnn8:bevt`ï¼šé•œåƒåç§°ï¼šé•œåƒæ ‡ç­¾

`bin/bash`ï¼šæ”¾åœ¨é•œåƒåé¢çš„æ˜¯å‘½ä»¤ï¼Œè¿™é‡Œæˆ‘ä»¬å¸Œæœ›æœ‰ä¸ªäº¤äº’å¼ Shellï¼Œå› æ­¤ç”¨çš„æ˜¯bin/bashã€‚`/bin/bash`çš„ä½œç”¨æ˜¯è¡¨ç¤ºè½½å…¥å®¹å™¨åè¿è¡Œbash ,dockerä¸­å¿…é¡»è¦ä¿æŒä¸€ä¸ªè¿›ç¨‹çš„è¿è¡Œï¼Œè¦ä¸ç„¶æ•´ä¸ªå®¹å™¨å¯åŠ¨åå°±ä¼šé©¬ä¸Škill itselfï¼Œè¿™ä¸ª`/bin/bash`å°±è¡¨ç¤ºå¯åŠ¨å®¹å™¨åå¯åŠ¨bashã€‚

> åœ¨å®¹å™¨å†…å®‰è£…æ‰€éœ€è¦çš„åŒ…ï¼Œå¹¶æ›´æ–°é•œåƒ

* å®‰è£…éœ€è¦çš„åŒ…ï¼Œç›´æ¥ä½¿ç”¨`pip install`å’Œ`conda install`
* æ›´æ–°é•œåƒï¼šå®¹å™¨æ˜¯åŠ¨æ€çš„ï¼Œé•œåƒæ˜¯é™æ€çš„ã€‚æˆ‘ä»¬åœ¨å®¹å™¨é‡Œæ›´æ–°äº†PythonåŒ…ï¼Œä¸ºäº†ä»¥åå¯ä»¥æŒä¹…åœ°ä½¿ç”¨ï¼Œè¿˜éœ€è¦ä½¿ç”¨`commit`å°†å®¹å™¨æ‰“åŒ…ä¸ºé•œåƒã€‚

```shell
$ docker commit -m="update packages" -a="XXX" bb8967093b48 XXX/torch1.9.0-cuda11.1-cudnn8:bevt
```

å„ä¸ªå‚æ•°è¯´æ˜ï¼š

- `-m`: æäº¤çš„æè¿°ä¿¡æ¯
- `-a`: æŒ‡å®šé•œåƒä½œè€…
- `bb8967093b48`ï¼šå®¹å™¨ ID
- `XXX/mypymarl:v1`: æŒ‡å®šè¦åˆ›å»ºçš„ç›®æ ‡é•œåƒåï¼ˆä½œè€…å/é•œåƒåï¼šæ ‡ç­¾ï¼‰

> åœ¨æœ¬åœ°ä½¿ç”¨å®¹å™¨è¿è¡Œä»£ç 

* é¦–å…ˆæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªæœ¬åœ°çš„Ubuntuç³»ç»Ÿå’Œdockerå®¹å™¨å…±äº«çš„æ–‡ä»¶å¤¹ï¼š

```shell
$ sudo mkdir /data
$ sudo docker run -v /data:/data -itd caixj/pytorch:v1
```

* æŸ¥çœ‹æ­£åœ¨è¿è¡Œçš„å®¹å™¨:

```shell
$ docker ps
```

* **æ‰¾åˆ°æˆ‘ä»¬å®¹å™¨çš„ID**ï¼Œå¹¶è¿›å…¥è¯¥å®¹å™¨

```shell
$ docker attach 500ad76de1cf
```

> å®‰è£…nvdia-cuda

Docker é»˜è®¤æ˜¯ä¸æ”¯æŒåœ¨å®¹å™¨å†… GPU åŠ é€Ÿçš„ï¼ŒNVIDIA å®˜æ–¹åšäº†ä¸ªå·¥å…·ç®±æ¥æ”¯æŒå®¹å™¨å†… GPU åŠ é€Ÿè¿ç®—ï¼Œè¿™å¤§å¤§æ–¹ä¾¿äº†æ·±åº¦å­¦ä¹ å¼€å‘è€…ã€‚è¿™é‡Œç›´æ¥æ ¹æ®å®˜æ–¹æ•™ç¨‹å®‰è£…å³å¯ã€‚

[https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/latest/install-guide.html](https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/latest/install-guide.html)

å®‰è£…å®Œnvidia-cudaä¹‹åï¼Œå†åˆ›å»ºå®¹å™¨æ—¶åŠ ä¸Š`--gpus all`ï¼Œå³å¯åœ¨å®¹å™¨å†…è°ƒç”¨cudaï¼Œå³

```shell
$ sudo docker run -v /data:/data -itd --gpus all caixj/pytorch:v1 /bin/bash
```

ç„¶åè·Ÿä¸Šè¿°æ­¥éª¤ç›¸åŒï¼Œè¿›å…¥å®¹å™¨ï¼Œç„¶åè¿è¡Œä»£ç å°±okã€‚

* æœ¬åœ°ä¿å­˜é•œåƒ

```shell
$ docker save -o <your_file_name.tar> <image id>
# æ ¹æ®æµ‹è¯•çš„åé¦ˆæ¥è¯´ï¼Œæœ€å¥½ä¸ç”¨image idè¿›è¡Œsave
$ docker save -o <your_file_name.tar> <image name:version>
```

* é€šè¿‡æœ¬åœ°é•œåƒå¯¼å…¥dockerå®¹å™¨

```shell
$ docker load < your_file.tar.gz
# æˆ–è€…
$ docker load --input your_file.tar
# å®ƒçš„imagesçš„åå­—ä¼šå˜ä¸ºyour_file:latest
```
* æ¯”è¾ƒå¥½çš„è¿›å…¥å®¹å™¨çš„æ–¹æ³•ï¼š

```shell
$ docker exec -it å®¹å™¨id /bin/bash
```
* ä½¿ç”¨`docker exec`å‘½ä»¤è¿›å…¥å®¹å™¨åï¼Œå†ä½¿ç”¨`exit`å‘½ä»¤é€€å‡ºå®¹å™¨ï¼Œå®¹å™¨ä»å°†ä¿æŒè¿è¡Œï¼Œè€Œ`docker attach`è¿›å…¥ä½¿ç”¨exité€€å‡ºåå®¹å™¨ä¼šåœæ­¢è¿è¡Œ

#### Dockerå¸¸ç”¨å‘½ä»¤

* æŸ¥çœ‹æ‰€æœ‰é•œåƒ

```text
docker images
```

* æŸ¥æ‰¾é•œåƒ

```text
docker search XXX/image
```

* ä¸‹è½½é•œåƒ

```text
docker pull XXX/images:tag
```

* åˆ é™¤é•œåƒ

```text
docker rmi XXX/images:ta
```

* å¯åŠ¨å®¹å™¨

```text
docker run -it image:tag /bin/bash
```

* é€€å‡ºå®¹å™¨

```text
exit
```

*  æŸ¥çœ‹æ­£åœ¨è¿è¡Œçš„å®¹å™¨

```text
docker ps
```

*  è¿›å…¥æ­£åœ¨è¿è¡Œçš„å®¹å™¨

```text
docker attach container_ID
```

* æŸ¥çœ‹å·²åœæ­¢è¿è¡Œçš„å®¹å™¨

```text
docker ps -a
```

* å¯åŠ¨å·²åœæ­¢çš„å®¹å™¨

```text
docker start container_ID
```

* åœæ­¢å®¹å™¨

```text
docker stop container_ID
```

*  é‡å¯å·²åœæ­¢å®¹å™¨

```text
docker restart container_I
```

* è¿›å…¥å®¹å™¨æ–¹å¼ï¼ˆé€€å‡ºå®¹å™¨ç»ˆç«¯æ—¶ä½†ä¸åœæ­¢ï¼‰

```text
docker exec
```

* æ¸…ç†Dockerå®¹å™¨

```shell
docker rm [container id]
```

* æ¸…ç†æ‰€æœ‰Dockeré•œåƒ

```shell
docker image prune -a
```

* æ¸…ç†Dockerç¼“å­˜æ–‡ä»¶

```shell
docker system prune --force --all --volumes
```


#### ç›®æ ‡æ£€æµ‹æ£€æµ‹æ¡†åŸç†

> YOLOv4æ£€æµ‹å¤´åŸç†

æ£€æµ‹å¤´ç”±ä¸€ä¸ªå¸¸è§„çš„$3\times 3$å·ç§¯æ¥ä¸Šä¸€ä¸ª$1\times 1$å·ç§¯ç»„æˆã€‚å‡è®¾è¾“å…¥å›¾åƒä¸º$416\times 416$ï¼Œæœ€åå¾—åˆ°çš„ç‰¹å¾å›¾çš„å¤§å°ä¸º`(B, 75, 26, 26)`ï¼Œè¿™é‡Œçš„åˆ†ç±»æ•°ä¸º20ã€‚

é‚£ä¹ˆé€šé“æ•°75æ˜¯å¦‚ä½•å¾—åˆ°çš„å‘¢ï¼Ÿ

75 = 3 * ï¼ˆ5 + åˆ†ç±»æ•°ï¼‰ = 3 * ï¼ˆ4 + 1 + 20ï¼‰= 75

åœ¨$26\times 26$çš„ç‰¹å¾å±‚ä¸­ï¼Œä¼šé¢„å…ˆæ ‡å®šä¸‰ä¸ªå…ˆéªŒæ¡†ï¼Œ**YOLOv4ç½‘ç»œçš„é¢„æµ‹ç»“æœåªä¼šåˆ¤å®šå…ˆéªŒæ¡†å†…éƒ¨æ˜¯å¦åŒ…å«ç‰©ä½“å’Œè¿™ä¸ªç‰©ä½“çš„ç§ç±»ä»¥åŠå¯¹å…ˆéªŒæ¡†è¿›è¡Œè°ƒæ•´ï¼Œè·å¾—ä¸€ä¸ªæ–°çš„é¢„æµ‹æ¡†**ã€‚

**æ‰€ä»¥ä¸Šé¢çš„3ä»£è¡¨æ¯ä¸€ä¸ªç‰¹å¾å›¾ä¸Šçš„ä¸‰ä¸ªå…ˆéªŒæ¡†ã€‚4 + 1ä¸­çš„4ä»£è¡¨äº†å…ˆéªŒæ¡†çš„è°ƒæ•´å‚æ•°ï¼Œ1çš„å†…å®¹ä»£è¡¨å…ˆéªŒæ¡†å†…éƒ¨æ˜¯å¦åŒ…å«ç‰©ä½“ï¼Œnum_classesä¸ªé€šé“åˆ†åˆ«ä»£è¡¨å±äºè¯¥ç±»çš„æ¦‚ç‡ã€‚**

> å…ˆéªŒæ¡†è¯¦è§£ä¸è§£ç 

å…ˆçœ‹å…ˆéªŒæ¡†çš„è§£ç ä»£ç ï¼š

```python
class DecodeBox():
    def __init__(self, anchors, num_classes, input_shape, anchors_mask = [[6,7,8], [3,4,5], [0,1,2]]):
        super(DecodeBox, self).__init__()
        self.anchors        = anchors
        self.num_classes    = num_classes
        self.bbox_attrs     = 5 + num_classes
        self.input_shape    = input_shape
        #-----------------------------------------------------------#
        #   13x13çš„ç‰¹å¾å±‚å¯¹åº”çš„anchoræ˜¯[81,82],[135,169],[344,319]
        #   26x26çš„ç‰¹å¾å±‚å¯¹åº”çš„anchoræ˜¯[10,14],[23,27],[37,58]
        #-----------------------------------------------------------#
        self.anchors_mask   = anchors_mask

    def decode_box(self, inputs):
        outputs = []
        for i, input in enumerate(inputs):
            #-----------------------------------------------#
            #   è¾“å…¥çš„inputä¸€å…±æœ‰ä¸‰ä¸ªï¼Œä»–ä»¬çš„shapeåˆ†åˆ«æ˜¯
            #   batch_size, 255, 13, 13
            #   batch_size, 255, 26, 26
            #-----------------------------------------------#
            batch_size      = input.size(0)
            input_height    = input.size(2)
            input_width     = input.size(3)

            #-----------------------------------------------#
            #   è¾“å…¥ä¸º416x416æ—¶
            #   stride_h = stride_w = 32ã€16ã€8
            #-----------------------------------------------#
            stride_h = self.input_shape[0] / input_height
            stride_w = self.input_shape[1] / input_width
            #-------------------------------------------------#
            #   æ­¤æ—¶è·å¾—çš„scaled_anchorså¤§å°æ˜¯ç›¸å¯¹äºç‰¹å¾å±‚çš„
            #-------------------------------------------------#
            scaled_anchors = [(anchor_width / stride_w, anchor_height / stride_h) for anchor_width, anchor_height in self.anchors[self.anchors_mask[i]]]

            #-----------------------------------------------#
            #   è¾“å…¥çš„inputä¸€å…±æœ‰ä¸‰ä¸ªï¼Œä»–ä»¬çš„shapeåˆ†åˆ«æ˜¯
            #   batch_size, 3, 13, 13, 85
            #   batch_size, 3, 26, 26, 85
            #-----------------------------------------------#
            prediction = input.view(batch_size, len(self.anchors_mask[i]),
                                    self.bbox_attrs, input_height, input_width).permute(0, 1, 3, 4, 2).contiguous()

            #-----------------------------------------------#
            #   å…ˆéªŒæ¡†çš„ä¸­å¿ƒä½ç½®çš„è°ƒæ•´å‚æ•°
            #-----------------------------------------------#
            x = torch.sigmoid(prediction[..., 0])  
            y = torch.sigmoid(prediction[..., 1])
            #-----------------------------------------------#
            #   å…ˆéªŒæ¡†çš„å®½é«˜è°ƒæ•´å‚æ•°
            #-----------------------------------------------#
            w = prediction[..., 2]
            h = prediction[..., 3]
            #-----------------------------------------------#
            #   è·å¾—ç½®ä¿¡åº¦ï¼Œæ˜¯å¦æœ‰ç‰©ä½“
            #-----------------------------------------------#
            conf        = torch.sigmoid(prediction[..., 4])
            #-----------------------------------------------#
            #   ç§ç±»ç½®ä¿¡åº¦
            #-----------------------------------------------#
            pred_cls    = torch.sigmoid(prediction[..., 5:])

            FloatTensor = torch.cuda.FloatTensor if x.is_cuda else torch.FloatTensor
            LongTensor  = torch.cuda.LongTensor if x.is_cuda else torch.LongTensor

            #----------------------------------------------------------#
            #   ç”Ÿæˆç½‘æ ¼ï¼Œå…ˆéªŒæ¡†ä¸­å¿ƒï¼Œç½‘æ ¼å·¦ä¸Šè§’ 
            #   batch_size,3,13,13
            #----------------------------------------------------------#
            grid_x = torch.linspace(0, input_width - 1, input_width).repeat(input_height, 1).repeat(
                batch_size * len(self.anchors_mask[i]), 1, 1).view(x.shape).type(FloatTensor)
            grid_y = torch.linspace(0, input_height - 1, input_height).repeat(input_width, 1).t().repeat(
                batch_size * len(self.anchors_mask[i]), 1, 1).view(y.shape).type(FloatTensor)

            #----------------------------------------------------------#
            #   æŒ‰ç…§ç½‘æ ¼æ ¼å¼ç”Ÿæˆå…ˆéªŒæ¡†çš„å®½é«˜
            #   batch_size,3,13,13
            #----------------------------------------------------------#
            anchor_w = FloatTensor(scaled_anchors).index_select(1, LongTensor([0]))
            anchor_h = FloatTensor(scaled_anchors).index_select(1, LongTensor([1]))
            anchor_w = anchor_w.repeat(batch_size, 1).repeat(1, 1, input_height * input_width).view(w.shape)
            anchor_h = anchor_h.repeat(batch_size, 1).repeat(1, 1, input_height * input_width).view(h.shape)

            #----------------------------------------------------------#
            #   åˆ©ç”¨é¢„æµ‹ç»“æœå¯¹å…ˆéªŒæ¡†è¿›è¡Œè°ƒæ•´
            #   é¦–å…ˆè°ƒæ•´å…ˆéªŒæ¡†çš„ä¸­å¿ƒï¼Œä»å…ˆéªŒæ¡†ä¸­å¿ƒå‘å³ä¸‹è§’åç§»
            #   å†è°ƒæ•´å…ˆéªŒæ¡†çš„å®½é«˜ã€‚
            #----------------------------------------------------------#
            pred_boxes          = FloatTensor(prediction[..., :4].shape)
            pred_boxes[..., 0]  = x.data + grid_x
            pred_boxes[..., 1]  = y.data + grid_y
            pred_boxes[..., 2]  = torch.exp(w.data) * anchor_w
            pred_boxes[..., 3]  = torch.exp(h.data) * anchor_h

            #----------------------------------------------------------#
            #   å°†è¾“å‡ºç»“æœå½’ä¸€åŒ–æˆå°æ•°çš„å½¢å¼
            #----------------------------------------------------------#
            _scale = torch.Tensor([input_width, input_height, input_width, input_height]).type(FloatTensor)
            output = torch.cat((pred_boxes.view(batch_size, -1, 4) / _scale,
                                conf.view(batch_size, -1, 1), pred_cls.view(batch_size, -1, self.num_classes)), -1)
            outputs.append(output.data)
        return outputs
```

ä¸‹é¢å±•ç¤ºäº†ä¸€ä¸ªå…·ä½“å›¾ç‰‡çš„å…ˆéªŒæ¡†è°ƒæ•´è¿‡ç¨‹ï¼š

![](https://blog-1311257248.cos.ap-nanjing.myqcloud.com/imgs/%E5%AE%9E%E4%B9%A0/img1.jpg)

å¯ä»¥çœ‹åˆ°åŸæœ¬çš„ä¸‰ä¸ªå…ˆéªŒæ¡†çš„ä¸­å¿ƒç‚¹æ˜¯ç›¸åŒçš„ï¼Œè°ƒæ•´ä¹‹åï¼Œå…ˆéªŒæ¡†çš„ä¸­å¿ƒç‚¹å‘ç”Ÿäº†åç§»ã€‚

> YOLOv4çš„é¢„æµ‹è¿‡ç¨‹

è®¡ç®—è¾“å…¥å›¾ç‰‡çš„å®½é«˜ â€”â€”> å°†å›¾ç‰‡è½¬åŒ–ä¸ºRGBå›¾ç‰‡ â€”â€”> ç»™å›¾ç‰‡å¢åŠ ç°æ¡ï¼Œå®ç°ä¸å¤±çœŸçš„resize â€”â€”> å½’ä¸€åŒ–è½¬ç½®åï¼Œæ·»åŠ ä¸ŠBatchç»´åº¦ â€”â€”> å°†å›¾ç‰‡è¾“å…¥ç½‘ç»œè¿›è¡Œé¢„æµ‹ï¼ˆéœ€è¦è½¬ä¸ºtensorï¼‰â€”â€”> å¯¹è¾“å‡ºç‰¹å¾å±‚è¿›è¡Œè§£ç  â€”â€”> å¯¹é¢„æµ‹æ¡†è¿›è¡Œå †å ï¼Œè¿›è¡Œéæå¤§æŠ‘åˆ¶



å…¶ä¸­éæå¤§æŠ‘åˆ¶è¿‡ç¨‹ï¼šå–å‡ºæ¯ä¸€ç§ç±»çš„ç²‰æœ€å¤§çš„æ¡†ï¼ŒæŠŠå®ƒå’Œå…¶ä»–çš„æ¡†è¿›è¡Œä¸€ä¸ªäº¤å¹¶æ¯”çš„è®¡ç®—ï¼Œå¦‚æœè¯¥å€¼å¤§äºè®¾ç½®çš„é˜ˆå€¼ï¼Œåˆ™ä¿ç•™è¿™ä¸ªæ¡†ã€‚

> VOCæ£€æµ‹æ•°æ®é›†çš„æ ¼å¼

è¯¥æ ¼å¼çš„ä¸»ä½“ç›®å½•ä¸ºï¼š

```scss
- æ•°æ®é›†åç§°
-|- VOC2007
-|-|- ImageSetsï¼ˆæ–‡ä»¶å¤¹é‡Œé¢æ”¾è®­ç»ƒé›†ï¼ŒéªŒè¯é›†ï¼Œæµ‹è¯•é›†ï¼Œä»¥txtçš„å½¢å¼å‘ˆç°ï¼‰
-|-|- JPEGImagesï¼ˆæ–‡ä»¶å¤¹é‡Œé¢æ”¾åŸå›¾ï¼‰
-|-|- Annotationsï¼ˆæ–‡ä»¶å¤¹é‡Œé¢æ”¾æ ‡ç­¾çš„ä¿¡æ¯ï¼Œä»¥xmlæ–‡ä»¶å½¢å¼å­˜åœ¨ï¼‰
```

å…¶ä¸­`Annotations`ä¸­å¯¹åº”`JPEGImages`é‡Œé¢æ¯å¼ å›¾ç‰‡å¯¹åº”ä¸€ä¸ªxmlæ–‡ä»¶ï¼Œæ”¾ä¸€ä¸ªxmlæ–‡ä»¶çš„æ ¼å¼ç¤ºä¾‹ï¼š

```xml
<annotation>
    <folder>VOC2007</folder>
    <filename>ed27edc6-cec1-11ed-96cf-58961d2b4192.jpg</filename>
    <size>
        <width>1000</width>
        <height>750</height>
        <depth>3</depth>
    </size>
    <object>
        <name>class1</name>
        <bndbox>
            <xmin>899</xmin>
            <ymin>29</ymin>
            <xmax>923</xmax>
            <ymax>286</ymax>
        </bndbox>
    </object>
    <object>
        <name>class2</name>
        <bndbox>
            <xmin>814</xmin>
            <ymin>69</ymin>
            <xmax>840</xmax>
            <ymax>319</ymax>
        </bndbox>
    </object>
    <object>
        <name>class3</name>
        <bndbox>
            <xmin>745</xmin>
            <ymin>60</ymin>
            <xmax>761</xmax>
            <ymax>195</ymax>
        </bndbox>
    </object>
    <object>
        <name>class4</name>
        <bndbox>
            <xmin>741</xmin>
            <ymin>307</ymin>
            <xmax>759</xmax>
            <ymax>520</ymax>
        </bndbox>
    </object>
    <object>
        <name>class5</name>
        <bndbox>
            <xmin>693</xmin>
            <ymin>61</ymin>
            <xmax>710</xmax>
            <ymax>211</ymax>
        </bndbox>
    </object>
    <object>
        <name>class6</name>
        <bndbox>
            <xmin>511</xmin>
            <ymin>51</ymin>
            <xmax>613</xmax>
            <ymax>579</ymax>
        </bndbox>
    </object>
    <object>
        <name>class7</name>
        <bndbox>
            <xmin>93</xmin>
            <ymin>304</ymin>
            <xmax>114</xmax>
            <ymax>544</ymax>
        </bndbox>
    </object>
</annotation>
```

å…¶ä¸­æˆ‘ä»¬éœ€è¦çš„ä¿¡æ¯åªæœ‰<object>é‡Œé¢çš„å†…å®¹ï¼Œåˆ†åˆ«åŒ…å«äº†ç±»çš„ä¿¡æ¯çš„æ ‡ç­¾æ¡†çš„åæ ‡ä½ç½®ä¿¡æ¯ã€‚

> é€šè¿‡èšç±»ç®—æ³•å¯¹ç‰¹å®šæ•°æ®é›†è¿›è¡Œå…ˆéªŒæ¡†çš„è°ƒæ•´

å…ˆéªŒæ¡†çš„æ£€æµ‹å’Œè¾¹æ¡†é¢„æµ‹éƒ½æ˜¯åœ¨ YOLOv4 æ¨¡å‹ä¸­çš„å¤´éƒ¨æ£€æµ‹æ¨¡å—ä¸­è¿›è¡Œçš„ï¼ŒYOLOv4 æ¨¡å‹åœ¨è®¾è®¡æ—¶æ²¡æœ‰å¯¹ Head è¿›è¡Œæ”¹è¿›ï¼Œä½¿ç”¨çš„ä»ç„¶æ˜¯ YOLO_Head æ£€æµ‹å¤´ã€‚è®¾å®šçš„è¿™äº›å…ˆéªŒæ¡†å°ºå¯¸å°±æ˜¯ç»è¿‡èšç±»ç®—æ³• K-means èšç±»è€Œæ¥çš„ï¼Œå…¶ä¸­çš„ Kçš„å–å€¼ï¼Œä¸€èˆ¬æ˜¯éšæœºç¡®å®šä¸€ä¸ªåˆå§‹ç‚¹ï¼Œç„¶ååœ¨è·ç¦»è¿™ä¸ªç‚¹æœ€è¿œçš„è·ç¦»ä¸ºç¬¬äºŒä¸ªç‚¹ï¼Œä»¥æ­¤ç±»æ¨å¯ä»¥ç¡®å®šå¤šä¸ªç‚¹ã€‚å‡è®¾Kçš„å–å€¼ä¸º 2ï¼ŒåŒ…æ‹¬äº†æ‰‹æœºå’ŒçƒŸå¤´ä¸¤ç§ç›®æ ‡ç±»å‹ã€‚

è¿™é‡Œè®¾å®šçš„å…ˆéªŒæ¡†ä¼šæ ¹æ®ç½‘æ ¼å†…æ˜¯å¦å­˜åœ¨ç›®æ ‡å¯¹å…ˆéªŒæ¡†è¿›è¡Œç»´æŒçš„å¾®è°ƒã€‚æ˜ å°„åˆ°æœ¬æ–‡ä¸­çš„YOLOv4 æ£€æµ‹ç®—æ³•ä¸­ï¼Œåœ¨ç”Ÿæˆç½‘æ ¼åï¼Œåœ¨æ¯ä¸ªç½‘æ ¼ä¸­ç”Ÿæˆä¸‰ä¸ªä¸åŒå°ºå¯¸çš„é¢„æµ‹æ¡†ï¼Œè¿™ä¸‰ä¸ªé¢„æµ‹æ¡†ä¼šå¯¹å‡ºç§Ÿè½¦å¸æœºè¿è§„è¡Œä¸ºæ•°æ®ä¸­çš„æ‰‹æœºå’ŒçƒŸå¤´ç›®æ ‡è¿›è¡Œå¾®è°ƒå¾—åˆ°çœŸå®æ¡†ï¼Œå¹¶é€šè¿‡å…ˆéªŒæ¡†å’ŒçœŸå®æ¡†æ±‚å‡ºå®ƒä»¬ä¹‹é—´çš„ IOU (äº¤å¹¶æ¯”)ï¼Œé€šè¿‡äº¤å¹¶æ¯”æ¥åˆ¤æ–­å‡ºæ›´çœŸå®çš„æ£€æµ‹æ¡†ã€‚

#### è¿œç¨‹ä½¿ç”¨æœåŠ¡å™¨ä¸Šçš„Tensorboard

æœ¬æœºæ“ä½œç³»ç»Ÿï¼šMacOS 12

æœåŠ¡å™¨ç³»ç»Ÿï¼šUbuntu

> å¦‚ä½•è¿œç¨‹ä½¿ç”¨TensorBoard

* è¿æ¥sshæ—¶ï¼Œå°†æœåŠ¡å™¨çš„6006ç«¯å£é‡å®šå‘åˆ°è‡ªå·±çš„æœºå™¨ä¸Š

```shell
$ ssh -L 16006:127.0.0.1:6006 username@remote_server_ip
```

æˆ–è€…

```shell
$ ssh -L 8008:localhost:6006 username@remote_server_ip
```

* åœ¨æœåŠ¡å™¨ä¸Šä½¿ç”¨6006ç«¯å£æ­£å¸¸å¯åŠ¨tensorboardï¼š

```shell
$ tensorboard --logdir=xxx --port=6006
```

* åœ¨æœ¬åœ°æµè§ˆå™¨è¾“å…¥åœ°å€ï¼š

```scss
127.0.0.1:16006
```

#### æˆæƒä¹¦ç‰¹å®šåŒºåŸŸæ£€æµ‹æ€è·¯

æˆæƒä¹¦çš„éœ€æ±‚å¦‚ä¸‹ï¼š

![](https://blog-1311257248.cos.ap-nanjing.myqcloud.com/imgs/%E5%AE%9E%E4%B9%A0/img2.jpg)

ç»™å®šä¸€å¼ ç§»åŠ¨å…¬å¸çš„æˆæƒä¹¦æ¨¡ç‰ˆï¼Œéœ€è¦å°†ä»£è¡¨ä¸åŒåŒºåŸŸçš„ä½ç½®ç»™åˆ†å‰²å‡ºæ¥ï¼Œç„¶åäº¤ç»™æ–‡å­—OCRè¿›è¡Œè¯†åˆ«ã€‚

ç”±äºæ–‡å­—OCRå·²ç»åšå¥½äº†ï¼Œç»™æˆ‘çš„éœ€æ±‚å°±æ˜¯å°†è¯¥å›¾ä¸Šè¿™äº›åŒºåŸŸç»™åˆ†å‰²å‡ºæ¥ã€‚

> éš¾ç‚¹è§£æ

* 1.è¯¥éœ€æ±‚åªå¯¹ç‰¹å®šçš„ä¿¡æ¯åŒºåŸŸè¿›è¡Œæ£€æµ‹ã€‚
* 2.å¯¹äºç‰¹å®šæ–‡å­—åŒºåŸŸæ¥è¯´ï¼Œå¯¹äºæ•´å¼ å›¾ç‰‡æ¥è¯´ï¼Œè¯­ä¹‰ä¿¡æ¯ä¸å…¶ä»–æ–‡å­—åŒºåŸŸç›¸ä¼¼ï¼›ä¸”åœ¨è¿™äº›åŒºåŸŸä¸­ï¼Œå­˜åœ¨æ‰‹å†™ä½“å’Œæ‰“å°ä½“ã€‚åŒºåŸŸåœ¨æ‹–ç‰‡ä¸­çš„ä½ç½®æ˜¯ä¸å›ºå®šçš„ï¼Œä¹Ÿå°±æ˜¯è¯´æˆæƒä¹¦çš„æ‘†æ”¾ä½ç½®æ˜¯ä¸å›ºå®šçš„ï¼ˆæ¨ªç«–æ‘†æ”¾éƒ½å­˜åœ¨ï¼‰ã€‚
* 3.å¯¹æ£€æµ‹çš„å‡†ç¡®ç‡è¦æ±‚è¾ƒé«˜ï¼Œä¹Ÿå°±æ˜¯Precsionè¾ƒé«˜ï¼Œå› ä¸ºæ£€æµ‹ä¸å‡†ï¼Œé‚£ä¹ˆå°±ä¼šæ¼æ–‡å­—ã€‚

> è§£å†³æ€è·¯

* 1.é’ˆå¯¹è¯­ä¹‰ä¿¡æ¯ä¸è¶³çš„é—®é¢˜ï¼Œæ‹Ÿé‡‡ç”¨åˆ†ä¸¤é˜¶æ®µæ£€æµ‹çš„æ–¹æ³•è¿›è¡Œã€‚ç¬¬ä¸€é˜¶æ®µæ£€æµ‹å¸¦æ–‡å­—å±æ€§å­—æ®µå’Œå±æ€§ä¿¡æ¯çš„è”åˆåŒºåŸŸçš„æ£€æµ‹ã€‚å¦‚ä¸‹å›¾ï¼š

![](https://blog-1311257248.cos.ap-nanjing.myqcloud.com/imgs/%E5%AE%9E%E4%B9%A0/img3.jpg)

ç¬¬äºŒé˜¶æ®µå°†é™¤äº†æ£€æµ‹åˆ°çš„åŒºåŸŸåƒç´ å…¨éƒ¨ç½®0ï¼ˆåŠ maskï¼‰ã€‚å†å¯¹æˆ‘ä»¬çš„å±æ€§ä¿¡æ¯éƒ¨åˆ†åŒºåŸŸè¿›è¡Œæ£€æµ‹ã€‚å°†éš¾åº¦è¾ƒé«˜çš„ä»»åŠ¡åˆ†ä¸ºä¸¤ä¸ªæ›´ç®€å•çš„ä»»åŠ¡çš„ç»„åˆã€‚

* 2.yoloç³»åˆ—ç®—æ³•é›†æˆè¾ƒå¥½ï¼Œä½¿ç”¨èµ·æ¥æˆæœ¬ä¸ä¼šç‰¹åˆ«é«˜ã€‚ï¼ˆä¼—æ‰€å‘¨çŸ¥ï¼Œæ”¹è¿›ç»“æ„çš„æ•ˆæœæ˜¯æœ‰é™çš„ï¼Œæˆ‘ä»¬ä¸æ˜¯åœ¨ç§‘ç ”ï¼Œèƒ½è§£å†³é—®é¢˜å°±è¡Œï¼‰ã€‚
* 3.å¯¹äºåˆ†ç±»çš„é—®é¢˜ï¼Œç¬¬ä¸€é˜¶æ®µåº”è¯¥è¿›è¡Œåˆ†ç±»ã€‚é¦–å…ˆä¸åŒçš„ç±»ä¹‹é—´åœ¨å›¾ç‰‡ä¸­çš„ä½ç½®ä¿¡æ¯ä¸åŒï¼Œå‘¨å›´çš„æ–‡å­—åˆ†å¸ƒä¿¡æ¯ä¹Ÿä¸åŒã€‚æ ¹æ®è¿™ä¸ªç‚¹å¯ä»¥æ¯”è¾ƒå¥½åˆ†ç±»ã€‚å¦‚æœå°†æ‰€æœ‰åŒºåŸŸåˆ†ä¸º1ç±»ï¼Œåˆ™å¾ˆéš¾æ‰¾åˆ°å®ƒä»¬è”åˆçš„ç‰¹å¾ä¸å…¶ä»–æ–‡æœ¬åŒºåŸŸç‰¹å¾çš„åŒºåˆ«ã€‚
* 4.å¯¹äºç¬¬äºŒé˜¶æ®µçš„æ£€æµ‹ï¼Œåº”è¯¥æ³¨é‡å‡†ç¡®ç‡ï¼Œç›®å‰æƒ³æ³•åˆ†ä¸º1ç±»ã€‚å› ä¸ºå®ƒä»¬çš„ç‰¹å¾æ¯”è¾ƒæ˜æ˜¾ï¼Œè¦ä¹ˆæœ‰ä¸‹åˆ’çº¿ï¼ˆçº¢æ¡†åŒºåŸŸä¸­ï¼‰ï¼Œè¦ä¹ˆä¸å…¶ä»–æ–‡æœ¬åŒºåŸŸæœ‰æ˜æ˜¾çš„ç•Œé™ã€‚

#### YOLOæ ¼å¼æ ‡ç­¾â€”â€”>VOCæ£€æµ‹æ ¼å¼

YOLOæ•°æ®é›†æ ¼å¼ï¼š

```scss
# imagesä¸‹é¢çš„trainå’Œvalæ”¾å›¾ç‰‡ï¼Œlabelsä¸‹é¢çš„trainå’Œvalä¸‹é¢æ”¾æ ‡ç­¾ï¼ˆtxtæ–‡ä»¶æ ¼å¼ï¼‰
- dataset
-- score
--- images
---- train
---- val
--- labels
---- train
---- val
```

YOLOæ ¼å¼çš„æ£€æµ‹æ ‡ç­¾è¾ƒä¸ºç®€å•ï¼Œä¾‹å­ï¼š

```scss
# ä»å·¦åˆ°å³åˆ†åˆ«ä»£è¡¨ï¼š
# ç±»åˆ« æ£€æµ‹æ¡†çš„ä¸­å¿ƒxåæ ‡ æ£€æµ‹æ¡†çš„ä¸­å¿ƒyåæ ‡ æ£€æµ‹æ¡†çš„é«˜ æ£€æµ‹æ¡†çš„å®½
# ä¸Šé¢æåŠçš„åæ ‡éƒ½å·²ç»å½’ä¸€åŒ–ï¼Œå½’ä¸€åŒ–çš„æ ‡å‡†æ˜¯æŒ‰ç…§åŸå§‹å½±åƒå¤§å°è¿›è¡Œå½’ä¸€åŒ–
0 0.915000 0.234667 0.034000 0.381333
1 0.813000 0.280667 0.034000 0.329333
2 0.721000 0.238667 0.026000 0.229333
3 0.725000 0.624667 0.034000 0.294667
4 0.661500 0.246667 0.025000 0.234667
5 0.505500 0.498000 0.131000 0.726667
6 0.045000 0.646667 0.040000 0.330667
```

é‚£ä¹ˆå¦‚ä½•å°†è¯¥æ ¼å¼è½¬åŒ–ä¸ºVOCæ ¼å¼çš„æ£€æµ‹æ•°æ®(.xmlæ–‡ä»¶)å‘¢ï¼Ÿè¿™æ¶‰åŠéƒ¨åˆ†æ•°å­¦è®¡ç®—ã€‚ä»£ç å¦‚ä¸‹ï¼š

```python
import os
import cv2
import xml.etree.ElementTree as ET
import xml.dom.minidom as minidom

def yolo_to_voc(yolo_annotation, image_path, new_label_folder):
    
    os.makedirs(new_label_folder, exist_ok=True)

    
    class_names = ['class1', 'class2', 'class3', 'class4', 'class5', 'class6', 'class7']  # Replace with your class names

    image = cv2.imread(image_path)
    height, width, _ = image.shape

    root = ET.Element("annotation")

    folder = ET.SubElement(root, "folder")
    folder.text = "VOC2007"

    filename = ET.SubElement(root, "filename")
    filename.text = os.path.basename(image_path)

    size = ET.SubElement(root, "size")
    width_elem = ET.SubElement(size, "width")
    width_elem.text = str(width)
    height_elem = ET.SubElement(size, "height")
    height_elem.text = str(height)
    depth_elem = ET.SubElement(size, "depth")
    depth_elem.text = str(3)  # Assuming 3-channel images

    for line in yolo_annotation:
        class_id, x_center, y_center, w, h = map(float, line.split())

        class_name = class_names[int(class_id)]
        x_min = int((x_center - w / 2) * width)
        y_min = int((y_center - h / 2) * height)
        x_max = int((x_center + w / 2) * width)
        y_max = int((y_center + h / 2) * height)

        object_elem = ET.SubElement(root, "object")
        name_elem = ET.SubElement(object_elem, "name")
        name_elem.text = class_name

        bbox = ET.SubElement(object_elem, "bndbox")
        xmin_elem = ET.SubElement(bbox, "xmin")
        xmin_elem.text = str(x_min)
        ymin_elem = ET.SubElement(bbox, "ymin")
        ymin_elem.text = str(y_min)
        xmax_elem = ET.SubElement(bbox, "xmax")
        xmax_elem.text = str(x_max)
        ymax_elem = ET.SubElement(bbox, "ymax")
        ymax_elem.text = str(y_max)

    xml_path = os.path.join(new_label_folder, os.path.basename(image_path).replace('.jpg', '.xml'))

    # ä¿å­˜æ–°çš„XMLæ–‡ä»¶ï¼Œå¹¶ä½¿ç”¨xml.dom.minidomè¿›è¡Œæ ¼å¼åŒ–
    xml_string = ET.tostring(root, encoding="utf-8")
    dom = minidom.parseString(xml_string)
    pretty_xml_string = dom.toprettyxml(indent="    ")

    # å»æ‰XMLå£°æ˜
    pretty_xml_string = '\n'.join([line for line in pretty_xml_string.split('\n') if not line.strip().startswith('<?xml')])

    with open(xml_path, "w", encoding="utf-8") as f:
        f.write(pretty_xml_string)

# Replace with the actual paths to your YOLO annotation files and image folder
yolo_annotation_dir = "æˆæƒä¹¦æ ‡æ³¨/label"
image_folder = "æˆæƒä¹¦æ ‡æ³¨/biaozhu1"
new_label_folder = "æˆæƒä¹¦æ ‡æ³¨/voc_label"

if not os.path.exists(image_folder):
    raise ValueError("Image folder does not exist.")

yolo_annotation_files = os.listdir(yolo_annotation_dir)
for yolo_file in yolo_annotation_files:
    yolo_file_path = os.path.join(yolo_annotation_dir, yolo_file)
    with open(yolo_file_path, 'r') as f:
        yolo_lines = f.readlines()

    image_name = os.path.splitext(yolo_file)[0] + ".jpg"
    image_path = os.path.join(image_folder, image_name)

    if not os.path.exists(image_path):
        raise ValueError(f"Image '{image_name}' not found in the image folder.")

    yolo_to_voc(yolo_lines, image_path, new_label_folder)

```

#### YOLOv8ä¸“ç”¨æ¡†æ¶

YOLOv8å®˜æ–¹çš„ä»£ç åº“éå¸¸å®Œå–„ï¼Œå®˜æ–¹æä¾›äº†å‘½ä»¤è¡Œï¼ˆCLIï¼‰å’ŒPythonæ¥å£ï¼Œå°è£…åœ°ç›¸å½“å¥½ã€‚

[YOLOv8å®˜æ–¹ä»£ç åº“](https://github.com/ultralytics/ultralytics)

[YOLOv8å®˜æ–¹æ–‡æ¡£](https://docs.ultralytics.com/)

> ç¯å¢ƒå‡†å¤‡

ç¯å¢ƒå‡†å¤‡å…¶å®éå¸¸ç®€å•ï¼Œå‡†å¤‡ä¸€ä¸ªèƒ½ä½¿ç”¨CUDAå’ŒcuDNNçš„ç¯å¢ƒå°±å¥½ã€‚ç”±äºæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯å…¶å°è£…å¥½çš„æ¥å£ï¼Œä¸æ˜¯ä¼˜åŒ–æºä»£ç ï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€è¦ä¸‹è½½ä¸€ä¸ª`ultralytics`çš„åŒ…å°±okäº†ï¼š

```shell
$ pip install ultralytics
```

å¦‚æœéœ€è¦ä½¿ç”¨dockerï¼Œå®ƒä¹Ÿåœ¨`Docker-Hub`ä¸Šé›†æˆå¥½äº†é•œåƒï¼š[https://hub.docker.com/r/ultralytics/ultralytics](https://hub.docker.com/r/ultralytics/ultralytics)ï¼Œä¹Ÿæ”¯æŒ`Gradient`ï¼Œ`Colab`ï¼Œ`Kaggle`å¹³å°ä½¿ç”¨ï¼Œå¯¹ç™½å«–å…šä¹Ÿå¾ˆå‹å¥½ã€‚

> æ•°æ®å‡†å¤‡

YOLOv8ä½¿ç”¨çš„æ˜¯yoloæ ¼å¼çš„æ•°æ®é›†ã€‚å› ä¸ºæˆ‘ä½¿ç”¨çš„æ˜¯å…¶æ£€æµ‹çš„åˆ†æ”¯ï¼Œæ‰€ä»¥æˆ‘ä»¬å‡†å¤‡ä¸€ä¸ªæ£€æµ‹çš„æ•°æ®é›†ã€‚æ•°æ®é›†çš„æ–‡ä»¶ç»„ç»‡æ–¹å¼å¦‚ä¸‹ï¼š

```scss
- æ•°æ®é›†åç§°
-- dataset
--- score
---- images
----- train
...//æ”¾ç½®å›¾ç‰‡
----- val
...//æ”¾ç½®å›¾ç‰‡
---- labels
----- train
...//æ”¾ç½®txtæ ‡ç­¾æ–‡ä»¶
----- val
...//æ”¾ç½®txtæ ‡ç­¾æ–‡ä»¶
```

ç¼–å†™ä¸€ä¸ªå…³äºæ•°æ®é›†çš„yamlæ–‡ä»¶ï¼Œ`data.yaml`:

```yaml
# Train/val/test sets as 1) dir: path/to/imgs, 2) file: path/to/imgs.txt, or 3) list: [path/to/imgs1, path/to/imgs2, ..]
train: ./YOLO_Authorize_letter/dataset/score/images/train # train images
val: ./YOLO_Authorize_letter/dataset/score/images/val # val images
# test:  # test images (optional)

# Classes æ³¨æ„è¿™é‡Œçš„ç±»åˆ«å’Œæ ‡ç­¾çš„ç±»åˆ«è¦å¯¹åº”
names:
  0: class1
  1: class2
  2: class3
  3: class4
  4: class5
  5: class6
  6: class7
```

ä½¿ç”¨å®˜æ–¹æä¾›çš„æ¨¡å‹yamlæ–‡ä»¶ï¼Œ`yolov8.yaml`ï¼š

```yaml
# Ultralytics YOLO ğŸš€, AGPL-3.0 license
# YOLOv8 object detection model with P3-P5 outputs. For Usage examples see https://docs.ultralytics.com/tasks/detect

# Parameters
nc: 7  # number of classes
scales: # model compound scaling constants, i.e. 'model=yolov8n.yaml' will call yolov8.yaml with scale 'n'
  # [depth, width, max_channels]
  n: [0.33, 0.25, 1024]  # YOLOv8n summary: 225 layers,  3157200 parameters,  3157184 gradients,   8.9 GFLOPs
  s: [0.33, 0.50, 1024]  # YOLOv8s summary: 225 layers, 11166560 parameters, 11166544 gradients,  28.8 GFLOPs
  m: [0.67, 0.75, 768]   # YOLOv8m summary: 295 layers, 25902640 parameters, 25902624 gradients,  79.3 GFLOPs
  l: [1.00, 1.00, 512]   # YOLOv8l summary: 365 layers, 43691520 parameters, 43691504 gradients, 165.7 GFLOPs
  x: [1.00, 1.25, 512]   # YOLOv8x summary: 365 layers, 68229648 parameters, 68229632 gradients, 258.5 GFLOPs

# YOLOv8.0n backbone
backbone:
  # [from, repeats, module, args]
  - [-1, 1, Conv, [64, 3, 2]]  # 0-P1/2
  - [-1, 1, Conv, [128, 3, 2]]  # 1-P2/4
  - [-1, 3, C2f, [128, True]]
  - [-1, 1, Conv, [256, 3, 2]]  # 3-P3/8
  - [-1, 6, C2f, [256, True]]
  - [-1, 1, Conv, [512, 3, 2]]  # 5-P4/16
  - [-1, 6, C2f, [512, True]]
  - [-1, 1, Conv, [1024, 3, 2]]  # 7-P5/32
  - [-1, 3, C2f, [1024, True]]
  - [-1, 1, SPPF, [1024, 5]]  # 9

# YOLOv8.0n head
head:
  - [-1, 1, nn.Upsample, [None, 2, 'nearest']]
  - [[-1, 6], 1, Concat, [1]]  # cat backbone P4
  - [-1, 3, C2f, [512]]  # 12

  - [-1, 1, nn.Upsample, [None, 2, 'nearest']]
  - [[-1, 4], 1, Concat, [1]]  # cat backbone P3
  - [-1, 3, C2f, [256]]  # 15 (P3/8-small)

  - [-1, 1, Conv, [256, 3, 2]]
  - [[-1, 12], 1, Concat, [1]]  # cat head P4
  - [-1, 3, C2f, [512]]  # 18 (P4/16-medium)

  - [-1, 1, Conv, [512, 3, 2]]
  - [[-1, 9], 1, Concat, [1]]  # cat head P5
  - [-1, 3, C2f, [1024]]  # 21 (P5/32-large)

  - [[15, 18, 21], 1, Detect, [nc]]  # Detect(P3, P4, P5)

```

ä½¿ç”¨è¯¥æ–‡ä»¶éœ€è¦æ³¨æ„çš„æ˜¯ï¼š`nc`éœ€è¦æ ¹æ®è‡ªå·±æ•°æ®é›†çš„åˆ†ç±»æ•°è¿›è¡Œæ”¹å˜ï¼Œä¸ä¸Šé¢çš„`data.yaml`çš„ç±»åˆ«éœ€è¦å¯¹åº”ã€‚

> è®­ç»ƒå‡†å¤‡

æ–°å»ºä¸€ä¸ªYOLOv8æ ¹ç›®å½•ï¼Œå°†æ•°æ®é›†ä»¥åŠä¸Šè¿°ä¸¤ä¸ªæ–‡ä»¶æ”¾ç½®åœ¨æ ¹ç›®å½•ä¸Šï¼Œè¿è¡Œå®˜æ–¹ç»™çš„è®­ç»ƒç¤ºä¾‹ï¼š

```shell
$ yolo train data=coco128.yaml model=yolov8m.yaml epochs=10 lr0=0.01
```

éœ€è¦æ³¨æ„çš„æ˜¯è™½ç„¶æˆ‘ä»¬çš„æ–‡ä»¶æ˜¯`yolov8.yaml`ï¼Œæˆ‘ä»¬ä½¿ç”¨`yolov8n.yaml`ä¼šç›´æ¥è¿›è¡Œè§£æï¼Œéå¸¸æ–¹ä¾¿ã€‚

ä½†ç®€å•çš„å‚æ•°è°ƒæ•´ä¸è¶³ä»¥ä½¿ç”¨ï¼Œæˆ‘ä»¬è¦è·å–å…¨å±€çš„å‚æ•°è°ƒæ•´ï¼Œå¯ä»¥ä½¿ç”¨ä¸‹é¢è¿™ç§æ–¹å¼ï¼š

* é¦–å…ˆåœ¨å‘½ä»¤è¡Œè¾“å…¥ï¼š

```shell
$ yolo copy-cfg
```

è¿™æ—¶å¯ä»¥çœ‹åˆ°æ ¹ç›®å½•å‡ºç°äº†ä¸€ä¸ª`default_copy.yaml`æ–‡ä»¶

* ä¿®æ”¹`default_copy.yaml`æ–‡ä»¶çš„å†…å®¹å¹¶ä¿å­˜ï¼Œæ¯ä¸ªå‚æ•°çš„å«ä¹‰å¯ä»¥çœ‹å®˜æ–¹æ–‡æ¡£ï¼Œè¿™é‡Œç»™å‡ ä¸ªè®­ç»ƒæ—¶é‡è¦çš„å‚æ•°ï¼š
  * task: æä¾›çš„é€‰é¡¹æœ‰*detect, segment, classify, pose*ï¼Œåˆ†åˆ«å¯¹åº”æ£€æµ‹ï¼Œåˆ†å‰²ï¼Œåˆ†ç±»ï¼Œå§¿æ€ä¼°è®¡ã€‚
  * mode: æä¾›çš„é€‰é¡¹æœ‰*train, val, predict, export, track, benchmark*ï¼Œåˆ†åˆ«ä»£è¡¨è®­ç»ƒï¼ŒéªŒè¯ï¼Œé¢„æµ‹ï¼Œå¯¼å‡ºï¼Œè·Ÿè¸ªï¼ŒåŸºå‡†æµ‹è¯•ã€‚å¡«å…¥`train`ã€‚
  * model: å¯ä»¥ä½¿ç”¨ptæ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨yamlæ–‡ä»¶ã€‚è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨`yolov8m.yaml`
  * data: æŒ‡å®šçš„æ•°æ®é›†é…ç½®æ–‡ä»¶ï¼Œè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨`data.yaml`
  * epoch: è®­ç»ƒçš„è½®æ•°ï¼Œ**æ•°æ®é›†è¶Šå°ï¼Œéœ€è¦çš„è½®æ•°è¶Šå¤š**ã€‚
  * patience: æŒ‡å®šæœ‰å¤šå°‘è½®åæŒ‡æ ‡åä¼˜æ˜æ˜¾çš„å¢é•¿åˆ™åœæ­¢è®­ç»ƒï¼ˆearly stopçš„è®­ç»ƒç­–ç•¥ï¼‰ã€‚ä½¿ç”¨é»˜è®¤çš„50
  * batch: æ ¹æ®GPUçš„æ˜¾å­˜æ¥åˆç†è®¾ç½®ï¼Œä¸€èˆ¬ä¸º2çš„æ¬¡æ–¹
  * imgsz: ä¸€èˆ¬ä½¿ç”¨640
  * device: æŒ‡å®šGPUè®¾å¤‡ï¼Œæœ‰ä¸‰ç§é€‰é¡¹ï¼Œå•å¡ï¼Œå¤šå¡å’Œcpuï¼Œåˆ†åˆ«å¯¹åº”*device=0 or device=0,1,2,3 or device=cpu*ã€‚åœ¨Linuxä¸Šå¯ä»¥ä½¿ç”¨`nvidia-smi`æ¥æŸ¥çœ‹ä½ çš„GPUè®¾å¤‡ä¿¡æ¯ã€‚
  * workers: ä»£è¡¨å¤šçº¿ç¨‹è¯»å–æ•°æ®ï¼Œå»ºè®®æŒ‡å®šä½ä¸€ç‚¹ï¼Œå°¤å…¶æ˜¯æœåŠ¡å™¨ä¸Šå¤šäººä½¿ç”¨æ—¶ï¼ŒæŒ‡å®šè¿‡å¤šå°±ä¼šæŠ¥é”™ã€‚æˆ‘ä»¬åˆ¶å®šä¸º2ã€‚

* è¦†ç›–é»˜è®¤çš„é…ç½®è¿›è¡Œè®­ç»ƒï¼š

```shell
$ yolo cfg='default_copy.yaml'
```

* æŸ¥çœ‹è®­ç»ƒçš„ç»“æœï¼š

è®­ç»ƒç»“æœä¼šåœ¨æ ¹ç›®å½•ä¸‹çš„`runs/detect/train`æ–‡ä»¶å¤¹ä¸‹ï¼Œå¦‚æœæ˜¯ç¬¬äºŒæ¬¡å¯åŠ¨è®­ç»ƒåˆ™ä¼šåœ¨`runs/detect/train2`æ–‡ä»¶å¤¹ä¸‹ã€‚ä¹Ÿå¯ä»¥é€šè¿‡ç»ˆç«¯æç¤ºçš„å‘½ä»¤åœ¨TensorBoardæŸ¥çœ‹ï¼Œå¦‚æœæ˜¯æœåŠ¡å™¨ä¸Šï¼Œå°±éœ€è¦ä½¿ç”¨æœåŠ¡å™¨ç«¯å£æ˜ å°„çš„æœåŠ¡ï¼Œåœ¨ä¸Šæ–‡æœ‰è®²ã€‚

> ç”¨è®­ç»ƒå¾—åˆ°çš„æ¨¡å‹è¿›è¡Œé¢„æµ‹

æˆ‘ä»¬ä»ç„¶å¯ä»¥ä½¿ç”¨CLIçš„æ–¹å¼è¿è¡Œï¼Œåªéœ€è¦ä¿®æ”¹modeçš„modelä»¥åŠpredicté‚£ä¸€æ çš„å‚æ•°ã€‚ä½†æˆ‘å¹¶ä¸æ¨èè¿™ç§æ–¹å¼ï¼Œå› ä¸ºæˆ‘ä»¬é€šå¸¸çš„ç›®çš„å¹¶ä¸æ˜¯å•çº¯æ£€æµ‹ï¼Œè€Œæ˜¯ä¸ºäº†æ£€æµ‹å‡ºåè·å–åæ ‡è¿›è¡Œåç»­æ“ä½œã€‚

æ‰€ä»¥æˆ‘ä»¬ä½¿ç”¨pythonæ¥å£çš„æ–¹å¼ï¼Œå®˜æ–¹ç»™çš„å°ç¤ºä¾‹ï¼š

```python
from ultralytics import YOLO

model = YOLO("runs/detect/train/weights/best.pt")
# accepts all formats - image/dir/Path/URL/video/PIL/ndarray. 0 for webcam
# sourceè¿™é‡Œæ”¾å­˜æ”¾éœ€è¦é¢„æµ‹å›¾ç‰‡çš„æ–‡ä»¶ä½ç½®
results = model.predict(source="...", save=True) 
```

**éœ€è¦æ³¨æ„çš„æ˜¯predictä¸­æ¥å—çš„å‚æ•°è¿˜æœ‰å¾ˆå¤šï¼Œæ¯”å¦‚æ¯”è¾ƒé‡è¦çš„æœ‰`conf`ï¼Œä»£è¡¨æˆ‘ä»¬ä¿ç•™é¢„æµ‹æ¡†çš„ç½®ä¿¡åº¦ï¼Œ`imgsz`ä»£è¡¨æ¨¡å‹æ¨ç†çš„è¾“å…¥å°ºå¯¸å¤§å°ï¼Œé»˜è®¤ä¸ºï¼ˆ640ï¼Œ640ï¼‰ï¼Œ`line_width`ä»£è¡¨æ£€æµ‹æ¡†çš„ç²—å¿ƒï¼Œåªèƒ½ä¸ºintå€¼ã€‚æ›´å¤šçš„å‚æ•°è®¾ç½®å‚è€ƒå®˜æ–¹æ–‡æ¡£**

é¢„æµ‹çš„ç»“æœä¼šä¿å­˜åœ¨`runs/detect/predict`ï¼Œå¦‚æœæ˜¯ç¬¬äºŒæ¬¡é¢„æµ‹ä¼šä¿å­˜åœ¨`runs/detect/predict2`ï¼Œä¾æ¬¡ç±»æ¨ã€‚

ä¸ºäº†äº†è§£resultsçš„å†…å®¹ï¼Œå°†ä¸€å¼ å›¾ç‰‡çš„é¢„æµ‹çš„ç»“æœresultsè¾“å‡ºä¸€ä¸‹ï¼š

```scss
boxes: ultralytics.engine.results.Boxes object
keypoints: None
keys: ['boxes']
masks: None
names: {0: 'company_name', 1: 'signature', 2: 'authorized_name', 3: 'telephone_number', 4: 'id_number', 5: 'mobile_branch_name', 6: 'date'}
orig_img: array([[[ 94, 107, 123],
        [ 93, 106, 122],
        [ 92, 105, 121],
        ...,
        [ 81, 102, 117],
        [ 79, 100, 115],
        [ 78,  99, 114]],

       [[ 95, 108, 124],
        [ 94, 107, 123],
        [ 93, 106, 122],
        ...,
        [ 77,  98, 113],
        [ 77,  98, 113],
        [ 78,  99, 114]],

       [[ 95, 108, 124],
        [ 95, 108, 124],
        [ 94, 107, 123],
        ...,
        [ 76,  97, 112],
        [ 76,  97, 112],
        [ 78,  99, 114]],

       ...,

       [[100, 120, 138],
        [100, 120, 138],
        [ 99, 119, 137],
        ...,
        [115, 135, 153],
        [113, 133, 151],
        [114, 134, 152]],

       [[101, 118, 137],
        [101, 118, 137],
        [101, 118, 137],
        ...,
        [116, 136, 154],
        [115, 135, 153],
        [114, 134, 152]],

       [[100, 117, 136],
        [100, 117, 136],
        [100, 117, 136],
        ...,
        [118, 138, 156],
        [117, 137, 155],
        [113, 133, 151]]], dtype=uint8)
orig_shape: (3648, 2736)
path: '/data/caixj/ultralytics-main/test_imgs/ed257e76-cec1-11ed-b87c-58961d2b4192.jpg'
probs: None
save_dir: None
speed: {'preprocess': 3.3495426177978516, 'inference': 32.27806091308594, 'postprocess': 1.6703605651855469}]
```

ç»“åˆå®˜æ–¹æ–‡æ¡£ï¼Œå‘ç°æˆ‘ä»¬éœ€è¦çš„æ£€æµ‹æ¡†çš„åæ ‡ä¿¡æ¯åœ¨boxeså¯¹è±¡ä¸­ã€‚boxeså¯¹è±¡çš„å±æ€§ä¿¡æ¯å¦‚ä¸‹ï¼š

```
boxes.xyxy  # æ£€æµ‹æ¡†çš„ç»å¯¹å€¼åæ ‡ï¼Œåˆ†åˆ«æ˜¯min_x,min_y,max_x,max_y
boxes.xywh  # æ£€æµ‹æ¡†çš„ç»å¯¹å€¼åæ ‡ï¼Œåˆ†åˆ«æ˜¯ä¸­å¿ƒç‚¹åæ ‡å’Œå®½é«˜
boxes.xyxyn  # æ£€æµ‹æ¡†çš„å½’ä¸€åŒ–åæ ‡ï¼Œåˆ†åˆ«æ˜¯min_x,min_y,max_x,max_y 
boxes.xywhn  # æ£€æµ‹æ¡†çš„å½’ä¸€åŒ–åæ ‡ï¼Œåˆ†åˆ«æ˜¯ä¸­å¿ƒç‚¹åæ ‡å’Œå®½é«˜
boxes.conf  # æ£€æµ‹æ¡†çš„ç½®ä¿¡åˆ†æ•°
boxes.cls  # ç±»åˆ«, (N, )
boxes.data  # åŸå§‹ç›®æ ‡æ¡†å‚æ•°åæ ‡ (x, y, w, h)ã€ç½®ä¿¡åº¦ä»¥åŠç±»åˆ«, (N, 6) or boxes.boxes
```

ä¸ºäº†å®Œæˆæˆ‘ä»¬åˆ‡å‰²åŒºåŸŸçš„éœ€æ±‚ï¼Œæˆ‘ä»¬æ¥ç¼–å†™ä¸€ä¸ªå°çš„è„šæœ¬è¿›è¡Œæ‰¹é‡æ“ä½œï¼š

```python
from ultralytics import YOLO
from PIL import Image
import cv2
import numpy as np
import os


def process_image_with_yolov8(image, detections, image_out):
    
    # è·å–åŸå§‹å›¾åƒçš„å°ºå¯¸
    height, width = image.shape[:2]

    # åˆ›å»ºå…¨é»‘é®ç½©ï¼Œä¸åŸå§‹å›¾åƒå°ºå¯¸ç›¸åŒ
    mask = np.zeros((height, width), dtype=np.uint8)

    # å°†æ£€æµ‹åˆ°çš„åŒºåŸŸè®¾ä¸ºéé›¶å€¼
    for box in detections:
        x_min, y_min, x_max, y_max = box[:4]
        x_min, x_max = int(x_min * width), int(x_max * width)
        y_min, y_max = int(y_min * height), int(y_max * height)
        mask[y_min:y_max, x_min:x_max] = 255  # è®¾ç½®ä¸º255ï¼Œå³ç™½è‰²ï¼Œä¹Ÿå¯ä»¥è®¾ç½®ä¸º1
        
    
    # å°†åŸå§‹å›¾åƒä¸é®ç½©å›¾åƒç›¸ä¹˜ï¼Œå¾—åˆ°åªæœ‰æ£€æµ‹åŒºåŸŸä¿æŒåŸå§‹åƒç´ å€¼ï¼Œå…¶ä»–åŒºåŸŸéƒ½å˜ä¸º0çš„å›¾åƒ
    result_image = cv2.bitwise_and(image, image, mask=mask)

    # ä¿å­˜ç»“æœå›¾
    cv2.imwrite(image_out, result_image)

if __name__ == "__main__":
    image_dir = "test_imgs"
    images_process = "images_process"

    model = YOLO("runs/detect/train/weights/best.pt")
    # accepts all formats - image/dir/Path/URL/video/PIL/ndarray. 0 for webcam
    results = model.predict(source=image_dir, save=False, conf=0.45, device=1, line_width=2) # 
    # print(results)

    for i in range(len(results)):
      	# è¯»å–resultsç»“æœå†…çš„åŸå§‹å›¾åƒ
        # æœ€å¥½ä¸è¦é€šè¿‡cv2å’ŒPILç­‰é‡æ–°è¯»å…¥ï¼Œå®æµ‹å’Œé¢„æµ‹æ¡†çš„ç»“æœä¼šæœ‰åå·®
        image = results[i].orig_img
        image_name = results[i].path.split('/')[-1]
        image_out = os.path.join(images_process, image_name)
        result = results[i].cpu().numpy()
        # è·å–å½’ä¸€åŒ–çš„åæ ‡
        detections = result.boxes.xyxyn
        print("è¯¥å¼ å›¾åƒçš„æ£€æµ‹æ¡†åæ ‡åˆ†åˆ«ä¸ºï¼š")
        print(detections)
        process_image_with_yolov8(image, detections, image_out) 
```

#### Logæ—¥å¿—ä½¿ç”¨

> logæ—¥å¿—çš„çº§åˆ«

`logging` æ¨¡å—å®šä¹‰äº†å‡ ä¸ªä¸åŒçº§åˆ«çš„æ—¥å¿—ï¼Œä»é«˜åˆ°ä½çš„é¡ºåºå¦‚ä¸‹ï¼š

1. `CRITICAL`ï¼ˆæœ€é«˜çº§åˆ«ï¼‰ï¼šç”¨äºæŒ‡ç¤ºä¸¥é‡çš„é”™è¯¯ï¼Œå¯èƒ½å¯¼è‡´ç¨‹åºæ— æ³•ç»§ç»­è¿è¡Œã€‚
2. `ERROR`ï¼šç”¨äºæŒ‡ç¤ºç¨‹åºè¿è¡Œæ—¶çš„é”™è¯¯ï¼Œä½†ç¨‹åºä»ç„¶å¯ä»¥ç»§ç»­è¿è¡Œã€‚
3. `WARNING`ï¼šç”¨äºè¡¨ç¤ºè­¦å‘Šä¿¡æ¯ï¼Œå¯èƒ½è¡¨æ˜ç¨‹åºå‡ºç°äº†ä¸€äº›æ„å¤–æƒ…å†µï¼Œä½†ä»ç„¶åœ¨æ­£å¸¸è¿è¡Œã€‚
4. `INFO`ï¼šç”¨äºä¸€èˆ¬æ€§çš„ä¿¡æ¯è®°å½•ï¼Œç”¨æ¥è¿½è¸ªç¨‹åºçš„æ‰§è¡ŒçŠ¶æ€ã€‚
5. `DEBUG`ï¼ˆæœ€ä½çº§åˆ«ï¼‰ï¼šç”¨äºè°ƒè¯•ç›®çš„ï¼Œè®°å½•è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯ï¼Œä¸€èˆ¬åœ¨å¼€å‘å’Œè°ƒè¯•é˜¶æ®µä½¿ç”¨ã€‚

è¿™äº›æ—¥å¿—çº§åˆ«çš„åŒºåˆ«åœ¨äºå®ƒä»¬çš„ä¸¥é‡ç¨‹åº¦å’Œç›®çš„ã€‚ä½ å¯ä»¥æ ¹æ®ä¸åŒçš„åœºæ™¯å’Œéœ€æ±‚ï¼Œé€‰æ‹©é€‚å½“çš„æ—¥å¿—çº§åˆ«æ¥è®°å½•ä¿¡æ¯ã€‚

å¦‚æœä½ å¸Œæœ›åŒæ—¶ä¿å­˜å¤šä¸ªçº§åˆ«çš„æ—¥å¿—ï¼Œå¯ä»¥ä½¿ç”¨å¤šä¸ªæ—¥å¿—å¤„ç†ç¨‹åºï¼Œæ¯ä¸ªå¤„ç†ç¨‹åºè´Ÿè´£å¤„ç†ä¸€ä¸ªç‰¹å®šçº§åˆ«çš„æ—¥å¿—ã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼Œå±•ç¤ºäº†å¦‚ä½•åŒæ—¶ä¿å­˜ `DEBUG`ã€`INFO`ã€`WARNING`ã€`ERROR` å’Œ `CRITICAL` äº”ä¸ªçº§åˆ«çš„æ—¥å¿—ã€‚

```python
import os
import logging
from datetime import datetime

# ç¡®ä¿logsæ–‡ä»¶å¤¹å­˜åœ¨
if not os.path.exists('logs'):
    os.makedirs('logs')

# è·å–å½“å‰æ—¶é—´å¹¶æ ¼å¼åŒ–ä¸ºå­—ç¬¦ä¸²
current_time = datetime.now().strftime('%Y-%m-%d_%H-%M-%S')

# è®¾ç½®æ—¥å¿—æ–‡ä»¶å
log_filename = os.path.join('logs', f'{current_time}-server.log')

# é…ç½®æ—¥å¿—
logging.basicConfig(filename=log_filename, level=logging.DEBUG,
                    format='%(asctime)s - %(levelname)s - %(message)s')

# è·å–ä¸€ä¸ªLoggerå®ä¾‹
logger = logging.getLogger(__name__)

# åˆ›å»ºä¸€ä¸ªæ–‡ä»¶å¤„ç†ç¨‹åºæ¥ä¿å­˜æ‰€æœ‰çº§åˆ«çš„æ—¥å¿—
file_handler = logging.FileHandler(log_filename)
file_handler.setLevel(logging.DEBUG)

# åˆ›å»ºä¸€ä¸ªæ§åˆ¶å°å¤„ç†ç¨‹åºæ¥è¾“å‡ºINFOçº§åˆ«ä»¥ä¸Šçš„æ—¥å¿—åˆ°æ§åˆ¶å°
console_handler = logging.StreamHandler()
console_handler.setLevel(logging.INFO)

# åˆ›å»ºä¸€ä¸ªæ ¼å¼åŒ–å™¨
formatter = logging.Formatter('%(asctime)s - %(levelname)s - %(message)s')
file_handler.setFormatter(formatter)
console_handler.setFormatter(formatter)

# å°†å¤„ç†ç¨‹åºæ·»åŠ åˆ°Loggerå®ä¾‹
logger.addHandler(file_handler)
logger.addHandler(console_handler)

def process_data(data):
    try:
        # ... ä¸€äº›å¤„ç†é€»è¾‘
        
        # è®°å½•æ—¥å¿—
        logger.debug("Debug message: %s", data)
        logger.info("Info message: %s", data)
        logger.warning("Warning message: %s", data)
        logger.error("Error message: %s", data)
        logger.critical("Critical message: %s", data)
        
        return "Data processed successfully."
    except Exception as e:
        # è®°å½•å¼‚å¸¸æ—¥å¿—
        logger.exception("An exception occurred: %s", str(e))
        return "An error occurred."

if __name__ == '__main__':
    data = "Some data to process"
    result = process_data(data)
    print(result)
```

åœ¨ä¸Šè¿°ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªæ–‡ä»¶å¤„ç†ç¨‹åº `file_handler` æ¥ä¿å­˜æ‰€æœ‰çº§åˆ«çš„æ—¥å¿—ï¼Œå¹¶å°†å®ƒæ·»åŠ åˆ° Logger å®ä¾‹ä¸­ã€‚åŒæ—¶ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªæ§åˆ¶å°å¤„ç†ç¨‹åº `console_handler` æ¥è¾“å‡º `INFO` çº§åˆ«ä»¥ä¸Šçš„æ—¥å¿—åˆ°æ§åˆ¶å°ï¼Œå¹¶å°†å®ƒä¹Ÿæ·»åŠ åˆ° Logger å®ä¾‹ä¸­ã€‚è¿™æ ·ï¼Œä½ å°±å¯ä»¥åŒæ—¶ä¿å­˜ `DEBUG`ã€`INFO`ã€`WARNING`ã€`ERROR` å’Œ `CRITICAL` äº”ä¸ªçº§åˆ«çš„æ—¥å¿—ï¼Œå¹¶ä¸”åœ¨æ§åˆ¶å°ä¸Šè¾“å‡ºä¸€éƒ¨åˆ†çº§åˆ«çš„ä¿¡æ¯ã€‚

#### æ¥å£çš„å°è£…

è¯¥éƒ¨åˆ†ç”±äºæ¶‰åŠå…¬å¸çš„ä»£ç ï¼Œåªè®²æ€è·¯ã€‚é€šå¸¸æ‰“åŒ…éœ€è¦ä¸¤ä¸ªæ–‡ä»¶ï¼Œä¸€ä¸ªæ˜¯åŒ…å«ç¯å¢ƒå˜é‡çš„é•œåƒæ–‡ä»¶ï¼Œå¦ä¸€ä¸ªåˆ™æ˜¯é¡¹ç›®çš„æºä»£ç åŒ…ã€‚

å·¥ç¨‹çš„æ ‡å‡†ï¼š

* ä¸€èˆ¬éœ€è¦å°†å¯ä»¥è®¾ç½®çš„å‚æ•°æ–‡ä»¶ç»Ÿä¸€é›†æˆåˆ°ä¸€ä¸ªé…ç½®æ–‡ä»¶ä¸­ã€‚å¦‚æœé…ç½®å‚æ•°è¿‡å¤šï¼Œè¿˜å¯ä»¥åˆ†æ–‡ä»¶å­˜å‚¨ï¼Œä¸€èˆ¬æ”¾åœ¨`config`æ–‡ä»¶å¤¹ä¸‹ã€‚
* æ¨¡å‹å‚æ•°æƒé‡åˆ™ä¸€èˆ¬æ”¾åœ¨ä¸€ä¸ªä¸“é—¨çš„`models`æˆ–è€…`checkpoints`æ–‡ä»¶å¤¹ä¸‹é¢
* ä½¿ç”¨onnxï¼Œtensorrtæ¨ç†ï¼Œæ˜¯ä¸éœ€è¦æ¨¡å‹æ–‡ä»¶çš„ã€‚å¦‚æœç›´æ¥ç”¨pytorchæ¨ç†ï¼Œä¸€èˆ¬éœ€è¦ä¸€ä¸ªæ¨¡å‹æ–‡ä»¶ï¼Œä»¥åŠä¸€äº›å‰å¤„ç†å’Œåå¤„ç†çš„æ–‡ä»¶ã€‚è¿™é‡Œä½¿ç”¨çš„æ˜¯yolov8å®˜æ–¹æä¾›çš„æ¨ç†åŒ…ï¼Œåˆ™ä¸éœ€è¦æ¨¡å‹æ–‡ä»¶äº†ã€‚
* ä¸»å‡½æ•°ä¸è¦é›†æˆå¤ªå¤šçš„æ–¹æ³•ï¼Œå°½é‡åˆ†æ–‡ä»¶å†™
* ç¨‹åºä¸­éœ€è¦åŒ…å«è¯¦ç»†çš„æ—¥å¿—è®°å½•ï¼Œå¹¶éœ€è¦è‡ªåŠ¨ä¿å­˜åœ¨ä¸€ä¸ªå•ç‹¬çš„æ–‡ä»¶å¤¹ä¸­ã€‚ä¸€èˆ¬ä½¿ç”¨`logs`æ–‡ä»¶å¤¹ã€‚

#### Linuxä¸‹æ‰“åŒ…ä¸è§£å‹

> æ‰“åŒ…å›¾ç‰‡tar

`tar` æ˜¯Linuxä¸­æœ€å¸¸ç”¨çš„æ‰“åŒ…å‹ç¼©å·¥å…·ï¼Œè¯¥å‘½ä»¤å¯ä»¥æŠŠä¸€ç³»åˆ—æ–‡ä»¶æ‰“åŒ…åˆ°ä¸€ä¸ªå¤§æ–‡ä»¶ä¸­ï¼Œä¹Ÿå¯ä»¥æŠŠä¸€ä¸ªå¤§æ–‡ä»¶æ¢å¤ä¸€ç³»åˆ—æ–‡ä»¶ã€‚æ‰“åŒ…/è§£åŒ…çš„æ ¼å¼å¦‚ä¸‹ï¼š

```shell
# æ‰“åŒ…æ–‡ä»¶ï¼ˆæ‰“åŒ…æ–‡ä»¶çš„åç¼€åä¸€èˆ¬ä½¿ç”¨çš„æ˜¯.tarï¼‰
tar -cvf æ‰“åŒ…æ–‡ä»¶.tar è¢«æ‰“åŒ…çš„æ–‡ä»¶æ‰€åœ¨è·¯å¾„
# ä¸€æ¬¡å¯ä»¥æ‰“åŒ…å¤šä¸ªæ–‡ä»¶
tar -cvf pkg.tar a.txt b.txt c.txt 
 
# è§£åŒ…æ–‡ä»¶
tar -xvf æ‰“åŒ…æ–‡ä»¶.tar
```

taré€‰é¡¹è¯´æ˜ï¼š

| é€‰é¡¹ |                        å«ä¹‰                        |
| :--: | :------------------------------------------------: |
|  -c  |             ç”Ÿæˆæ¡£æ¡ˆæ–‡ä»¶ï¼Œåˆ›å»ºæ‰“åŒ…æ–‡ä»¶             |
|  -x  |                    è§£å¼€æ¡£æ¡ˆæ–‡ä»¶                    |
|  -v  |          åˆ—å‡ºå½’æ¡£æ¥æ¡£çš„è¯¦ç»†è¿‡ç¨‹ï¼Œæ˜¾ç¤ºè¿›åº¦          |
|  -f  | æŒ‡å®šæ¡£æ¡ˆæ–‡ä»¶ï¼Œfåé¢ä¸€å®šæ˜¯.tar æ–‡ä»¶ï¼Œå¿…é¡»æ”¾é€‰é¡¹æœ€å |

> tarä¸gzipç›¸ç»“åˆ

tar å’Œ gzip ç»“åˆå¯ä»¥å®ç°æ–‡ä»¶çš„æ‰“åŒ…å‹ç¼©ã€‚tar åªè´Ÿè´£æ‰“åŒ…ï¼Œä¸è´Ÿè´£å‹ç¼©ï¼›gzip è´Ÿè´£å‹ç¼©ï¼Œå‹ç¼©ä»¥åçš„æ‰©å±•åä¸º xxx.tar.gzï¼ˆç”±æ‰©å±•åå¯ä»¥çœ‹å‡ºï¼Œè¿™ä¸ªå‹ç¼©åŒ…ç»å†äº†æ‰“åŒ…å’Œå‹ç¼©ä¸¤ä¸ªè¿‡ç¨‹ï¼‰ã€‚tar å‘½ä»¤ä¸­æœ‰ä¸€ä¸ª -z é€‰é¡¹å¯ä»¥è°ƒç”¨ gzipï¼Œä»è€Œè¾¾åˆ°æ‰“åŒ…å‹ç¼©ä¸€æ­¥åˆ°ä½çš„æ•ˆæœã€‚åŸºæœ¬å‘½ä»¤æ ¼å¼å¦‚ä¸‹ï¼š

```shell
# å‹ç¼©æ–‡ä»¶
tar -zcvf å‹ç¼©æ–‡ä»¶.tar.gz è¢«å‹ç¼©çš„æ–‡ä»¶æ‰€åœ¨è·¯å¾„
# ä¸€æ¬¡å¯ä»¥å‹ç¼©å¤šä¸ªæ–‡ä»¶
tar -zcvf pkg.tar.gz a.txt b.txt c.txt 
 
# è§£å‹æ–‡ä»¶
tar -zxvf å‹ç¼©æ–‡ä»¶.tar.gz
 
# -C:è§£å‹æ–‡ä»¶åˆ°æŒ‡å®šè·¯å¾„
tar -zxvf å‹ç¼©æ–‡ä»¶.tar.gz -C /usr
```

> tarä¸bzip2ç›¸ç»“åˆ

ä½¿ç”¨æ–¹å¼å’Œä¸Šé¢çš„`gzip`ååˆ†ç±»ä¼¼ï¼Œtar å‘½ä»¤ä¸­æœ‰ä¸€ä¸ª`-j`é€‰é¡¹å¯ä»¥è°ƒç”¨`bzip2`ï¼Œä»è€Œå¯ä»¥æ–¹ä¾¿çš„å®ç°å‹ç¼©å’Œè§£å‹ç¼©ã€‚å‘½ä»¤æ ¼å¼å¦‚ä¸‹ï¼š

```shell
# å‹ç¼©æ–‡ä»¶(å°†æ–‡ä»¶å‹ç¼©æˆ xxx.tar.bz2æ ¼å¼)
tar -jcvf å‹ç¼©æ–‡ä»¶.tar.bz2 è¢«å‹ç¼©çš„æ–‡ä»¶æ‰€åœ¨è·¯å¾„
 
# è§£å‹æ–‡ä»¶
tar -jxvf å‹ç¼©æ–‡ä»¶.tar.bz2
 
# è§£å‹æ–‡ä»¶åˆ°æŒ‡å®šè·¯å¾„
tar -jxvf å‹ç¼©æ–‡ä»¶.tar.bz2 -C /usr
```

> Linuxä¸‹ä¸åŒæ ¼å¼è½¯ä»¶åŒ…çš„å®‰è£…ï¼ˆé»˜è®¤Ubuntuï¼‰

* debåŒ…ï¼š

```shell
# å®‰è£…debåŒ…
sudo dpkg -i åŒ…å.deb
# å¸è½½debåŒ…
sudo apt-get remove åŒ…å
```

* rpmåŒ…ï¼š

```shell
# å®‰è£…
rpm -i åŒ…å.rpm
# å¸è½½
rpm -e å®Œæ•´è½¯ä»¶å
# å¦‚æœä¸çŸ¥é“å®Œæ•´åç§°ä½¿ç”¨å‘½ä»¤
rpm -qa éƒ¨åˆ†åŒ…å*
```

* binåŒ…ï¼š

```shell
# åŠ ä¸Šå¯æ‰§è¡Œçš„æƒé™
chmod +x åŒ…å.bin
# å®‰è£…
./åŒ…å.bin
# å¸è½½ï¼šæŠŠå®‰è£…çš„ç›®å½•å¸è½½å³å¯
```

* runåŒ…ï¼š

```shell
# åŠ ä¸Šå¯æ‰§è¡Œçš„æƒé™
chmod +x åŒ…å.run
# å®‰è£…
./åŒ…å.run
# å¸è½½ï¼šè¿›å…¥å®‰è£…ç›®å½•ï¼Œæ‰¾åˆ°uninstallæ–‡ä»¶
./uninstall
```

* tar.gz(bz/bz2)ç­‰

```shell
# æ ¹æ®ç±»å‹è§£å‹æ–‡ä»¶ï¼Œå‰é¢å·²ç»è®²è¿‡äº†
tar -zxvf åŒ…å.tar.gz
# éšåæŸ¥çœ‹READMEæ–‡ä»¶æˆ–è€…å…¶ä»–è¯´æ˜æ–‡ä»¶å†è¿›è¡Œæºç ç¼–è¯‘
...
```
#### Linuxä¸‹çš„è¿›ç¨‹æŸ¥çœ‹ä¸é”€æ¯
> PSå‘½ä»¤ï¼špså‘½ä»¤æ˜¯ä¸€ä¸ªç›¸å½“å¼ºå¤§åœ°Linuxè¿›ç¨‹æŸ¥çœ‹å‘½ä»¤,è¿ç”¨è¯¥å‘½ä»¤å¯ä»¥ç¡®å®šæœ‰å“ªäº›è¿›ç¨‹æ­£åœ¨è¿è¡Œå’Œè¿è¡Œåœ°çŠ¶æ€ã€ è¿›ç¨‹æ˜¯å¦ç»“æŸã€è¿›ç¨‹æœ‰æ²¡æœ‰åƒµæ­»ã€å“ªäº›è¿›ç¨‹å ç”¨äº†è¿‡å¤šåœ°èµ„æºç­‰ã€‚

* å‚æ•°ï¼š

  -eæ˜¾ç¤ºæ‰€æœ‰è¿›ç¨‹,ç¯å¢ƒå˜é‡

  -få…¨æ ¼å¼

  -hä¸æ˜¾ç¤ºæ ‡é¢˜

  -lé•¿æ ¼å¼

  -wå®½è¾“å‡º

  -aæ˜¾ç¤ºç»ˆç«¯ä¸Šåœ°æ‰€æœ‰è¿›ç¨‹,åŒ…æ‹¬å…¶ä»–ç”¨æˆ·åœ°è¿›ç¨‹

  -råªæ˜¾ç¤ºæ­£åœ¨è¿è¡Œåœ°è¿›ç¨‹

  -xæ˜¾ç¤ºæ²¡æœ‰æ§åˆ¶ç»ˆç«¯åœ°è¿›ç¨‹

```shell
ps -ef | grep java   //è¡¨ç¤ºæŸ¥çœ‹æ‰€æœ‰è¿›ç¨‹é‡ŒCMDæ˜¯javaçš„è¿›ç¨‹ä¿¡æ¯
ps -aux | grep java  //-auxæ˜¾ç¤ºæ‰€æœ‰çŠ¶æ€
```

> Topå‘½ä»¤:topå‘½ä»¤å¯ä»¥å®æ—¶æ˜¾ç¤ºå„ä¸ªçº¿ç¨‹æƒ…å†µã€‚è¦åœ¨topè¾“å‡ºä¸­å¼€å¯çº¿ç¨‹æŸ¥çœ‹ï¼Œè¯·è°ƒç”¨topå‘½ä»¤çš„â€œ-Hâ€é€‰é¡¹ï¼Œè¯¥é€‰é¡¹ä¼šåˆ—å‡ºæ‰€æœ‰Linuxçº¿ç¨‹ã€‚åœ¨topè¿è¡Œæ—¶ï¼Œä½ ä¹Ÿå¯ä»¥é€šè¿‡æŒ‰â€œHâ€é”®å°†çº¿ç¨‹æŸ¥çœ‹æ¨¡å¼åˆ‡æ¢ä¸ºå¼€æˆ–å…³ã€‚

```shell
top   // æŸ¥çœ‹æ•´ä½“æƒ…å†µï¼Œcpuï¼Œå†…å­˜ï¼Œè¿›ç¨‹ç­‰ä¿¡æ¯ 
top -Hp pid   //æŸ¥çœ‹è¿›ç¨‹ç›¸å…³çš„çº¿ç¨‹ä¿¡æ¯
ä¹Ÿå¯ä»¥é€šè¿‡htopå‘½ä»¤æŸ¥çœ‹cpuï¼Œå†…å­˜ï¼Œè¿›ç¨‹ç­‰ä¿¡æ¯
```

> Pstreeå‘½ä»¤:pgrepå‘½ä»¤ä»¥åç§°ä¸ºä¾æ®ä»è¿è¡Œè¿›ç¨‹é˜Ÿåˆ—ä¸­æŸ¥æ‰¾è¿›ç¨‹ï¼Œå¹¶æ˜¾ç¤ºæŸ¥æ‰¾åˆ°çš„è¿›ç¨‹idã€‚æ¯ä¸€ä¸ªè¿›ç¨‹IDä»¥ä¸€ä¸ªåè¿›åˆ¶æ•°è¡¨ç¤ºï¼Œé€šè¿‡ä¸€ä¸ªåˆ†å‰²å­—ç¬¦ä¸²å’Œä¸‹ä¸€ä¸ªIDåˆ†å¼€ï¼Œé»˜è®¤çš„åˆ†å‰²å­—ç¬¦ä¸²æ˜¯ä¸€ä¸ªæ–°è¡Œã€‚å¯¹äºæ¯ä¸ªå±æ€§é€‰é¡¹ï¼Œç”¨æˆ·å¯ä»¥åœ¨å‘½ä»¤è¡Œä¸ŠæŒ‡å®šä¸€ä¸ªä»¥é€—å·åˆ†å‰²çš„å¯èƒ½å€¼çš„é›†åˆã€‚

```shell
pstree -p   // æ˜¾ç¤ºå½“å‰æ‰€æœ‰è¿›ç¨‹çš„è¿›ç¨‹å·å’Œè¿›ç¨‹id
 
pstree -a   // æ˜¾ç¤ºæ‰€æœ‰è¿›ç¨‹çš„æ‰€æœ‰è¯¦ç»†ä¿¡æ¯ï¼Œé‡åˆ°ç›¸åŒçš„è¿›ç¨‹åå¯ä»¥å‹ç¼©æ˜¾ç¤º
 
pstree -apnh   //æ˜¾ç¤ºåœ¨è¿è¡Œçš„è¿›ç¨‹é—´çš„å…³ç³»
 
pstree -u //æ˜¾ç¤ºç”¨æˆ·åç§°
```

> killæ˜¯æœ€å¸¸ç”¨çš„æ€æ­»è¿›ç¨‹å‘½ä»¤ï¼Œéœ€è¦é…åˆpså‘½ä»¤å…ˆç¡®è®¤å¾…æ€æ­»è¿›ç¨‹çš„è¿›ç¨‹å·(pid)ã€‚

```shell
# å¸¸è§„ç”¨æ³•ï¼škill <pid>   // æ€æ­»æŒ‡å®špidå·çš„å•ä¸ªè¿›ç¨‹
$ kill -9 <pid>   //å¼ºåˆ¶æ€æ­»è¿›ç¨‹
 
$ killall <pname>   //æ€æ‰æ‰€æœ‰åŒåè¿›ç¨‹

$ pkill <pname>   // æ€æ‰æ‰€æœ‰åŒåè¿›ç¨‹æˆ–æŒ‡å®šç”¨æˆ·çš„æ‰€æœ‰è¿›ç¨‹
# æ¯”å¦‚æœ‰ä¸ªtomç”¨æˆ·ç¦»èŒäº†ï¼Œéœ€è¦æ¸…ç†æ‰å…¶åœ¨LinuxæœåŠ¡å™¨ä¸Šçš„æ‰€æœ‰è¿›ç¨‹ï¼Œæ‰§è¡Œæ­¤å‘½ä»¤å³å¯ã€‚
$ pkill -u tony
```

#### Flaskå¯åŠ¨æœåŠ¡

å¯åŠ¨æœåŠ¡çš„åŸºæœ¬ä½¿ç”¨æ–¹æ³•ï¼š

```python
app = Flask(__name__)
@app.route('/post', methods=['POST','GET'])
def receive_request():
	# æ¥æ”¶è¯·æ±‚çš„é€»è¾‘
  
if __name__ == '__main__':
  app.run(host=${IP}$, port=${port}$)
```

å¤–éƒ¨è¯·æ±‚æµ‹è¯•ç¨‹åºï¼ˆå›¾ç‰‡base64æ•°æ®è¯·æ±‚ï¼‰ï¼š

```python
import os
import requests
import base64
import logging
import time
import sys
import json
import shutil


header = {"appId": "health_check", "token": "", "requestId": "80088208820",
          "requestTime": "2021-03-16 23:15:00"}

def get_base64(img_path):
    with open(img_path, 'rb') as img_obj:
        base64_data = base64.b64encode(img_obj.read())
    base64_str = str(base64_data, 'utf-8')
    return base64_str

def check_health(path):
    url = 'http://0.0.0.0:5000/post'
   
    base64_str = get_base64(path)
    request_data = json.dumps({"image": base64_str})
    print(type(request_data))
    start = time.time()
    response = requests.post(url=url, data=request_data ,headers=header)
    end = time.time()
    time_cost = end - start
    result = response.text.encode().decode("unicode_escape")

    print(time_cost)
    print(result)

    return response.text



if __name__ == '__main__':
    b = './test_imgs/img2.jpg'
    print(check_health(b))
```

### æˆæƒä¹¦æ£€æµ‹éƒ¨ç½²åä¸ºæ˜‡è…¾è®¡ç®—å¹³å°ï¼š2023.8.14~2023.9.04

ç°åœ¨è¦æ±‚ï¼Œå°†ä¹‹å‰æ£€æµ‹çš„æœåŠ¡æ˜¯åœ¨æœ‰NVIDIAçš„ç”Ÿäº§å¹³å°ä¸Šåšåœ¨çº¿æ¨ç†ï¼Œæ–°çš„éœ€æ±‚æ˜¯åšåœ¨åä¸ºçš„æ˜‡è…¾è®¡ç®—å¹³å°ï¼ˆæ˜‡è…¾910ï¼‰ä¸Šåšåœ¨çº¿æ¨ç†æˆ–è€…ç¦»çº¿æ¨ç†ã€‚

> åœ¨çº¿æ¨ç†å’Œç¦»çº¿æ¨ç†æœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Ÿ

* 1. åœ¨çº¿æ¨ç†ä¾èµ–äºç½‘ç»œæ¡†æ¶ï¼Œè¿™ç§ç½‘ç»œæ¡†æ¶æ˜¯åŒ…å«è®­ç»ƒå’Œæ¨ç†çš„ç½‘ç»œæ¡†æ¶ï¼Œè€Œç¦»çº¿æ¨ç†æœ‰ä¸“é—¨çš„å®šåˆ¶æ¨ç†æ¡†æ¶ã€‚
* 2. åœ¨çº¿æ¨ç†æ²¡æœ‰é’ˆå¯¹ç‰¹å®šçš„ç¡¬ä»¶åšä¼˜åŒ–ï¼Œä¹Ÿæ²¡æœ‰ç»è¿‡ç²¾åº¦çš„è°ƒä¼˜ã€‚è€Œç¦»çº¿æ¨ç†ç‰¹åˆ«è®²ç©¶æ€§èƒ½å’Œæ—¶é—´é•¿çŸ­çš„å¹³è¡¡ï¼Œç»å¸¸éœ€è¦é‡åŒ–ï¼Œæˆ–è€…å…¶ä»–åŠ é€Ÿæ‰‹æ®µã€‚

**ç”±äºYOLOv8é›†æˆäº†APIï¼Œç›´æ¥ä¸‹è½½äº†ultralyticsåŒ…å°±å¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚è€Œè¦åœ¨æ˜‡è…¾å¹³å°ä¸Šè¿è¡Œï¼Œå¿…é¡»ä½¿ç”¨æ˜‡è…¾æ”¯æŒçš„æ¨¡å‹æ ¼å¼ï¼Œè€Œæ¨¡å‹æœ¬èº«ä¸åŒ…å«å‰å¤„ç†å’Œåå¤„ç†ï¼Œæ‰€ä»¥é¦–å…ˆè¦äº†è§£å®˜æ–¹å¯¹YOLOv8æ¨ç†çš„å…¨è¿‡ç¨‹ã€‚**

#### YOLOv8æ¨ç†å…¨è¿‡ç¨‹

> å‰å¤„ç†

yolov8é¢„è®¾çš„å›¾ç‰‡è¾“å…¥æ˜¯640x640å¤§å°çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å°†ä¸€èˆ¬å¤§å°çš„å›¾åƒresizeæˆæ ‡å‡†å¤§å°ï¼Œä½†æ˜¯å•çº¯çš„åªæ˜¯ç”¨resizeæ¥æ“ä½œçš„è¯æœ‰å¯èƒ½ä¼šé€ æˆå›¾åƒçš„å¤±çœŸï¼Œæ‰€ä»¥ä½¿ç”¨äº†letterboxç¼©æ”¾ã€‚

å…·ä½“çš„è¿‡ç¨‹ï¼šå°†åŸå›¾æŒ‰æ¯”ä¾‹resizeæˆ640å¤§å°ï¼Œä¸è¶³640å¤§å°çš„å®½æˆ–è€…é«˜ä½¿ç”¨ç°æ¡è¿›è¡Œå¡«å……ã€‚

å‰å¤„ç†çš„Pythonä»£ç ï¼š

```python
def resize_image(image, size, letterbox_image):
    """
        å¯¹è¾“å…¥å›¾åƒè¿›è¡Œresize
    Args:
        size:ç›®æ ‡å°ºå¯¸
        letterbox_image: bool æ˜¯å¦è¿›è¡Œletterboxå˜æ¢
    Returns:æŒ‡å®šå°ºå¯¸çš„å›¾åƒ
    """
    from PIL import Image
    ih, iw, _ = image.shape
    h, w = size
    if letterbox_image:
        scale = min(w/iw, h/ih)
        nw = int(iw*scale)
        nh = int(ih*scale)
        image = cv2.resize(image, (nw, nh), interpolation=cv2.INTER_LINEAR)
        # ç”Ÿæˆç”»å¸ƒ
        image_back = np.ones((h, w, 3), dtype=np.uint8) * 128
        # å°†imageæ”¾åœ¨ç”»å¸ƒä¸­å¿ƒåŒºåŸŸ-letterbox
        image_back[(h-nh)//2: (h-nh)//2 + nh, (w-nw)//2:(w-nw)//2+nw, :] = image
    else:
        image_back = image
    return image_back  # è¿”å›å›¾åƒå’Œåæ ‡åŸç‚¹
```

ç°åœ¨æˆ‘ä»¬å¾—åˆ°äº†ï¼ˆ640$\times$640$\times$3ï¼‰å¤§å°çš„å›¾ç‰‡ï¼Œæ¨¡å‹è¾“å…¥ä¸ºï¼ˆNï¼ŒCï¼ŒHï¼ŒWï¼‰ï¼Œæˆ‘ä»¬éœ€è¦å¯¹å…¶è¿›è¡Œé¢„å¤„ç†æ“ä½œ

> é¢„å¤„ç†

é¢„å¤„ç†å™¨æ“ä½œçš„Pythonä»£ç ï¼š

```python
def img2input(img):
    img = cv2.cvtColor(img, cv.COLOR_BGR2RGB) # BGRè½¬RGB
    img = np.transpose(img, (2, 0, 1))
    img = img/255 # å½’ä¸€åŒ–åƒç´ å€¼
    return np.expand_dims(img, axis=0).astype(np.float32)  # (1,3,640,640)
```

> ONNXRuntimeæ¨ç†

è™½ç„¶ï¼Œæˆ‘ä»¬æœ€åä½¿ç”¨çš„æ˜¯`.om`ç¦»çº¿æ¨¡å‹ä½œæ¨ç†ï¼Œä½†é¦–å…ˆè¦äº†è§£æ•´ä¸ªæ¨ç†è¿‡ç¨‹ï¼Œè¿™é‡Œå°±ä½¿ç”¨ä¾èµ–è¾ƒå°‘çš„ONNXæ¨¡å‹ä½œæ¨ç†ã€‚

æ¨ç†çš„Pythonä»£ç ï¼š

```python
sess = rt.InferenceSession('runs/detect/train49/weights/best.onnx')
input_name = sess.get_inputs()[0].name
label_name = sess.get_outputs()[0].name
pred = sess.run([label_name], {input_name: data})[0]  
# è‡ªå·±çš„æ¨¡å‹ä½¿ç”¨yolov8å¾®è°ƒï¼Œæœ€ååˆ†ç±»çš„ç±»åˆ«æ•°ä¸º7
# (bs, 11=7cls+4reg, 8400=3ç§å°ºåº¦çš„ç‰¹å¾å›¾å åŠ )ï¼Œ è¿™é‡Œçš„é¢„æµ‹æ¡†çš„å›å½’å‚æ•°æ˜¯xywhï¼Œè€Œä¸æ˜¯ä¸­å¿ƒç‚¹åˆ°æ¡†è¾¹ç•Œçš„è·ç¦»
```

æ¨¡å‹å¾—åˆ°çš„è¾“å‡ºæ ¼å¼ä¸ºï¼ˆ1$\times$11$\times$8400ï¼‰ï¼Œ11=è¾¹ç•Œæ¡†é¢„æµ‹å€¼ 4+æ•°æ®é›†ç±»åˆ« 7ï¼Œ yolov8ä¸å¦å¤–å¯¹ç½®ä¿¡åº¦é¢„æµ‹ï¼Œ è€Œæ˜¯é‡‡ç”¨ç±»åˆ«é‡Œé¢æœ€å¤§çš„æ¦‚ç‡ä½œä¸ºç½®ä¿¡åº¦scoreï¼Œ8400æ˜¯v8æ¨¡å‹å„å°ºåº¦è¾“å‡ºç‰¹å¾å›¾å åŠ ä¹‹åçš„ç»“æœï¼ˆå…·ä½“å¦‚ä½•å åŠ å¯ä»¥çœ‹æºç ï¼Œä¸€èˆ¬æ¨ç†ä¸éœ€è¦ç®¡ï¼‰ã€‚æœ¬æ–‡å¯¹æ¨¡å‹çš„è¾“å‡ºè¿›è¡Œå¦‚ä¸‹æ“ä½œï¼Œæ–¹ä¾¿åå¤„ç†ï¼š

```python
def std_output(pred):
    """
    å°†æ¨¡å‹çš„é¢„æµ‹ç»“æœä¸­çš„æœ€åå››ä¸ªå…ƒç´ æå–å‡ºæ¥ï¼Œå¹¶è®¡ç®—å®ƒä»¬çš„æœ€å¤§å€¼ï¼Œç„¶åå°†è¿™ä¸ªæœ€å¤§å€¼æ’å…¥åˆ°åŸå§‹é¢„æµ‹ç»“æœçš„å€’æ•°ç¬¬å››ä¸ªä½			ç½®ã€‚è¿™æ ·åšçš„ç›®çš„å¯èƒ½æ˜¯ä¸ºäº†åœ¨åå¤„ç†é˜¶æ®µä¸ºæ¯ä¸ªæ ·æœ¬æ·»åŠ ä¸€ä¸ªç½®ä¿¡åº¦å¾—åˆ†ï¼Œä»¥æä¾›å…³äºé¢„æµ‹ç»“æœçš„å¯é æ€§çš„ä¿¡æ¯ã€‚
    å°†ï¼ˆ1ï¼Œ11ï¼Œ8400ï¼‰å¤„ç†æˆï¼ˆ8400ï¼Œ 12ï¼‰  12= box:4  conf:1 cls:7
    """
    pred = np.squeeze(pred)  # å› ä¸ºåªæ˜¯æ¨ç†ï¼Œæ‰€ä»¥æ²¡æœ‰Batch
    pred = np.transpose(pred, (1, 0)) # å¤„ç†æˆï¼ˆ8400ï¼Œ11ï¼‰
    pred_class = pred[..., 4:] # å°†ç»´åº¦2çš„ç¬¬5ä¸ªå¼€å§‹çš„æ‰€æœ‰å€¼å–åˆ°
    pred_conf = np.max(pred_class, axis=-1) # åšä¸€æ¬¡å–æœ€å¤§
    pred = np.insert(pred, 4, pred_conf, axis=-1) # ç„¶åæ’å…¥åˆ°åŸæ¥ç´¢å¼•ä¸º4çš„ä½ç½®
    return pred  #ï¼ˆ8400ï¼Œ12ï¼‰
```

å¾—åˆ°è¾“å‡ºï¼ˆ8400ï¼Œ12ï¼‰ã€‚8400ä¸ªç‰¹å¾å›¾çš„cellï¼Œæ¯ä¸ªcellé‡Œé¢æœ‰4+1+7çš„è¾“å‡ºå€¼ï¼Œå¯¹åº”4ä¸ªé¢„æµ‹æ¡†+1ä¸ªç½®ä¿¡åº¦ï¼ˆæœ€å¤§ç±»åˆ«æ¦‚ç‡ï¼‰+7ç±»åˆ«æ¦‚ç‡ã€‚

> åå¤„ç†ï¼šç½®ä¿¡åº¦è¿‡æ»¤+NMSéæå¤§æŠ‘åˆ¶

æ¥ä¸‹æ¥å°±å¯¹åˆšåˆšçš„ï¼ˆ8400ï¼Œ12ï¼‰è¿›è¡Œåå¤„ç†ï¼Œå…ˆè¿›è¡Œç½®ä¿¡åº¦è¿‡æ»¤ï¼Œå†è¿›è¡ŒNMSéæå¤§å€¼æŠ‘åˆ¶ï¼Œæœ¬æ–‡å°†è¿™ä¸¤æ­¥ç­›é€‰æ“ä½œæ”¾åœ¨äº†ä¸€ä¸ªå‡½æ•°ä¸­ï¼š

```python
def nms(pred, conf_thres, iou_thres):
    """
    éæå¤§å€¼æŠ‘åˆ¶nms
    Args:
        pred: æ¨¡å‹è¾“å‡ºç‰¹å¾å›¾
        conf_thres: ç½®ä¿¡åº¦é˜ˆå€¼
        iou_thres: ioué˜ˆå€¼
    Returns: è¾“å‡ºåçš„ç»“æœ
    """
    box = pred[pred[..., 4] > conf_thres]  # ç½®ä¿¡åº¦ç­›é€‰
    cls_conf = box[..., 5:]
    cls = []
    for i in range(len(cls_conf)):
        cls.append(int(np.argmax(cls_conf[i])))
 
    total_cls = list(set(cls))  # è®°å½•å›¾åƒå†…å…±å‡ºç°å‡ ç§ç‰©ä½“
    output_box = []
    # æ¯ä¸ªé¢„æµ‹ç±»åˆ«åˆ†å¼€è€ƒè™‘
    for i in range(len(total_cls)):
        clss = total_cls[i]
        cls_box = []
        temp = box[:, :6]
        for j in range(len(cls)):
            # è®°å½•[x,y,w,h,conf(æœ€å¤§ç±»åˆ«æ¦‚ç‡),class]å€¼
            if cls[j] == clss:
                temp[j][5] = clss
                cls_box.append(temp[j][:6])
        #  cls_box é‡Œé¢æ˜¯[x,y,w,h,conf(æœ€å¤§ç±»åˆ«æ¦‚ç‡),class]
        cls_box = np.array(cls_box)
        sort_cls_box = sorted(cls_box, key=lambda x: -x[4])  # å°†cls_boxæŒ‰ç½®ä¿¡åº¦ä»å¤§åˆ°å°æ’åº
        # box_conf_sort = np.argsort(-box_conf)
        # å¾—åˆ°ç½®ä¿¡åº¦æœ€å¤§çš„é¢„æµ‹æ¡†
        max_conf_box = sort_cls_box[0]
        output_box.append(max_conf_box)
        sort_cls_box = np.delete(sort_cls_box, 0, 0)
        # å¯¹é™¤max_conf_boxå¤–å…¶ä»–çš„æ¡†è¿›è¡Œéæå¤§å€¼æŠ‘åˆ¶
        while len(sort_cls_box) > 0:
            # å¾—åˆ°å½“å‰æœ€å¤§çš„æ¡†
            max_conf_box = output_box[-1]
            del_index = []
            for j in range(len(sort_cls_box)):
                current_box = sort_cls_box[j]
                iou = get_iou(max_conf_box, current_box)
                if iou > iou_thres:
                    # ç­›é€‰å‡ºä¸å½“å‰æœ€å¤§æ¡†Iouå¤§äºé˜ˆå€¼çš„æ¡†çš„ç´¢å¼•
                    del_index.append(j)
            # åˆ é™¤è¿™äº›ç´¢å¼•
            sort_cls_box = np.delete(sort_cls_box, del_index, 0)
            if len(sort_cls_box) > 0:
                # æˆ‘è®¤ä¸ºè¿™é‡Œéœ€è¦å°†clas_boxå…ˆæŒ‰ç½®ä¿¡åº¦æ’åºï¼Œ æ‰èƒ½æ¯æ¬¡å–ç¬¬ä¸€ä¸ª
                output_box.append(sort_cls_box[0])
                sort_cls_box = np.delete(sort_cls_box, 0, 0)
    return output_box
 
 
def xywh2xyxy(*box):
    """
    å°†xywhè½¬æ¢ä¸ºå·¦ä¸Šè§’ç‚¹å’Œå·¦ä¸‹è§’ç‚¹
    Args:
        box:
    Returns: x1y1x2y2
    """
    ret = [box[0] - box[2] // 2, box[1] - box[3] // 2, \
          box[0] + box[2] // 2, box[1] + box[3] // 2]
    return ret
 
def get_inter(box1, box2):
    """
    è®¡ç®—ç›¸äº¤éƒ¨åˆ†é¢ç§¯
    Args:
        box1: ç¬¬ä¸€ä¸ªæ¡†
        box2: ç¬¬äºŒä¸ªç‹‚
    Returns: ç›¸äº¤éƒ¨åˆ†çš„é¢ç§¯
    """
    x1, y1, x2, y2 = xywh2xyxy(*box1)
    x3, y3, x4, y4 = xywh2xyxy(*box2)
    # éªŒè¯æ˜¯å¦å­˜åœ¨äº¤é›†
    if x1 >= x4 or x2 <= x3:
        return 0
    if y1 >= y4 or y2 <= y3:
        return 0
    # å°†x1,x2,x3,x4æ’åºï¼Œå› ä¸ºå·²ç»éªŒè¯äº†ä¸¤ä¸ªæ¡†ç›¸äº¤ï¼Œæ‰€ä»¥x3-x2å°±æ˜¯äº¤é›†çš„å®½
    x_list = sorted([x1, x2, x3, x4])
    x_inter = x_list[2] - x_list[1]
    # å°†y1,y2,y3,y4æ’åºï¼Œå› ä¸ºå·²ç»éªŒè¯äº†ä¸¤ä¸ªæ¡†ç›¸äº¤ï¼Œæ‰€ä»¥y3-y2å°±æ˜¯äº¤é›†çš„å®½
    y_list = sorted([y1, y2, y3, y4])
    y_inter = y_list[2] - y_list[1]
    # è®¡ç®—äº¤é›†çš„é¢ç§¯
    inter = x_inter * y_inter
    return inter
 
def get_iou(box1, box2):
    """
    è®¡ç®—äº¤å¹¶æ¯”ï¼š (A n B)/(A + B - A n B)
    Args:
        box1: ç¬¬ä¸€ä¸ªæ¡†
        box2: ç¬¬äºŒä¸ªæ¡†
    Returns:  # è¿”å›äº¤å¹¶æ¯”çš„å€¼
    """
    box1_area = box1[2] * box1[3]  # è®¡ç®—ç¬¬ä¸€ä¸ªæ¡†çš„é¢ç§¯
    box2_area = box2[2] * box2[3]  # è®¡ç®—ç¬¬äºŒä¸ªæ¡†çš„é¢ç§¯
    inter_area = get_inter(box1, box2)
    union = box1_area + box2_area - inter_area   #(A n B)/(A + B - A n B)
    iou = inter_area / union
    return iou
```

ç­›é€‰å®Œä¹‹åå¾—åˆ°çš„è¾“å‡ºoutput_boxæ ¼å¼ä¸ºN * [x,y,w,h,conf(æœ€å¤§ç±»åˆ«æ¦‚ç‡),class] ï¼Œ Næ˜¯ç­›é€‰åé¢„æµ‹æ¡†çš„ä¸ªæ•°ï¼Œ é€šè¿‡[x,y,w,h,conf(æœ€å¤§ç±»åˆ«æ¦‚ç‡),class]è¿™äº›æ•°æ®æˆ‘ä»¬å°±å¯ä»¥å°†é¢„æµ‹æ¡†è¾“å‡ºç»˜åˆ¶åœ¨åŸå›¾åƒä¸Šï¼Œ ä½†æ˜¯è¦æ³¨æ„ï¼Œæˆ‘ä»¬æ­¤æ—¶æ¨¡å‹çš„è¾“å…¥æ˜¯ç»è¿‡letterboxå¤„ç†çš„ï¼Œæ‰€ä»¥éœ€è¦å…ˆå°†é¢„æµ‹æ¡†çš„åæ ‡è½¬æ¢å›åŸåæ ‡ç³»çš„åæ ‡:

```python
def cod_trf(result, pre, after):
    """
    å› ä¸ºé¢„æµ‹æ¡†æ˜¯åœ¨ç»è¿‡letterboxåçš„å›¾åƒä¸Šåšé¢„æµ‹æ‰€ä»¥éœ€è¦å°†é¢„æµ‹æ¡†çš„åæ ‡æ˜ å°„å›åŸå›¾åƒä¸Š
    Args:
        result:  [x,y,w,h,conf(æœ€å¤§ç±»åˆ«æ¦‚ç‡),class]
        pre:    åŸå°ºå¯¸å›¾åƒ
        after:  ç»è¿‡letterboxå¤„ç†åçš„å›¾åƒ
    Returns: åæ ‡å˜æ¢åçš„ç»“æœ,å¹¶å°†xywhè½¬æ¢ä¸ºå·¦ä¸Šè§’å³ä¸‹è§’åæ ‡x1y1x2y2
    """
    res = np.array(result)
    x, y, w, h, conf, cls = res.transpose((1, 0)) # (12, 8400)
    x1, y1, x2, y2 = xywh2xyxy(x, y, w, h)  # å·¦ä¸Šè§’ç‚¹å’Œå³ä¸‹è§’çš„ç‚¹
    h_pre, w_pre, _ = pre.shape
    h_after, w_after, _ = after.shape
    scale = max(w_pre/w_after, h_pre/h_after)  # ç¼©æ”¾æ¯”ä¾‹
    h_pre, w_pre = h_pre/scale, w_pre/scale  # è®¡ç®—åŸå›¾åœ¨ç­‰æ¯”ä¾‹ç¼©æ”¾åçš„å°ºå¯¸
    x_move, y_move = abs(w_pre-w_after)//2, abs(h_pre-h_after)//2  # è®¡ç®—å¹³ç§»çš„é‡
    ret_x1, ret_x2 = (x1 - x_move) * scale, (x2 - x_move) * scale
    ret_y1, ret_y2 = (y1 - y_move) * scale, (y2 - y_move) * scale
    ret = np.array([ret_x1, ret_y1, ret_x2, ret_y2, conf, cls]).transpose((1, 0))
    return ret  # x1y1x2y2
```

> ç»˜åˆ¶é¢„æµ‹æ¡†

è¾“å‡ºçš„retçš„æ ¼å¼ä¸ºN * [x1,y1,x2,y2,conf(æœ€å¤§ç±»åˆ«æ¦‚ç‡),class]ï¼Œæ¥ä¸‹æ¥å°±å¯ä»¥è¿›è¡Œæœ€åä¸€æ­¥æ“ä½œäº†ï¼Œå¯¹é¢„æµ‹æ¡†è¿›è¡Œç»˜åˆ¶ï¼Œä½†æ˜¯ä¸ºäº†ç¾è§‚éœ€è¦æ³¨æ„å°†å­—ä½“å¤§å°éšç€é¢„æµ‹æ¡†çš„å¤§å°è¿›è¡ŒåŠ¨æ€è°ƒæ•´ï¼Œä»¥åŠå­—ä½“æ˜¾ç¤ºä¸èƒ½è¶…è¿‡è¾¹ç•Œã€‚

```python
def draw(res, image, cls):
    """
    å°†é¢„æµ‹æ¡†ç»˜åˆ¶åœ¨imageä¸Š
    Args:
        res: é¢„æµ‹æ¡†æ•°æ®
        image: åŸå›¾
        cls: ç±»åˆ«åˆ—è¡¨ï¼Œç±»ä¼¼["apple", "banana", "people"]  å¯ä»¥è‡ªå·±è®¾è®¡æˆ–è€…é€šè¿‡æ•°æ®é›†çš„yamlæ–‡ä»¶è·å–
    Returns:
    """
    for r in res:
        # ç”»æ¡†
        image = cv2.rectangle(image, (int(r[0]), int(r[1])), (int(r[2]), int(r[3])), (255, 0, 0), 1)
        # è¡¨æ˜ç±»åˆ«
        text = "{}:{}".format(cls[int(r[5])], \
                               round(float(r[4]), 2))
        h, w = int(r[3]) - int(r[1]), int(r[2]) - int(r[0])  # è®¡ç®—é¢„æµ‹æ¡†çš„é•¿å®½
        font_size = min(h/640, w/640) * 3  # è®¡ç®—å­—ä½“å¤§å°ï¼ˆéšæ¡†å¤§å°è°ƒæ•´ï¼‰
        image = cv2.putText(image, text, (max(10, int(r[0])), max(20, int(r[1]))), cv2.FONT_HERSHEY_COMPLEX, max(font_size, 0.3), (0, 0, 255), 1)   # max()ä¸ºäº†ç¡®ä¿å­—ä½“ä¸è¿‡ç•Œ
    cv2.imshow("result", image)
    cv2.waitKey()
    cv2.destroyWindow("result")
```

#### YOLOv8å¯¼å‡ºONNXæ¨¡å‹

é¦–å…ˆåœ¨æœåŠ¡å™¨ä¸Šè¿›è¡Œå¯¼å‡ºï¼Œéµä»å®˜æ–¹çš„demoï¼Œå†™pythonè„šæœ¬`export.py`ï¼š

```python
from ultralytics import YOLO

# load a model
model = YOLO('runs/detect/train/weights/best.pt')

# export the model 
model.export(format='onnx', half=False, simplify=True, opset=11)
# model.export(format='onnx', half=True, simplify=True, opset=11)
```

æœ¬æ¥è®¤ä¸ºè¿™æ˜¯æœ€ç®€å•çš„æ­¥éª¤äº†ï¼Œç»“æœæŠ¥é”™äº†ã€‚æŠ¥é”™åŸå› :

```shell
$ RuntimeError: Exporting the operator silu to ONNX opset version 11 is not supported.
```

ç½‘ä¸Šè¯´çš„æ–¹æ³•éƒ½æ˜¯ä¿®æ”¹è™šæ‹Ÿç¯å¢ƒä¸­torchçš„æºç çš„SiLUçš„å®ç°ï¼Œç»“æœæˆ‘æ‰¾åˆ°æœåŠ¡å™¨çš„æºç æ–‡ä»¶ï¼Œç«Ÿç„¶æ²¡æœ‰è¿™ä¸ªå‡½æ•°ã€‚

**é€šè¿‡ultralyticsæŸ¥çœ‹ç‰ˆæœ¬ä¿¡æ¯**ï¼š

```shell
$ python
# è¿›å…¥pythonå‘½åç©ºé—´
$ import ultralytics
$ ultralytics.checks()
$ Ultralytics YOLOv8.0.145 ğŸš€ Python-3.7.7 torch-1.7.1+cu101 CUDA:0 (Tesla T4, 15110MiB)
Setup complete âœ… (40 CPUs, 62.4 GB RAM, 1559.7/1697.2 GB disk)
```

æ€€ç–‘pytorchç‰ˆæœ¬è¿‡ä½ï¼Œæœæ–­ä¸‹è½½ultralyticså®˜æ–¹æä¾›çš„æœ€æ–°dockeré•œåƒï¼Œå¯åŠ¨äº†ä¹‹åï¼Œå†æ¬¡è¿è¡Œä¸Šè¿°å‘½ä»¤ï¼Œå¾—åˆ°ä¿¡æ¯ï¼š

```
$ Ultralytics YOLOv8.0.154 ğŸš€ Python-3.10.11 torch-2.0.1 CUDA:0 (Tesla T4, 15110MiB)
Setup complete âœ… (40 CPUs, 62.4 GB RAM, 1559.7/1697.2 GB disk)
```

å¯ä»¥çœ‹åˆ°æˆ‘ä»¬çš„pytorchç‰ˆæœ¬å·²ç»å˜ä¸ºäº†2.0.1ï¼Œç»§ç»­æ‰§è¡Œ`export.py`ï¼Œå‘ç°å·²ç»æ‰§è¡ŒæˆåŠŸäº†ï¼Œåˆ†åˆ«å¯¼å‡ºäº†`fp32`å’Œ`fp16`çš„æ¨¡å‹ï¼Œåˆ†åˆ«æ˜¯`98.76M`å’Œ`49.41M`ã€‚

#### FTPæ–‡ä»¶ä¼ è¾“

* FTPè¿æ¥å‘½ä»¤ï¼š

```shell
ftp <ipåœ°å€>
```

ç„¶åè¾“å…¥ç”¨æˆ·åå’Œå¯†ç 

æŸ¥çœ‹æ–‡ä»¶ä½¿ç”¨`ls`ï¼Œåˆ°è¾¾æŒ‡å®šç›®å½•ç”¨`cd`

* ä½¿ç”¨FTPä¸‹è½½æ–‡ä»¶ï¼š

é¦–å…ˆè®¾å®šæœ¬åœ°æ¥æ”¶æ–‡ä»¶çš„ç›®å½•ä½ç½®

```shell
lcd /home/user/yourdirectoryname
```

å¦‚æœä½ ä¸æŒ‡å®šä¸‹è½½ç›®å½•ï¼Œæ–‡ä»¶å°†ä¼šä¸‹è½½åˆ°ä½ ç™»å½• FTP æ—¶å€™çš„å·¥ä½œç›®å½•ã€‚

ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å‘½ä»¤ get æ¥ä¸‹è½½æ–‡ä»¶ï¼Œæ¯”å¦‚ï¼š

```shell
get file
```

ä¸‹è½½å¤šä¸ªæ–‡ä»¶å¯ä»¥ä½¿ç”¨é€šé…ç¬¦åŠ` mget` å‘½ä»¤ã€‚ä¾‹å¦‚ï¼Œä¸‹é¢è¿™ä¸ªä¾‹å­æˆ‘æ‰“ç®—ä¸‹è½½æ‰€æœ‰ä»¥ .xls ç»“å°¾çš„æ–‡ä»¶ã€‚

```shell
mget *.xls
```

* ä½¿ç”¨FTPä¸Šä¼ æ–‡ä»¶

ä½¿ç”¨`put`å‘½ä»¤ä¸Šä¼ æ–‡ä»¶ï¼š

```shell
put file
```

å½“æ–‡ä»¶ä¸å†å½“å‰æœ¬åœ°ç›®å½•ä¸‹çš„æ—¶å€™ï¼Œå¯ä»¥ä½¿ç”¨ç»å¯¹è·¯å¾„ï¼š

```shell
put /path/file
```

åŒæ ·ï¼Œå¯ä»¥ä¸Šä¼ å¤šä¸ªæ–‡ä»¶ï¼š

```shell
mput *.xls
```

* å…³é—­FTPè¿æ¥

```shell
# ä¸‰é€‰ä¸€
bye
exit
quit 
```

#### omæ¨¡å‹æ¨ç†è¿‡ç¨‹

é¡¹ç›®ç›®å‰å‡†å¤‡å…ˆä½¿ç”¨Pythonå®Œæˆå…¨è¿‡ç¨‹ï¼Œæ‰€ä»¥æˆ‘ä»¬ä½¿ç”¨`AscendCL`æä¾›çš„`PyACL`APIæ¥å†™ä¸€ä¸‹æ¨¡å‹æ¨ç†çš„è¿‡ç¨‹ï¼Œå‰åå¤„ç†ä¸ONNXä¿æŒä¸€è‡´:

```python
##
##
##  Created by caixj in 2023-08-24
## 
##
import acl
import os
import numpy as np
import cv2


# error code
ACL_SUCCESS = 0

# rule for mem
ACL_MEM_MALLOC_HUGE_FIRST = 0
ACL_MEM_MALLOC_HUGE_ONLY = 1
ACL_MEM_MALLOC_NORMAL_ONLY = 2

# rule for memory copy
ACL_MEMCPY_HOST_TO_HOST = 0
ACL_MEMCPY_HOST_TO_DEVICE = 1
ACL_MEMCPY_DEVICE_TO_HOST = 2
ACL_MEMCPY_DEVICE_TO_DEVICE = 3

# numpy data type
NPY_FLOAT32 = 11




buffer_method = {
    "in": acl.mdl.get_input_size_by_index,
    "out": acl.mdl.get_output_size_by_index
    }


def check_ret(message, ret):
    if ret != ACL_SUCCESS:
        raise Exception("{} failed ret={}"
                        .format(message, ret))


class Net(object):
    def __init__(self, device_id, model_path):
        self.device_id = device_id      # int
        self.model_path = model_path    # string
        self.model_id = None            # pointer
        self.context = None             # pointer

        self.input_data = []
        self.output_data = []
        self.model_desc = None          # pointer when using
        self.load_input_dataset = None
        self.load_output_dataset = None

        self.init_resource()

    def release_resource(self):
        print("Releasing resources stage:")
        ret = acl.mdl.unload(self.model_id)
        check_ret("acl.mdl.unload", ret)
        if self.model_desc:
            acl.mdl.destroy_desc(self.model_desc)
            self.model_desc = None

        while self.input_data:
            item = self.input_data.pop()
            ret = acl.rt.free(item["buffer"])
            check_ret("acl.rt.free", ret)

        while self.output_data:
            item = self.output_data.pop()
            ret = acl.rt.free(item["buffer"])
            check_ret("acl.rt.free", ret)

        if self.context:
            ret = acl.rt.destroy_context(self.context)
            check_ret("acl.rt.destroy_context", ret)
            self.context = None

        ret = acl.rt.reset_device(self.device_id)
        check_ret("acl.rt.reset_device", ret)
        ret = acl.finalize()
        check_ret("acl.finalize", ret)
        print('Resources released successfully.')

    def init_resource(self):
        # aclåˆå§‹åŒ–
        print("init resource stage:")
        ret = acl.init()
        check_ret("acl.init", ret)
        # åˆ†é…è®¾å¤‡å†…å­˜
        ret = acl.rt.set_device(self.device_id)
        check_ret("acl.rt.set_device", ret)
        # åˆ›å»ºä¸Šä¸‹æ–‡
        self.context, ret = acl.rt.create_context(self.device_id)
        check_ret("acl.rt.create_context", ret)

        # åŠ è½½æ¨¡å‹
        self.model_id, ret = acl.mdl.load_from_file(self.model_path)
        check_ret("acl.mdl.load_from_file", ret)
        print("model_id:{}".format(self.model_id))
        # ä¸ºæ¨¡å‹åˆ†é…desc
        self.model_desc = acl.mdl.create_desc()
        # è·å–æ¨¡å‹ä¿¡æ¯
        self._get_model_info()
        print("init resource success")

    def _get_model_info(self,):
        ret = acl.mdl.get_desc(self.model_desc, self.model_id)
        check_ret("acl.mdl.get_desc", ret)
        input_size = acl.mdl.get_num_inputs(self.model_desc)
        output_size = acl.mdl.get_num_outputs(self.model_desc)
        self._gen_data_buffer(input_size, des="in")
        self._gen_data_buffer(output_size, des="out")

    def _gen_data_buffer(self, size, des):
        func = buffer_method[des]
        for i in range(size):
            # check temp_buffer dtype
            temp_buffer_size = func(self.model_desc, i)
            temp_buffer, ret = acl.rt.malloc(temp_buffer_size,
                                             ACL_MEM_MALLOC_HUGE_FIRST)
            check_ret("acl.rt.malloc", ret)

            if des == "in":
                self.input_data.append({"buffer": temp_buffer,
                                        "size": temp_buffer_size})
            elif des == "out":
                self.output_data.append({"buffer": temp_buffer,
                                         "size": temp_buffer_size})

    def _data_interaction(self, dataset, policy=ACL_MEMCPY_HOST_TO_DEVICE):
        temp_data_buffer = self.input_data \
            if policy == ACL_MEMCPY_HOST_TO_DEVICE \
            else self.output_data
        if len(dataset) == 0 and policy == ACL_MEMCPY_DEVICE_TO_HOST:
            for item in self.output_data:
                temp, ret = acl.rt.malloc_host(item["size"])
                if ret != 0:
                    raise Exception("can't malloc_host ret={}".format(ret))
                dataset.append({"size": item["size"], "buffer": temp})

        for i, item in enumerate(temp_data_buffer):
            if policy == ACL_MEMCPY_HOST_TO_DEVICE:
                if "bytes_to_ptr" in dir(acl.util):
                    bytes_data = dataset[i].tobytes()
                    ptr = acl.util.bytes_to_ptr(bytes_data)
                else: 
                    ptr = acl.util.numpy_to_ptr(dataset[i])
                ret = acl.rt.memcpy(item["buffer"],
                                    item["size"],
                                    ptr,
                                    item["size"],
                                    policy)
                check_ret("acl.rt.memcpy", ret)

            else:
                ptr = dataset[i]["buffer"]
                ret = acl.rt.memcpy(ptr,
                                    item["size"],
                                    item["buffer"],
                                    item["size"],
                                    policy)
                check_ret("acl.rt.memcpy", ret)

    def _gen_dataset(self, type_str="input"):
        dataset = acl.mdl.create_dataset()

        temp_dataset = None
        if type_str == "in":
            self.load_input_dataset = dataset
            temp_dataset = self.input_data
        else:
            self.load_output_dataset = dataset
            temp_dataset = self.output_data

        for item in temp_dataset:
            data = acl.create_data_buffer(item["buffer"], item["size"])
            _, ret = acl.mdl.add_dataset_buffer(dataset, data)

            if ret != ACL_SUCCESS:
                ret = acl.destroy_data_buffer(data)
                check_ret("acl.destroy_data_buffer", ret)

    def _data_from_host_to_device(self, images):
        print("data interaction from host to device")
        # copy images to device
        self._data_interaction(images, ACL_MEMCPY_HOST_TO_DEVICE)
        # load input data into model
        self._gen_dataset("in")
        # load output data into model
        self._gen_dataset("out")
        print("data interaction from host to device success")

    def _data_from_device_to_host(self):
        print("data interaction from device to host")
        res = []
        # copy device to host
        self._data_interaction(res, ACL_MEMCPY_DEVICE_TO_HOST)
        print("data interaction from device to host success")
        result = self.get_result(res)
        # free host memory
        for item in res:
            ptr = item['buffer']
            ret = acl.rt.free_host(ptr)
            check_ret('acl.rt.free_host', ret)

        return result

    def run(self, images):
        self._data_from_host_to_device(images)
        self.forward()
        res = self._data_from_device_to_host()
        return res

    def forward(self):
        print('execute stage:')
        ret = acl.mdl.execute(self.model_id,
                              self.load_input_dataset,
                              self.load_output_dataset)
        check_ret("acl.mdl.execute", ret)
        self._destroy_databuffer()
        print('execute stage success')

    def _destroy_databuffer(self):
        for dataset in [self.load_input_dataset, self.load_output_dataset]:
            if not dataset:
                continue
            number = acl.mdl.get_dataset_num_buffers(dataset)
            for i in range(number):
                data_buf = acl.mdl.get_dataset_buffer(dataset, i)
                if data_buf:
                    ret = acl.destroy_data_buffer(data_buf)
                    check_ret("acl.destroy_data_buffer", ret)
            ret = acl.mdl.destroy_dataset(dataset)
            check_ret("acl.mdl.destroy_dataset", ret)

    def get_result(self, output_data):
        result = []
        dims, ret = acl.mdl.get_cur_output_dims(self.model_desc, 0)
        check_ret("acl.mdl.get_cur_output_dims", ret)
        out_dim = dims['dims']
        for temp in output_data:
            ptr = temp["buffer"]
            # è½¬åŒ–ä¸ºfloat32ç±»å‹çš„æ•°æ®
            if "ptr_to_bytes" in dir(acl.util):
                bytes_data = acl.util.ptr_to_bytes(ptr, temp["size"])
                data = np.frombuffer(bytes_data, dtype=np.float32).reshape(tuple(out_dim))
            else:
                data = acl.util.ptr_to_numpy(ptr, tuple(out_dim), NPY_FLOAT32)
            result.append(data)
        return result
    




def apply_resource(device_id, model_path):
    """
    ç½‘ç»œæ¨¡å‹åˆå§‹åŒ–
    """
    net = Net(device_id, model_path)
    
    return net

def infer_om(net, resize_img):
    """
    å¯¹å›¾ç‰‡è¿›è¡Œæ¨ç†
    """
    
    res = net.run([resize_img])
    res = np.array(res[0])
    print("*****run finish******")
    net.release_resource()
    
    return res


```

è°ƒç”¨æ¨¡å‹è¿›è¡Œæ¨ç†ä»£ç å¦‚ä¸‹ï¼š

```python
net = apply_resource(device_id, model_path)
res = infer_om(net, data)
```

#### Flaskè°ƒç”¨çš„åä¸ºæ˜‡è…¾omæ¨¡å‹æ¨ç†çš„å‘

ç”±äºæ˜¯ä¸šåŠ¡ä»£ç ï¼Œåªèƒ½è®²ä¸ªå¤§æ¦‚ã€‚ä¸»è¦çš„å‘å°±æ˜¯æ¨¡å‹æ¨ç†æœåŠ¡éœ€è¦ä¸€æ¬¡åŠ è½½å¤šæ¬¡ä½¿ç”¨ã€‚

æ‰€ä»¥æŒ‰ç…§é€»è¾‘ï¼Œæˆ‘åœ¨å…¨å±€ä½¿ç”¨äº†`net = apply_resource(device_id, model_path)`åˆå§‹åŒ–äº†æ¨¡å‹ï¼Œç„¶ååœ¨Flaskå†…éƒ¨çš„å‡½æ•°ä½¿ç”¨`res = infer_om(net, data)`è¿›è¡Œæ¨ç†ï¼Œæ­£å¸¸æ¥è¯´æ˜¯å¯ä»¥æ­£ç¡®è¿”å›çš„ï¼Œä½†çœŸå®çš„ç»“æœæ˜¯ä¼šå¡åœ¨å°†æ•°æ®ä»`Host`æ‹·è´åˆ°`Device`ã€‚

```
é—®é¢˜ï¼šä½¿ç”¨æ­£å¸¸çš„å›¾ç‰‡åŠ è½½æ¨ç†å¯ä»¥æ­£å¸¸è¿›è¡Œï¼Œä½†ä½¿ç”¨flaskåœ¨å…¨å±€åŠ è½½æ¨¡å‹åœ¨flaskå†…éƒ¨è°ƒç”¨æ¨¡å‹è¿›è¡Œæ¨ç†ä¼šå‡ºé”™

åŸå› ï¼šé€šè¿‡å’¨è¯¢åä¸ºå®˜æ–¹åº“çš„äººå‘˜ï¼Œæ ¹æœ¬åŸå› æ˜¯åä¸ºçš„omæ¨¡å‹æ¨ç†å¿…é¡»ä½¿ç”¨deviceç”³è¯·çš„åŒä¸€å—contextï¼ˆä¸Šä¸‹æ–‡ï¼‰ã€‚

è§£å†³ï¼šåœ¨å…¨å±€è·å–æ¨ç†ä½¿ç”¨çš„contextï¼Œç„¶ååœ¨flaskå†…éƒ¨è®¾ç½®æ¨ç†ä½¿ç”¨çš„centextä¸ºåˆšåˆšè·å–çš„context

1.æ¨¡å‹åŠ è½½å‰è°ƒç”¨
context, ret = acl.rt.get_context()

2.flaskå†…éƒ¨è°ƒç”¨
ret = acl.rt.set_context(context) 

ä¿è¯æ¨¡å‹åŠ è½½å’Œæ‰§è¡Œåœ¨åŒä¸€contextå†…ã€‚
```

#### sshä¼ æ–‡ä»¶å‘½ä»¤

* ä½¿ç”¨sshä¼ æºæ–‡ä»¶ï¼š

```shell
$ scp -P <ç«¯å£å·> <æ–‡ä»¶å> <user_name>@<ip>:<ç›®æ ‡æ–‡ä»¶åœ°å€>
```

* ä½¿ç”¨sshä¼ æ–‡ä»¶å¤¹ï¼š

```shell
$ scp -P <ç«¯å£å·> -r <æ–‡ä»¶å¤¹å> <user_name>@<ip>:<ç›®æ ‡æ–‡ä»¶åœ°å€>
```




